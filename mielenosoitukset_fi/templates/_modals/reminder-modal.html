{% macro render_reminder_modal(demo) %}
<div class="modal fade" id="reminder-modal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-3">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="reminderModalLabel">
          <i class="fas fa-bell me-2 text-primary"></i> {{ _('Tilaa muistutus s√§hk√∂postiisi') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="reminder-form" method="POST"
              action="{{ url_for('subscribe_reminder', demo_id=demo['_id']) }}"
              class="d-flex flex-column gap-3">
          <input type="email" name="user_email" id="reminder-email"
                 class="form-control"
                 placeholder="{{ _('S√§hk√∂postiosoite') }}" required>
          
          <button type="submit" class="btn btn-primary w-100 d-flex justify-content-center align-items-center gap-2">
            <span class="btn-text">{{ _('Tilaa muistutus') }}</span>
            <span class="spinner-border spinner-border-sm d-none" id="reminder-loading" role="status" aria-hidden="true"></span>
          </button>
        </form>
        
        <div id="reminder-result" class="mt-3 small"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("reminder-form");
  const result = document.getElementById("reminder-result");
  const btn = form.querySelector("button");
  const btnText = btn.querySelector(".btn-text");
  const spinner = document.getElementById("reminder-loading");
  const emailInput = document.getElementById("reminder-email");
  const modalEl = document.getElementById("reminder-modal");
  const bootstrapModal = new bootstrap.Modal(modalEl);

  // üîÆ Auto-prefill from localStorage
  try {
    const userData = localStorage.getItem("current_user");
    if (userData) {
      const user = JSON.parse(userData);
      if (user.email && !emailInput.value) {
        emailInput.value = user.email;
      }
    }
  } catch(e) {
    console.warn("No valid user data in localStorage:", e);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    result.textContent = "";
    btn.disabled = true;
    spinner.classList.remove("d-none");

    const formData = new FormData(form);
    try {
      const r = await fetch(form.action, { method: "POST", body: formData });
      const data = await r.json();

      if (data.status === "OK") {
        form.reset();
        let countdown = 3;
        result.innerHTML = `<div class="alert alert-success">${data.message} (${countdown})</div>`;
        
        const interval = setInterval(() => {
          countdown--;
          result.innerHTML = `<div class="alert alert-success">${data.message} (${countdown})</div>`;
          if (countdown <= 0) {
            clearInterval(interval);
            bootstrapModal.hide();
          }
        }, 1000);
      } else {
        result.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
      }
    } catch {
      result.innerHTML = `<div class="alert alert-danger">{{ _('Virhe tilauksessa. Yrit√§ uudelleen.') }}</div>`;
    } finally {
      btn.disabled = false;
      spinner.classList.add("d-none");
    }
  });
});
</script>
{% endmacro %}
