<!-- Force Password Modal -->
<!-- Force Password Modal -->
<div class="modal fade" id="forcePwdModal" tabindex="-1" aria-labelledby="forcePwdModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="forcePwdModalLabel">
          <i class="fas fa-key me-2"></i>{{ _('Pakota salasananvaihto') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Sulje') }}"></button>
      </div>
      <div class="modal-body">
        <p id="forcePwdMessage"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Peruuta') }}</button>
        <button type="button" id="confirmForcePwdBtn" class="btn btn-warning">
          <i class="fas fa-key me-1"></i>{{ _('Pakota vaihto') }}
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Delete User Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Poista käyttäjä') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Sulje') }}"></button>
      </div>
      <div class="modal-body">
        <p>{{ _('Haluatko poistaa käyttäjän:') }} <strong id="userTitle"></strong>?</p>
        <div id="vahvistaContainer" style="margin-top:15px;">
          <label for="confirmInput">{{ _('Kirjoita VAHVISTA vahvistaaksesi poiston') }}</label>
          <input type="text" id="confirmInput" class="form-control">
        </div>
        <p id="countdownText" style="display:none; margin-top:10px;"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelDeleteBtn" data-bs-dismiss="modal">{{ _('Peruuta')
          }}</button>
        <button type="button" class="btn btn-danger" id="finalDeleteBtn" disabled>{{ _('Poista käyttäjä') }}</button>
      </div>
    </div>
  </div>
</div>

<script>
  let countdown3Sec;
  let countdownInterval;

  function openDeleteModal(event, username, userId) {
    event.preventDefault();

    const userTitle = document.getElementById('userTitle');
    const confirmInput = document.getElementById('confirmInput');
    const finalDeleteBtn = document.getElementById('finalDeleteBtn');
    const countdownText = document.getElementById('countdownText');
    const cancelBtn = document.getElementById('cancelDeleteBtn');

    // Reset modal
    userTitle.textContent = username;
    confirmInput.value = "";
    finalDeleteBtn.disabled = true;
    countdownText.style.display = "none";
    countdownText.textContent = "";
    clearInterval(countdown3Sec);
    clearInterval(countdownInterval);

    // Cancel button stops everything
    const stopAll = () => {
      clearInterval(countdown3Sec);
      clearInterval(countdownInterval);
      finalDeleteBtn.disabled = true;
      countdownText.style.display = "none";
    };

    cancelBtn.onclick = stopAll;
    document.querySelector('#deleteModal .btn-close').onclick = stopAll;

    // Input listener for VAHVISTA
    confirmInput.oninput = () => {
      clearInterval(countdown3Sec);
      finalDeleteBtn.disabled = true;
      countdownText.style.display = "none";

      if (confirmInput.value.toUpperCase() === "VAHVISTA") {
        let countdown = 3;
        countdownText.style.display = "block";
        countdownText.textContent = `Poisto käytettävissä ${countdown}...`;

        countdown3Sec = setInterval(() => {
          countdown--;
          if (countdown > 0) {
            countdownText.textContent = `Poisto käytettävissä ${countdown}...`;
          } else {
            clearInterval(countdown3Sec);
            countdownText.style.display = "none";
            finalDeleteBtn.disabled = false;
          }
        }, 1000);
      } else {
        // Wrong input cancels countdown immediately
        clearInterval(countdown3Sec);
        finalDeleteBtn.disabled = true;
        countdownText.style.display = "none";
      }
    };

    // Delete button click → start 5-second countdown
    finalDeleteBtn.onclick = () => {
      let countdown = 5;
      finalDeleteBtn.disabled = true;
      countdownText.style.display = "block";
      countdownText.textContent = `Käyttäjä poistetaan ${countdown} sekunnin kuluttua...`;

      countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          countdownText.textContent = `Käyttäjä poistetaan ${countdown} sekunnin kuluttua...`;
        } else {
          clearInterval(countdownInterval);
          sendDeleteRequest(userId);
        }
      }, 1000);
    };

    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();

    // Stop all if modal is hidden via backdrop click or ESC
    document.getElementById('deleteModal').addEventListener('hidden.bs.modal', stopAll, { once: true });
  }

  function sendDeleteRequest(userId) {
    fetch("{{ url_for('admin_user.delete_user') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === "OK") {
          const row = document.getElementById(`user-${userId}`);
          if (row) row.remove();
          showToast(data.message);
        } else {
          showToast("Virhe: " + data.message);
        }
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        deleteModal.hide();
      })
      .catch(err => showToast("Virhe pyynnössä: " + err));
  }
</script>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Luo uusi käyttäjä') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Sulje') }}"></button>
      </div>
      <div class="modal-body">

        <!-- Notification / Info -->
        <div class="alert alert-info align-items-start mb-3" role="alert">
          <i class="fa-solid fa-circle-info me-2 mt-1"></i>
          <div class="flex-grow-1">
            Huomio: <strong>Superkäyttäjä / global_admin</strong> -roolia voidaan myöntää vain automaattisesti 
            sen jälkeen, kun hallitus on antanut kirjallisen hyväksynnän ja turvaluokituksen. 
            Roolia ei voi valita tai myöntää manuaalisesti tässä muodossa.
            <br><br>
            Mikä tahansa yritys myöntää roolin manuaalisesti ohittaa hyväksynnän, ei onnistu järjestelmässä.
          </div>
        </div>

        <!-- User Manual Link -->
        <div class="mb-3">
          <a href="{{ url_for('admin.manual_page', page='users/about_roles') }}" target="_blank" class="btn btn-info">
            <i class="fa-solid fa-book me-1"></i> Roolin valintaohje
          </a>
        </div>

        <form id="createUserForm" method="POST" action="{{ url_for('admin_user.create_user') }}">
          <div class="mb-3">
            <label for="username" class="form-label">{{ _('Käyttäjänimi') }}</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          <div class="mb-3">
            <label for="displayname" class="form-label">{{ _('Näyttönimi') }}</label>
            <input type="text" class="form-control" id="displayname" name="displayname">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">{{ _('Sähköposti') }}</label>
            <input type="email" class="form-control" id="email" name="email" required>
          </div>
          <div class="mb-3">
            <label for="role" class="form-label">{{ _('Rooli') }}</label>
            <select class="form-select" id="role" name="role" required>
              <option value="user">{{ _('Käyttäjä') }}</option>
              <option value="admin">{{ _('Admin') }}</option>
              <option value="global_admin" disabled>{{ _('Superkäyttäjä (vain hallituksen hyväksynnän jälkeen)') }}</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Peruuta') }}</button>
            <button type="submit" class="btn btn-success">{{ _('Luo käyttäjä') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Login History Modal -->
<div class="modal fade" id="loginHistoryModal" tabindex="-1" aria-labelledby="loginHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginHistoryModalLabel">{{ _('Kirjautumishistoria') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Sulje') }}"></button>
      </div>
      <div class="modal-body">
        <div id="loginHistoryStatus" class="text-muted text-center py-4">
          {{ _('Valitse käyttäjä nähdäksesi kirjautumishistorian.') }}
        </div>
        <div id="loginHistoryTableWrapper" class="table-responsive d-none">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>{{ _('Aika') }}</th>
                <th>{{ _('Tila') }}</th>
                <th>{{ _('IP-osoite') }}</th>
                <th>{{ _('Lisätiedot') }}</th>
              </tr>
            </thead>
            <tbody id="loginHistoryTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Sulje') }}</button>
      </div>
    </div>
  </div>
</div>

<script>
function openForcePwdModal(username, userId) {
  // Update modal text
  $('#forcePwdMessage').text(
    `Haluatko varmasti pakottaa käyttäjän "${username}" vaihtamaan salasanansa seuraavan kirjautumisen yhteydessä?`
  );

  // Attach event to confirm button
  $('#confirmForcePwdBtn')
    .off('click')
    .on('click', function () {
      $.ajax({
        url: '/admin/user/api/force_password_change',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ user_id: userId }),
        success: function (resp) {
          $('#forcePwdModal').modal('hide');
          showToast(resp.message || 'Salasanan vaihto pakotettu onnistuneesti.', 'success');
        },
        error: function (xhr) {
          $('#forcePwdModal').modal('hide');
          showToast(
            xhr.responseJSON?.message || 'Virhe: salasananvaihtoa ei voitu pakottaa.',
            'danger'
          );
        }
      });
    });

  // Show modal
  $('#forcePwdModal').modal('show');
}

</script>

<script>
const loginHistoryMessages = {
  loading: "{{ _('Haetaan kirjautumisia...') }}",
  empty: "{{ _('Käyttäjälle ei ole kirjautumistietoja.') }}",
  error: "{{ _('Kirjautumisia ei voitu hakea juuri nyt.') }}",
  successLabel: "{{ _('Onnistui') }}",
  failedLabel: "{{ _('Epäonnistui') }}",
  noReason: "{{ _('Ei lisätietoa') }}",
  successReason: "{{ _('Onnistunut kirjautuminen') }}"
};

const loginHistoryStatusEl = document.getElementById('loginHistoryStatus');
const loginHistoryTableWrapper = document.getElementById('loginHistoryTableWrapper');
const loginHistoryTableBody = document.getElementById('loginHistoryTableBody');
const loginHistoryModalEl = document.getElementById('loginHistoryModal');
const loginHistoryModalLabel = document.getElementById('loginHistoryModalLabel');
let loginHistoryModalInstance;

function escapeHtml(text) {
  if (text === null || text === undefined) {
    return '';
  }
  return text
    .toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function showLoginHistoryStatus(message, isError = false) {
  loginHistoryStatusEl.textContent = message;
  loginHistoryStatusEl.classList.toggle('text-danger', isError);
  loginHistoryStatusEl.classList.toggle('text-muted', !isError);
  loginHistoryStatusEl.classList.remove('d-none');
  loginHistoryTableWrapper.classList.add('d-none');
}

function renderLoginHistoryTable(logs) {
  if (!logs.length) {
    showLoginHistoryStatus(loginHistoryMessages.empty);
    return;
  }

  const rows = logs
    .map((log) => {
      const statusBadge = log.success
        ? `<span class="badge bg-success">${loginHistoryMessages.successLabel}</span>`
        : `<span class="badge bg-danger">${loginHistoryMessages.failedLabel}</span>`;

      const reason = log.success
        ? loginHistoryMessages.successReason
        : (log.reason ? escapeHtml(log.reason) : loginHistoryMessages.noReason);

      const userAgentRow = log.user_agent
        ? `<div class="small text-muted">${escapeHtml(log.user_agent)}</div>`
        : '';

      return `
        <tr>
          <td>${escapeHtml(log.timestamp_display || log.timestamp || '')}</td>
          <td>${statusBadge}</td>
          <td>${escapeHtml(log.ip || '-')}</td>
          <td>${reason}${userAgentRow}</td>
        </tr>
      `;
    })
    .join('');

  loginHistoryTableBody.innerHTML = rows;
  loginHistoryStatusEl.classList.add('d-none');
  loginHistoryTableWrapper.classList.remove('d-none');
}

function openLoginHistoryModal(userId, displayName, username) {
  if (!loginHistoryModalInstance) {
    loginHistoryModalInstance = new bootstrap.Modal(loginHistoryModalEl);
  }
  const label = displayName || username || '';
  loginHistoryModalLabel.textContent = `${"{{ _('Kirjautumishistoria') }}"} - ${label}`;
  showLoginHistoryStatus(loginHistoryMessages.loading);
  loginHistoryModalInstance.show();

  fetch(`/admin/user/api/login_history/${userId}?limit=50`, {
    headers: { 'Accept': 'application/json' }
  })
    .then((response) => {
      if (!response.ok) {
        throw new Error('HTTP error');
      }
      return response.json();
    })
    .then((payload) => {
      if (payload.status !== "OK") {
        throw new Error(payload.message || "unknown");
      }
      renderLoginHistoryTable(payload.logins || []);
    })
    .catch(() => {
      showLoginHistoryStatus(loginHistoryMessages.error, true);
    });
}

</script>
