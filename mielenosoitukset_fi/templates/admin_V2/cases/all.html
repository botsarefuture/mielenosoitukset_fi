{% extends "admin_base.html" %}
{% block title %}{{ _('Kaikki tapaukset') }}{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css">
  <style>
    tbody tr      { cursor:pointer; transition:background-color .15s ease; }
    tbody tr:hover{ background:rgba(13,110,253,.05); }
    .badge-urgency-low    { background:#6c757d; }
    .badge-urgency-medium { background:#ffc107; color:#212529; }
    .badge-urgency-high   { background:#dc3545; }
    .status-icon { width:1rem; }
    /* colour bar for urgency */
    tr.urgency-high   td { border-left:4px solid #dc3545; }
    tr.urgency-medium td { border-left:4px solid #ffc107; }
    tr.urgency-low    td { border-left:4px solid #6c757d; }
  </style>
{% endblock %}

{% block main_content %}
  <h1 class="mb-4">{{ _('Kaikki tapaukset') }}</h1>

  {% if all_cases %}
  <div class="table-responsive">
    <table id="casesTable" class="table table-striped table-hover align-middle nowrap" style="width:100%">
      <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col">{{ _('Tyyppi') }}</th>
          <th scope="col">{{ _('Kuvaus') }}</th>
          <th scope="col">{{ _('Kiireellisyys') }}</th>
          <th scope="col">{{ _('Tila') }}</th>
          <th scope="col">{{ _('Luotu') }}</th>
          <th scope="col">{{ _('Lähettäjä') }}</th>
          <th scope="col" class="text-end">{{ _('Toiminnot') }}</th>
        </tr>
      </thead>
      <tbody>
      {% for case in all_cases %}
        {% set urg = case.meta.urgency if case.meta else None %}
        {% set description %}
            {% if case.case_type == 'new_demo' and case.demo %}
                {{ case.demo.title or case.demo.name or case.description or _('Ei kuvausta') }}
            {% elif case.case_type == 'demo_error_report' %}
                {{ case.error_report.summary or case.error_report.message or case.description or _('Ei kuvausta') }}
            {% elif case.case_type == 'organization_edit_suggestion' %}
                {{ case.suggestion.title or case.suggestion.summary or case.description or _('Ei kuvausta') }}
            {% else %}
                {{ case.description or _('Ei kuvausta') }}
            {% endif %}
        {% endset %}
        <tr class="urgency-{{ urg }}" data-href="{{ url_for('admin_case.single_case', case_id=case._id) }}">
          <th scope="row">{{ loop.index }}</th>
          <td data-priority="1">
            {% if case.case_type == "new_demo" %}
              <i class="fas fa-bullhorn text-primary me-1 status-icon"></i>
            {% elif case.case_type == "demo_error_report" %}
              <i class="fas fa-exclamation-triangle text-warning me-1 status-icon"></i>
            {% elif case.case_type == "organization_edit_suggestion" %}
              <i class="fas fa-building text-success me-1 status-icon"></i>
            {% endif %}
            {{ case.case_type|replace("_"," ")|capitalize }}
          </td>
          <td class="text-truncate" style="max-width:260px;">{{ description|striptags }}</td>
          <td>
            {% if urg %}<span class="badge badge-urgency-{{ urg }}">{{ _(urg|capitalize) }}</span>{% endif %}
          </td>
          <td>
            {% if case.case_type == "new_demo" %}
              {% if case.meta and case.meta.superior_needed %}
                <i class="fas fa-exclamation-triangle text-warning"></i> {{ _('Eskaloitu') }}
              {% else %}
                {% if case.demo and case.demo.accepted %}
                  <i class="fas fa-check text-success"></i> {{ _('Hyväksytty') }}
                {% elif case.demo and case.demo.rejected %}
                  <i class="fas fa-times text-danger"></i> {{ _('Hylätty') }}
                {% else %}
                  <i class="fas fa-clock text-secondary"></i> {{ _('Odottaa') }}
                {% endif %}
              {% endif %}
            {% else %}-{% endif %}
          </td>
          <td data-order="{{ case.created_at.timestamp() if case.created_at else 0 }}">{{ case.created_at|datetimeformat("%d.%m.%Y %H:%M") }}</td>
          <td>{{ case.submitter.submitter_name or _('Ei tiedossa') }}</td>
          <td class="text-end">
            <a href="{{ url_for('admin_case.single_case', case_id=case._id) }}" class="btn btn-sm btn-outline-primary" title="{{ _('Näytä') }}">
              <i class="fas fa-circle-info"></i>
            </a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-info text-center">{{ _('Ei tapauksia tällä hetkellä.') }}</div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script>
    $(function(){
      const table = $('#casesTable').DataTable({
        responsive:true,
        fixedHeader:true,
        order:[[5,'desc']],
        pageLength:25,
        language:{ url:'https://cdn.datatables.net/plug-ins/1.13.8/i18n/fi.json' },
        columnDefs:[
          { targets:[0,3,6,7], className:'text-nowrap' }
        ]
      });
      // clickable rows except on buttons/links
      $('#casesTable tbody').on('click','tr',function(e){
        if(!$(e.target).closest('a,button').length){ window.location = $(this).data('href'); }
      });
    });
  </script>
{% endblock %}
