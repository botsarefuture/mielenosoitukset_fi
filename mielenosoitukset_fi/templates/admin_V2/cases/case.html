{% extends "admin_base.html" %}
{% block title %} Tapaus #{{ case.running_num }} {% endblock %}
{% block main_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/case.css' )}}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Hylk√§√§ mielenosoitus</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="reject-reason" class="form-label">Syy hylk√§√§miselle:</label>
                    <textarea id="reject-reason" class="form-control" rows="3" placeholder="Kirjoita syy..."
                        required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                <button type="button" id="confirm-reject-btn" class="btn btn-danger">Hylk√§√§</button>
            </div>
        </div>
    </div>
</div>
<div class="dashboard-container">
    <!-- Page Header -->
    <section class="page-header">
        <h1>
            Tapaus <span class="case-number">#{{ case.running_num }}</span>
        </h1>
        <p class="page-subtitle">
            {{ _('T√§m√§ n√§kym√§ n√§ytt√§√§ asiakaspalvelun pyynn√∂n tiedot ja mahdollistaa k√§sittelyn.') }}<br>
            {{ _('Muistathan tallentaa tekem√§si muutokset tai lis√§t√§ sis√§iset muistiinpanot ennen poistumista.') }}
        </p>
    </section>

    <!-- Tags -->
    <section class="case-tags">
        {% for tag in case.tags %}
        <span class="tag">{{ tag }}</span>
        {% endfor %}
        {% if not case.tags %}
        <span class="tag" style="opacity: 0.5;">{{ _('Ei tunnisteita lis√§tty.') }}</span>
        {% endif %}
    </section>

    <!-- Main Content Grid -->
    <section class="case-content">
        <!-- Main Column -->
        <div class="main-column">

            <!-- Case Type Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fa-solid fa-file-lines icon"></i>
                        {{ _('Pyynt√∂tyyppi') }}
                        <span class="case-type-badge">{{ case.case_type|capitalize|replace('_', ' ') }}</span>
                    </h2>
                </div>

                {% set case_type = case.case_type %}

                {% if case_type == "demo_error_report" %}
                <div class="info-grid">
                    <div class="info-box">
                        <h3>
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            {{ _('Virheraportti') }}
                        </h3>
                        <div class="info-item">
                            <strong>{{ _('Ongelma:') }}</strong><br>
                            {{ case_data.error_description }}
                        </div>
                        <div class="info-item">
                            <strong>{{ _('Raportoija:') }}</strong> {{ case_data.reported_by }}
                        </div>
                        <div class="info-item">
                            <strong>{{ _('Aikaleima:') }}</strong> {{ case_data.timestamp }}
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {{ _('Demon tiedot') }}
                        </h3>
                        <div class="info-item">
                            <strong>{{ _('Nimi:') }}</strong> {{ case_data.demo.name }}
                        </div>
                        <div class="info-item">
                            <strong>{{ _('P√§iv√§m√§√§r√§:') }}</strong> {{ case_data.demo.date }}
                        </div>
                        <div class="info-item">
                            <strong>{{ _('Kuvaus:') }}</strong> {{ case_data.demo.description }}
                        </div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 20px;">
                    <h3>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        {{ _('Muokkaa tietoja') }}
                    </h3>
                    <form id="demo-edit-form">
                        <div class="form-group">
                            <label class="form-label">{{ _('Nimi') }}</label>
                            <input type="text" name="name" value="{{ case_data.demo.name }}" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">{{ _('P√§iv√§m√§√§r√§') }}</label>
                            <input type="text" name="date" value="{{ case_data.demo.date }}" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">{{ _('Kuvaus') }}</label>
                            <textarea name="description"
                                class="form-textarea">{{ case_data.demo.description }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            {{ _('Tallenna muutokset') }}
                        </button>
                    </form>
                </div>

                {% elif case_type == "organization_edit_suggestion" %}
                <div class="info-box" style="margin-top: 20px;">
                    <h3>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        {{ _('Organisaation tiedot') }}
                    </h3>
                    <div class="info-item">
                        <strong>{{ _('Organisaatio:') }}</strong> {{ case_data.organization_name }}
                    </div>
                    <div class="info-item">
                        <strong>{{ _('Ehdotetut muutokset:') }}</strong>
                    </div>
                    <ul class="changes-list">
                        {% for change in case_data.changes %}
                        <li>
                            <strong>{{ change.field }}</strong>
                            <span class="change-arrow">‚Üí</span>
                            <span style="text-decoration: line-through; opacity: 0.6;">{{ change.old }}</span>
                            <span class="change-arrow">‚Üí</span>
                            <span style="color: #81c784;">{{ change.new }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                {% elif case_type == "new_demo" %}
                <div class="info-box mt-6">
                    <h3 class="flex items-center gap-2 text-xl font-semibold mb-3">
                        <i class="fa-solid fa-people-group w-6 h-6 text-pink-400"></i>
                        {{ _('Uusi mielenosoitus') }}
                    </h3>

                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Left: main info -->
                        <div class="space-y-2">
                            <div class="info-item">
                                <strong>{{ _('ID:') }}</strong> {{ case_data.demo._id }}
                            </div>

                            <div class="info-item">
                                <strong>STATUS:</strong>
                                {% if case_data.demo.accepted %}
                                <i class="fa-solid fa-circle-check text-green-500"></i> Hyv√§ksytty
                                {% elif case_data.demo.rejected %}
                                <i class="fa-solid fa-circle-xmark text-red-500"></i> Hyl√§tty
                                {% elif case.meta.superior_needed %}
                                <i class="fa-solid fa-hourglass-half text-yellow-400"></i> Odottaa esihenkil√∂n
                                tarkastusta
                                {% else %}
                                <i class="fa-solid fa-hourglass-half text-yellow-400"></i> Odottaa
                                {% endif %}
                            </div>

                            <div class="info-item">
                                <strong>{{ _('Otsikko:') }}</strong> {{ case_data.demo.title }}
                            </div>
                            <div class="info-item">
                                <strong>{{ _('P√§iv√§m√§√§r√§:') }}</strong> {{ case_data.demo.date }}
                            </div>
                            <div class="info-item">
                                <strong>{{ _('Alkamisaika:') }}</strong> {{ case_data.demo.start_time }}
                            </div>

                            {% if case_data.demo.end_time %}
                            <div class="info-item">
                                <strong>{{ _('P√§√§ttymisaika:') }}</strong> {{ case_data.demo.end_time }}
                            </div>
                            {% endif %}

                            <div class="info-item">
                                <strong>{{ _('Kaupunki:') }}</strong> {{ case_data.demo.city }}
                            </div>
                            <div class="info-item">
                                <strong>{{ _('Osoite:') }}</strong> {{ case_data.demo.address }}
                            </div>

                            {% if case_data.demo.route %}
                            <div class="info-item">
                                <strong>{{ _('Reitti:') }}</strong> {{ case_data.demo.route }}
                            </div>
                            {% endif %}

                            <div class="info-item">
                                <strong>{{ _('Tapahtumatyyppi:') }}</strong> {{ case_data.demo.event_type }}
                            </div>

                            {% if case_data.demo.facebook %}
                            <div class="info-item">
                                <strong>Facebook:</strong>
                                <a href="{{ case_data.demo.facebook }}" target="_blank"
                                    class="text-pink-400 underline">Linkki</a>
                            </div>
                            {% endif %}

                            {% if case_data.demo.tags %}
                            <div class="info-item">
                                <strong>{{ _('Tunnisteet:') }}</strong>
                                {% for tag in case_data.demo.tags %}
                                <span class="badge bg-pink text-dark px-2 py-1 rounded-pill text-sm">
                                    <a href="{{ url_for('tag_detail', tag_name=tag) }}">#{{ tag }}</a>
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Right: description + photo -->
                        <div>
                            {% if case_data.demo.img %}
                            <img src="{{ case_data.demo.img }}" alt="Demo image"
                                class="w-full rounded-xl border border-neutral-700 mb-3 shadow-md">
                            {% endif %}
                            <p class="whitespace-pre-line">{{ case_data.demo.description }}</p>
                        </div>
                    </div>

                    <hr class="my-6 border-neutral-700">

                    <!-- Organizers -->
                    {% if case_data.demo.organizers %}
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-pink-400 mb-4">{{ _('J√§rjest√§j√§t') }}</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            {% for org in case_data.demo.organizers %}
                            <div
                                class="bg-neutral-800 dark:bg-neutral-900 p-4 rounded-xl border border-neutral-700 shadow flex flex-col gap-2 hover:shadow-lg transition-all">
                                <p class="font-semibold text-white text-lg flex items-center gap-2">
                                    <i class="fa-solid fa-user text-pink-400"></i> {{ org.name }}
                                </p>

                                {% if org.email %}
                                <p class="text-sm text-neutral-400 flex items-center gap-2">
                                    <i class="fa-solid fa-envelope"></i>
                                    <a href="mailto:{{ org.email }}" class="text-pink-400 underline">{{ org.email }}</a>
                                </p>
                                {% endif %}

                                {% if org.website %}
                                <p class="text-sm text-neutral-400 flex items-center gap-2">
                                    <i class="fa-solid fa-globe"></i>
                                    <a href="{{ org.website }}" target="_blank" class="text-pink-400 underline">{{
                                        _('Sivusto') }}</a>
                                </p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <hr class="my-6 border-neutral-700">

                    <!-- Submitter info -->
                    <div class="info-item">
                        <h4 class="font-semibold mb-2">{{ _('Ilmoittaja') }}</h4>
                        <p><strong>{{ _('Nimi:') }}</strong> {{ case_data.submitter.submitter_name }}</p>
                        <p><strong>{{ _('S√§hk√∂posti:') }}</strong> {{ case_data.submitter.submitter_email }}</p>
                        <p><strong>{{ _('Rooli:') }}</strong> {{ case_data.submitter.submitter_role }}</p>
                        <p><strong>{{ _('Hyv√§ksynyt ehdot:') }}</strong>
                            {% if case_data.submitter.accept_terms %}
                            ‚úÖ
                            {% else %}
                            ‚ùå
                            {% endif %}
                        </p>
                        <p><small class="text-neutral-500">{{ _('L√§hetetty:') }} {{ case_data.submitter.submitted_at
                                }}</small></p>
                    </div>

                    <div class="actions mt-8 flex gap-4">
                        <button id="accept-demo" class="btn btn-success" onclick="sendDemoAction('accept')" {% if
                            case.meta.superior_needed %}disabled{% endif %}>
                            <i class="fa-solid fa-check"></i> {{ _('Hyv√§ksy mielenosoitus') }}
                        </button>

                        <button id="reject-btn" class="btn btn-danger" data-bs-toggle="modal"
                            data-bs-target="#rejectModal" {% if case.meta.superior_needed %}disabled{% endif %}>
                            <i class="fa-solid fa-xmark"></i> Hylk√§√§
                        </button>

                        <button id="escalate-btn" class="btn btn-secondary" onclick="escalateDemo()" {% if
                            case.meta.superior_needed %}disabled{% endif %}>
                            <i class="fa-solid fa-triangle-exclamation"></i> {{ _('Eskaloi esihenkil√∂lle') }}
                        </button>
                    </div>
                    <script>
                        const caseId = "{{ case._id }}";
                        const isSuperior = {{ 'true' if current_user.role == 'global_admin' else 'false' }};
                        const superiorNeeded = {{ 'true' if case.meta.superior_needed else 'false' }};

                        document.addEventListener("DOMContentLoaded", () => {
                            // If user is the superior, unlock all buttons even if superior_needed = true
                            if (isSuperior) {
                                document.getElementById("accept-demo").disabled = false;
                                document.getElementById("reject-btn").disabled = false;
                                document.getElementById("escalate-btn").disabled = false;

                                // Optional cute info popup if a case was escalated to them
                                if (superiorNeeded) {
                                    Swal.fire({
                                        title: "Sinulle on uusi tarkastettavaksi odottava pyynt√∂ üí¨",
                                        text: "T√§m√§ mielenosoitus odottaa esihenkil√∂n hyv√§ksynt√§√§.",
                                        icon: "info",
                                        confirmButtonText: "Tarkista nyt",
                                        confirmButtonColor: "#ec4899"
                                    });
                                }
                            }

                            // Accept
                            document.getElementById("accept-demo").addEventListener("click", () => {
                                sendDemoAction("accept");
                            });

                            // Reject (modal confirm)
                            document.getElementById("confirm-reject-btn").addEventListener("click", () => {
                                const reason = document.getElementById("reject-reason").value.trim();
                                if (!reason) return alert("Syy hylk√§√§miselle on pakollinen!");
                                sendDemoAction("reject", reason);
                                bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
                            });
                        });

                        function sendDemoAction(action, reason = "") {
                            fetch(`/admin/case/${caseId}/demo_action`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ action, reason })
                            })
                                .then(res => res.json())
                                .then(result => {
                                    if (result.success) {
                                        Swal.fire("Onnistui!", `Tila: ${result.status}`, "success").then(() => location.reload());
                                    } else {
                                        Swal.fire("Virhe", result.error, "error");
                                    }
                                })
                                .catch(() => Swal.fire("Virhe", "Tapahtui virhe, kokeile uudelleen.", "error"));
                        }

                        function escalateDemo() {
                            if (isSuperior) {
                                Swal.fire({
                                    title: "üíÖ Girl, you *are* the manager!",
                                    text: "You can‚Äôt escalate this any higher ‚Äî you‚Äôre literally the final boss here üò≠",
                                    icon: "warning",
                                    confirmButtonColor: "#ec4899"
                                });
                                return;

                            }

                            fetch(`/admin/case/${caseId}/demo_escalate`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" }
                            })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.success) {
                                        Swal.fire("Eskalointi onnistui", "Demo status asetettu tarkastettavaksi esihenkil√∂lle.", "info");
                                        document.getElementById("accept-demo").disabled = true;
                                        document.getElementById("reject-btn").disabled = true;
                                        document.getElementById("escalate-btn").disabled = true;
                                    } else {
                                        Swal.fire("Virhe", data.error, "error");
                                    }
                                });
                        }
                    </script>

                </div>

                {% endif %}

            </div>

            <!-- Action Log Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        {{ _('Sis√§iset toimet ja muistiinpanot') }}
                    </h2>
                </div>

                <form id="action-log-form">
                    <div class="form-group">
                        <label class="form-label">{{ _('Toimenpide') }}</label>
                        <select name="action_type" class="form-select">
                            <option value="accept">‚úì {{ _('Hyv√§ksytty') }}</option>
                            <option value="reject">‚úó {{ _('Hyl√§tty') }}</option>
                            <option value="note">üìù {{ _('Muistiinpano') }}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{{ _('Syy tai kuvaus') }}</label>
                        <textarea name="reason" placeholder="Kirjoita syy tai perustelu..."
                            class="form-textarea"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        {{ _('Lis√§√§ merkint√§') }}
                    </button>
                </form>

                <div style="margin-top: 30px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 15px; color: #f48fb1;">
                        {{ _('Aiemmat merkinn√§t') }}
                    </h3>
                    <div id="action-log" class="action-log">
                        {% for log in case.action_logs %}
                        <div class="log-entry">
                            <strong>{{ log.user }}</strong>: {{ log.reason }}
                            <span class="log-timestamp">{{ log.timestamp }}</span>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <p>{{ _('Ei viel√§ merkint√∂j√§.') }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Actions Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        {{ _('Toiminnot') }}
                    </h3>
                </div>

                {% if case.meta.superior_needed %}
        <div class="alert alert-warning mt-2 mb-2">
            <i class="fas fa-exclamation-triangle"></i> {{ _('Eskaloitu esihenkil√∂lle') }}
        </div>
        {% endif %}

                <button class="btn btn-success btn-block">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {{ _('Hyv√§ksy pyynt√∂') }}
                </button>

                <button class="btn btn-danger btn-block">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {{ _('Hylk√§√§ pyynt√∂') }}
                </button>


                {% if not case.meta.superior_needed %}
                <button class="btn btn-warning btn-block" onclick="openEscalationModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    {{ _('Eskaloi esihenkil√∂lle') }}
                </button>
                {% elif current_user.role == "global_admin" %}
                <button class="btn btn-info btn-block" onclick="deescalateCase()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 17H3l9-11v7h8l-9 11v-7z" />
                    </svg>
                    {{ _('Poista eskalointi') }}
                </button>
                {% endif %}

            </div>

            <!-- History Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {{ _('Tapahtumahistoria') }}
                    </h3>
                </div>

                <div class="timeline">
                    {% for event in case.case_history %}
                    <div class="timeline-item">
                        <div class="timeline-time">{{ event.timestamp }}</div>
                        <div class="timeline-action">{{ event.action }}</div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p>{{ _('Ei tapahtumia.') }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </aside>
    </section>
</div>

<!-- Escalation Modal -->
<div id="escalation-modal" class="modal hidden">
    <div class="modal-content">
        <h3 class="modal-header">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
            {{ _('Eskaloi hallituksen k√§sittelyyn') }}
        </h3>

        <form id="escalate-form">
            <div class="form-group">
                <label class="form-label">{{ _('Syy eskalointiin') }}</label>
                <textarea name="reason" class="form-textarea"
                    placeholder="Kerro miksi t√§m√§ tapaus vaatii hallituksen huomiota..."></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEscalationModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    {{ _('Peruuta') }}
                </button>
                <button type="submit" class="btn btn-primary">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    {{ _('L√§het√§ eskalointi') }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Modal functions
    function openEscalationModal() {
        document.getElementById('escalation-modal').classList.remove('hidden');
        document.getElementById('escalation-modal').classList.add('show');


    }

    function closeEscalationModal() {
        document.getElementById('escalation-modal').classList.add('hidden');
        document.getElementById('escalation-modal').classList.remove('show');

    }


    document.addEventListener("DOMContentLoaded", () => {
        let tcm = document.getElementById("taskConfirmModal");
        tcm.remove();
    })
    // Close modal on background click
    document.getElementById('escalation-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeEscalationModal();
        }
    });

    // Demo edit form handler
    document.getElementById('demo-edit-form')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        // Show success message
        showMessage('success', 'Muutokset tallennettu onnistuneesti!');

        // Here you would typically send the data to the server
        console.log('Demo edit data:', Object.fromEntries(formData));
    });

    // Action log form handler
    document.getElementById('action-log-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const actionType = formData.get('action_type');
        const reason = formData.get('reason');

        if (!reason.trim()) {
            showMessage('error', 'Sy√∂t√§ kuvaus tai syy toimenpiteelle.');
            return;
        }

        // Add to action log
        const logContainer = document.getElementById('action-log');
        const emptyState = logContainer.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        const now = new Date();
        const timestamp = now.toLocaleString('fi-FI');

        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `<strong>Sin√§</strong>: ${reason} <span class="log-timestamp">${timestamp}</span>`;
        logEntry.style.animation = 'slideUp 0.4s ease-out';

        logContainer.insertBefore(logEntry, logContainer.firstChild);

        // Clear form
        this.reset();

        showMessage('success', 'Merkint√§ lis√§tty onnistuneesti!');
    });

    // Escalation form handler
    document.getElementById('escalate-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const reason = formData.get('reason');

        if (!reason.trim()) {
            showMessage('error', 'Sy√∂t√§ syy eskalointiin.');
            return;
        }

        // Here you would typically send the escalation to the server
        console.log('Escalation reason:', reason);

        closeEscalationModal();
        showMessage('success', 'Tapaus eskaloitu hallitukselle!');

        this.reset();
    });

    // Message display function
    function showMessage(type, text) {
        const existingMessage = document.querySelector('.message');
        if (existingMessage) {
            existingMessage.remove();
        }

        const message = document.createElement('div');
        message.className = `message message-${type}`;

        const icon = type === 'success'
            ? '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
            : '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';

        message.innerHTML = icon + '<span>' + text + '</span>';

        const container = document.querySelector('.dashboard-container');
        container.insertBefore(message, container.firstChild);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            message.style.animation = 'fadeIn 0.3s ease-out reverse';
            setTimeout(() => message.remove(), 300);
        }, 5000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        // ESC to close modal
        if (e.key === 'Escape') {
            closeEscalationModal();
        }
    });

    function deescalateCase() {
    Swal.fire({
        title: "Poistetaanko eskalointi?",
        text: "T√§m√§ palauttaa tapauksen normaaliksi k√§sitelt√§v√§ksi.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Kyll√§, poista eskalointi",
        cancelButtonText: "Peruuta"
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/admin/case/${caseId}/deescalate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "Eskalointi poistettu",
                            text: "Tapaus on palautettu normaaliin tilaan.",
                            icon: "success",
                            confirmButtonColor: "#3085d6"
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            title: "Virhe",
                            text: data.error || "Tapahtui virhe poistettaessa eskalointia.",
                            icon: "error",
                            confirmButtonColor: "#d33"
                        });
                    }
                })
                .catch(err => {
                    console.error(err);
                    Swal.fire({
                        title: "Virhe",
                        text: "Tapahtui virhe, kokeile uudelleen my√∂hemmin.",
                        icon: "error",
                        confirmButtonColor: "#d33"
                    });
                });
        }
    });
}

</script>

{% endblock %}