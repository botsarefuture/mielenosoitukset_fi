{% extends 'admin_base.html' %}

{% block styles %}
<style>
  :root {
    --card-bg: #ffffff;
    --card-shadow: 0 15px 35px rgba(0,0,0,0.07);
    --border-muted: #e9ecef;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: minmax(0, 3fr) minmax(320px, 1.25fr);
    gap: 1.75rem;
  }

  .card-panel {
    background: var(--card-bg);
    border-radius: 18px;
    padding: 1.75rem;
    box-shadow: var(--card-shadow);
  }

  .live-header {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: flex-start;
  }

  .eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.78rem;
    color: #6c757d;
    margin-bottom: 0.35rem;
  }

  .live-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #f1f3f5;
    padding: 0.65rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    color: #495057;
  }

  .live-indicator .pulse {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #dc3545;
    position: relative;
    animation: pulse 2s infinite;
  }

  .clock-chip {
    background: #fff;
    border: 1px solid var(--border-muted);
    color: #212529;
  }

  .clock-chip .pulse {
    background: #198754;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.35); }
    70% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
  }

  .stat-grid {
    display: grid;
    gap: 1.25rem;
    margin-top: 1.75rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .stat-card {
    border: 1px solid var(--border-muted);
    border-radius: 16px;
    padding: 1.25rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-4px);
    border-color: #74c0fc;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.35rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
  }

  .stat-sub {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.4rem;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .system-rows {
    margin-top: 1.75rem;
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }

  .panic-card {
    border: 1px solid var(--border-muted);
    border-radius: 18px;
    padding: 1.5rem;
    display: flex;
    gap: 1.5rem;
    align-items: center;
  }

  .panic-grid {
    display: grid;
    grid-template-columns: repeat(2, 70px);
    grid-template-rows: repeat(2, 70px);
    gap: 10px;
  }

  .panic-grid span {
    border-radius: 14px;
    background: #e9ecef;
    transition: background 0.3s ease, transform 0.3s ease;
  }

  .panic-grid.active span {
    background: linear-gradient(135deg, #dc3545, #ff6b6b);
    animation: alert 1.5s infinite;
  }

  .panic-grid.safe span {
    background: linear-gradient(135deg, #198754, #51cf66);
  }

  @keyframes alert {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(0.95); opacity: 0.75; }
    100% { transform: scale(1); opacity: 1; }
  }

  .panic-status-text h4 {
    margin-bottom: 0.35rem;
  }

  .panic-state {
    font-size: 1.1rem;
    font-weight: 600;
    color: #212529;
  }

  .panic-state.active {
    color: #dc3545;
  }

  .panic-state.safe {
    color: #198754;
  }

  .panic-actions form {
    display: inline-block;
    margin-top: 0.75rem;
    margin-right: 0.5rem;
  }

  .health-card {
    border: 1px solid var(--border-muted);
    border-radius: 18px;
    padding: 1.5rem;
  }

  .health-metric {
    margin-bottom: 1.1rem;
  }

  .health-label {
    font-size: 0.9rem;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.35rem;
  }

  .progress-bar {
    height: 10px;
    border-radius: 999px;
    background: #e9ecef;
    overflow: hidden;
  }

  .progress-bar span {
    display: block;
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(135deg, #339af0, #845ef7);
    width: 0%;
    transition: width 0.4s ease;
  }

  .quick-actions {
    margin-top: 1.5rem;
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .quick-card {
    border: 1px solid var(--border-muted);
    border-radius: 16px;
    padding: 1rem 1.25rem;
    transition: background 0.2s ease, transform 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .quick-card:hover {
    background: #f8f9fa;
    transform: translateY(-3px);
  }

  .quick-card strong {
    font-size: 1rem;
  }

  .side-panel {
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  .side-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 0.75rem;
  }

  .login-feed {
    flex: 1;
    overflow-y: auto;
    max-height: 70vh;
    padding-right: 0.25rem;
  }

  .login-entry {
    border-radius: 14px;
    border: 1px solid var(--border-muted);
    padding: 1rem;
    margin-bottom: 0.85rem;
    transition: transform 0.2s ease;
    background: #fff;
    position: relative;
  }

  .login-entry::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    border-radius: 12px 0 0 12px;
  }

  .login-entry.success::before {
    background: #198754;
  }

  .login-entry.failure::before {
    background: #dc3545;
  }

  .entry-heading {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .status-pill {
    padding: 0.15rem 0.65rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-pill.success {
    background: rgba(25, 135, 84, 0.1);
    color: #0f5132;
  }

  .status-pill.failure {
    background: rgba(220, 53, 69, 0.1);
    color: #842029;
  }

  .entry-meta {
    margin-top: 0.6rem;
    font-size: 0.85rem;
    color: #6c757d;
    display: grid;
    gap: 0.25rem;
  }

  .empty-state {
    border: 1px dashed var(--border-muted);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    color: #6c757d;
  }

  @media (max-width: 1200px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .login-feed {
      max-height: none;
    }
  }
</style>
{% endblock %}

{% block main_content %}
<div class="container-fluid py-4">
  <div class="dashboard-grid">
    <section class="main-panel card-panel">
      <header class="live-header">
        <div>
          <div class="eyebrow">{{ _('Hallintatyökalut') }}</div>
          <h2 class="mb-1">{{ _('Reaaliaikainen tilannekuva') }}</h2>
          <p class="text-muted mb-0">{{ _('Pysy kärryillä palvelun kuormituksesta, kirjautumisista ja hallintatoiminnoista yhdellä silmäyksellä.') }}</p>
        </div>
        <div class="live-indicator">
          <span class="pulse"></span>
          <div>
            <div>{{ _('Live-seuranta') }}</div>
            <small class="text-muted">{{ _('Päivitetty') }} <span id="snapshot-updated">—</span></small>
          </div>
        </div>
        <div class="live-indicator clock-chip">
          <span class="pulse"></span>
          <div>
            <div>{{ _('Helsinki') }}</div>
            <small class="text-muted"><span id="helsinki-clock">--:--:--</span></small>
          </div>
        </div>
      </header>

      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-label">{{ _('Käyttäjiä') }}</div>
          <div class="stat-value" id="stat-users-total">—</div>
          <div class="stat-sub">
            <span>{{ _('Vahvistettu') }}: <strong id="stat-users-confirmed">—</strong></span>
            <span>{{ _('Kesken') }}: <strong id="stat-users-pending">—</strong></span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">{{ _('Ylläpitäjiä') }}</div>
          <div class="stat-value" id="stat-users-admins">—</div>
          <div class="stat-sub">
            <span>{{ _('Mahdolliset uudet oikeudet') }}</span>
            <span class="text-success"><i class="fa-solid fa-shield-halved me-1"></i>{{ _('Valvottu') }}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">{{ _('Organisaatiot') }}</div>
          <div class="stat-value" id="stat-orgs-active">—</div>
          <div class="stat-sub">
            <span>{{ _('Aktiivisia toimijoita') }}</span>
            <span>{{ _('Koko maassa') }}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">{{ _('Tapahtumat') }}</div>
          <div class="stat-value" id="stat-demos-live">—</div>
          <div class="stat-sub">
            <span>{{ _('Valmiina julkaisuun') }}: <strong id="stat-demos-pending">—</strong></span>
            <span>{{ _('Näkyvissä sivustolla') }}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">{{ _('Hallintatapaukset') }}</div>
          <div class="stat-value" id="stat-cases-open">—</div>
          <div class="stat-sub">
            <span>{{ _('Avoimia tikettejä') }}</span>
            <span class="text-warning"><i class="fa-solid fa-circle-dot me-1"></i>{{ _('Seurannassa') }}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">{{ _('Kirjautumiset / h') }}</div>
          <div class="stat-value" id="stat-logins-hour">—</div>
          <div class="stat-sub">
            <span>{{ _('Onnistumisprosentti') }}: <strong id="stat-logins-success">—</strong></span>
            <span>{{ _('24h yhteensä') }}: <strong id="stat-logins-day">—</strong></span>
          </div>
        </div>
      </div>

      <div class="system-rows">
        <div class="panic-card">
          <div class="panic-grid {{ 'active' if panic_mode else 'safe' }}" id="panic-grid">
            <span></span><span></span><span></span><span></span>
          </div>
          <div class="panic-status-text">
            <p class="text-muted mb-1">{{ _('Panic Mode') }}</p>
            <h4 class="mb-1">{{ _('Järjestelmävahti') }}</h4>
            <div id="panic-state" class="panic-state {{ 'active' if panic_mode else 'safe' }}">
              {{ _('AKTIIVINEN') if panic_mode else _('POIS PÄÄLTÄ') }}
            </div>
            <p class="text-muted mb-2">{{ _('Panic Mode lukitsee käyttäjille näkyvät palvelut kriisitilanteissa.') }}</p>
            {% if current_user.role == "global_admin" %}
            <div class="panic-actions">
              {% if panic_mode %}
                <form method="POST" action="{{ url_for('admin.deactivate_panic') }}">
                  <button type="submit" class="btn btn-outline-success btn-sm">
                    <i class="fa-solid fa-unlock me-1"></i>{{ _('Poista tila') }}
                  </button>
                </form>
              {% else %}
                <form method="POST" action="{{ url_for('admin.activate_panic') }}">
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="fa-solid fa-bolt me-1"></i>{{ _('Kytke päälle') }}
                  </button>
                </form>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="health-card">
          <h5 class="mb-3">{{ _('Järjestelmän kunto') }}</h5>
          <div class="health-metric">
            <div class="health-label">
              <span>{{ _('Kirjautumiset onnistui') }}</span>
              <span id="metric-login-success">0%</span>
            </div>
            <div class="progress-bar"><span id="bar-login-success"></span></div>
          </div>
          <div class="health-metric">
            <div class="health-label">
              <span>{{ _('Avoimet tapaukset / kapasiteetti') }}</span>
              <span id="metric-case-load">0%</span>
            </div>
            <div class="progress-bar"><span id="bar-case-load"></span></div>
          </div>
          <div class="health-metric">
            <div class="health-label">
              <span>{{ _('Tapahtumat julkaisuputkessa') }}</span>
              <span id="metric-demo-pending">0%</span>
            </div>
            <div class="progress-bar"><span id="bar-demo-pending"></span></div>
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <a class="quick-card text-decoration-none text-dark" href="{{ url_for('admin.stats') }}">
          <div>
            <strong>{{ _('Tilastot') }}</strong>
            <div class="text-muted small">{{ _('Ryhdy data-analyysiin') }}</div>
          </div>
          <i class="fa-solid fa-chart-line"></i>
        </a>
        <a class="quick-card text-decoration-none text-dark" href="{{ url_for('admin_user.user_control') }}">
          <div>
            <strong>{{ _('Käyttäjähallinta') }}</strong>
            <div class="text-muted small">{{ _('Roolit ja käyttöoikeudet') }}</div>
          </div>
          <i class="fa-solid fa-users-gear"></i>
        </a>
        <a class="quick-card text-decoration-none text-dark" href="{{ url_for('admin.logs') }}">
          <div>
            <strong>{{ _('Audit-lokit') }}</strong>
            <div class="text-muted small">{{ _('Syvennä tapahtumia') }}</div>
          </div>
          <i class="fa-solid fa-list-check"></i>
        </a>
        <a class="quick-card text-decoration-none text-dark" href="{{ url_for('admin.manual') }}">
          <div>
            <strong>{{ _('Käyttöohje') }}</strong>
            <div class="text-muted small">{{ _('Työkalujen läpikäynti') }}</div>
          </div>
          <i class="fa-solid fa-book"></i>
        </a>
      </div>
    </section>

    <aside class="side-panel card-panel">
      <div class="side-header">
        <div>
          <h5 class="mb-0">{{ _('Kirjautumispäiväkirja') }}</h5>
          <small class="text-muted">{{ _('Päivittyy muutaman sekunnin välein') }}</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" id="refresh-login-feed">
          <i class="fa-solid fa-rotate"></i>
        </button>
      </div>
      <div id="login-feed" class="login-feed">
        <div class="empty-state">{{ _('Ladataan kirjautumisia...') }}</div>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const snapshotEndpoint = "{{ url_for('admin.dashboard_data') }}";
    const loginEndpoint = "{{ url_for('admin.dashboard_login_feed') }}";
    const panicEndpoint = "{{ url_for('admin.panic_status') }}";

    const elements = {
      usersTotal: document.getElementById('stat-users-total'),
      usersConfirmed: document.getElementById('stat-users-confirmed'),
      usersPending: document.getElementById('stat-users-pending'),
      admins: document.getElementById('stat-users-admins'),
      orgs: document.getElementById('stat-orgs-active'),
      demosLive: document.getElementById('stat-demos-live'),
      demosPending: document.getElementById('stat-demos-pending'),
      casesOpen: document.getElementById('stat-cases-open'),
      loginsHour: document.getElementById('stat-logins-hour'),
      loginsDay: document.getElementById('stat-logins-day'),
      loginSuccessText: document.getElementById('stat-logins-success'),
      metricLoginSuccess: document.getElementById('metric-login-success'),
      metricCaseLoad: document.getElementById('metric-case-load'),
      metricDemoPending: document.getElementById('metric-demo-pending'),
      barLoginSuccess: document.getElementById('bar-login-success'),
      barCaseLoad: document.getElementById('bar-case-load'),
      barDemoPending: document.getElementById('bar-demo-pending'),
      updated: document.getElementById('snapshot-updated'),
      panicGrid: document.getElementById('panic-grid'),
      panicState: document.getElementById('panic-state'),
      loginFeed: document.getElementById('login-feed'),
      clock: document.getElementById('helsinki-clock')
    };

    const numberFormat = new Intl.NumberFormat('fi-FI');

    function updatePanicState(active) {
      if (!elements.panicGrid || !elements.panicState) return;
      elements.panicGrid.classList.remove('active', 'safe');
      elements.panicState.classList.remove('active', 'safe');
      if (active) {
        elements.panicGrid.classList.add('active');
        elements.panicState.classList.add('active');
        elements.panicState.textContent = "{{ _('AKTIIVINEN') }}";
      } else {
        elements.panicGrid.classList.add('safe');
        elements.panicState.classList.add('safe');
        elements.panicState.textContent = "{{ _('POIS PÄÄLTÄ') }}";
      }
    }

    function setProgress(elSpan, elLabel, value, max = 100) {
      const percentage = Math.min(Math.max(Math.round((value / max) * 100), 0), 100);
      if (elSpan) elSpan.style.width = `${percentage}%`;
      if (elLabel) elLabel.textContent = `${percentage}%`;
    }

    function applySnapshot(data) {
      const users = data.users || {};
      const demos = data.demos || {};
      const logins = data.logins || {};
      const cases = data.cases || {};

      elements.usersTotal.textContent = numberFormat.format(users.total || 0);
      elements.usersConfirmed.textContent = numberFormat.format(users.confirmed || 0);
      elements.usersPending.textContent = numberFormat.format(users.pending || 0);
      elements.admins.textContent = numberFormat.format(users.admins || 0);
      elements.orgs.textContent = numberFormat.format((data.organizations || {}).active || 0);
      elements.demosLive.textContent = numberFormat.format(demos.live || 0);
      elements.demosPending.textContent = numberFormat.format(demos.pending || 0);
      elements.casesOpen.textContent = numberFormat.format(cases.open || 0);
      elements.loginsHour.textContent = numberFormat.format(logins.last_hour || 0);
      elements.loginsDay.textContent = numberFormat.format(logins.last_day || 0);

      const successRate = logins.success_rate || 0;
      elements.loginSuccessText.textContent = `${successRate}%`;
      setProgress(elements.barLoginSuccess, elements.metricLoginSuccess, successRate);

      // Approximate workload percentages
      setProgress(elements.barCaseLoad, elements.metricCaseLoad, cases.open || 0, 50);
      setProgress(elements.barDemoPending, elements.metricDemoPending, demos.pending || 0, Math.max(demos.live || 1, demos.pending || 1));

      if (data.generated_at) {
        const ts = new Date(data.generated_at);
        if (!isNaN(ts)) {
          elements.updated.textContent = ts.toLocaleTimeString('fi-FI', { hour12: false });
        }
      }

      updatePanicState(Boolean(data.panic_mode));
    }

    async function refreshSnapshot() {
      try {
        const res = await fetch(snapshotEndpoint);
        if (!res.ok) throw new Error('Snapshot request failed');
        const data = await res.json();
        applySnapshot(data);
      } catch (err) {
        console.error(err);
      }
    }

    const minuteLabel = "{{ _('min') }}";

    function renderLoginFeed(items) {
      if (!elements.loginFeed) return;
      if (!items.length) {
        elements.loginFeed.innerHTML = `<div class="empty-state">{{ _('Ei kirjautumisia vielä.') }}</div>`;
        return;
      }

      const html = items.map(item => {
        const time = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('fi-FI', { hour12: false }) : '—';
        const reason = item.reason ? `<div class="text-danger small"><i class="fa-solid fa-circle-exclamation me-1"></i>${item.reason}</div>` : '';
        return `
          <div class="login-entry ${item.success ? 'success' : 'failure'}">
            <div class="entry-heading">
              <strong>${item.username}</strong>
              <span class="status-pill ${item.success ? 'success' : 'failure'}">${item.success ? "{{ _('onnistui') }}" : "{{ _('epäonnistui') }}"}</span>
            </div>
            <div class="entry-meta">
              <div><i class="fa-regular fa-clock me-1"></i>${time}${item.minutes_ago != null ? ` · ${item.minutes_ago} ${minuteLabel}` : ''}</div>
              <div><i class="fa-solid fa-network-wired me-1"></i>${item.ip}</div>
              ${item.user_agent ? `<div><i class="fa-solid fa-laptop-code me-1"></i>${item.user_agent}</div>` : ''}
              ${reason}
            </div>
          </div>
        `;
      }).join('');

      elements.loginFeed.innerHTML = html;
    }

    async function refreshLoginFeed() {
      try {
        const res = await fetch(loginEndpoint + '?limit=25');
        if (!res.ok) throw new Error('Login feed failed');
        const data = await res.json();
        renderLoginFeed(data.logs || []);
      } catch (err) {
        console.error(err);
      }
    }

    async function refreshPanicStatus() {
      try {
        const res = await fetch(panicEndpoint);
        if (res.ok) {
          const data = await res.json();
          updatePanicState(Boolean(data.panic_mode));
        }
      } catch (err) {
        // ignore quick failure
      }
    }

    function startClock() {
      if (!elements.clock) return;
      const formatter = new Intl.DateTimeFormat('fi-FI', {
        timeZone: 'Europe/Helsinki',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
      });
      const tick = () => {
        elements.clock.textContent = formatter.format(new Date());
      };
      tick();
      setInterval(tick, 1000);
    }

    const manualRefreshBtn = document.getElementById('refresh-login-feed');
    if (manualRefreshBtn) {
      manualRefreshBtn.addEventListener('click', refreshLoginFeed);
    }

    refreshSnapshot();
    refreshLoginFeed();
    startClock();

    setInterval(refreshSnapshot, 15000);
    setInterval(refreshLoginFeed, 8000);
    setInterval(refreshPanicStatus, 20000);
  });
</script>
{% endblock %}
