{% extends 'admin_base.html' %} {% block styles %}

<style>
  .search-and-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
    align-items: flex-start;
  }

  .search-bar {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0.75rem;
    align-items: center;
    max-width: 460px;
    width: 100%;
    flex: 1 1 320px;
    padding: 0.9rem 1.1rem;
    border-radius: 16px;
    background: light-dark(#f8f9fb, #1f232f);
    border: 1px solid light-dark(#d6dce8, rgba(255,255,255,0.08));
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
  }

  .search-icon {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    color: light-dark(#4c5d7a, #b1b7c6);
    background: light-dark(#e9edf6, rgba(255,255,255,0.06));
    border: 1px solid light-dark(#d4daec, rgba(255,255,255,0.08));
  }

  .search-input {
    border: none;
    background: transparent;
    font-size: 1rem;
    color: light-dark(#111827, #f4f6ff);
    padding: 0;
  }

  .search-input::placeholder {
    color: light-dark(#9097a9, #7f879b);
  }

  .search-input:focus {
    outline: none;
  }

  .search-button {
    border: none;
    border-radius: 12px;
    padding: 0.65rem 1.3rem;
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    box-shadow: 0 15px 25px rgba(37, 99, 235, 0.35);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .search-button i {
    font-size: 0.9rem;
  }

  .search-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 18px 28px rgba(37, 99, 235, 0.45);
  }

  .filter-select {
    border-radius: 12px;
    border: 1px solid light-dark(#d2d8e5, rgba(255,255,255,0.12));
    background: light-dark(#ffffff, #1d2533);
    color: light-dark(#111827, #f3f4ff);
    padding: 0.55rem 0.9rem;
    min-width: 110px;
    transition: border 0.15s ease, box-shadow 0.15s ease;
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
  }

  .filter-select:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 12px 26px rgba(37, 99, 235, 0.18);
  }

  .filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-start;
    flex: 2 1 420px;
  }

  .filter-field {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    min-width: 190px;
    flex: 1 1 200px;
  }

  .filter-field label {
    font-weight: 500;
    color: light-dark(#1f2937, #e5e7f4);
  }

  .actions-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-field label {
    font-weight: 500;
    color: light-dark(#1f2937, #e5e7f4);
  }

  .modal-dark {
    background-color: light-dark(#fff, #1e1e2f);
    color: light-dark(#000, #eee);
    border-color: light-dark(#ccc, #444);
  }

  .modal-dark .modal-header,
  .modal-dark .modal-footer {
    background-color: light-dark(#f8f9fa, #2a2a3d);
    border-color: light-dark(#ccc, #444);
    color: light-dark(#000, #eee);
  }

  .modal-dark .btn-close {
    filter: none;
    /* reset if needed */
  }

  .modal-dark .btn-danger {
    background-color: light-dark(#dc3545, #e03e3e);
    border-color: light-dark(#b02a37, #b32b2b);
  }

  .modal-dark .btn-danger:hover {
    background-color: light-dark(#c82333, #c32b2b);
    border-color: light-dark(#a71d2a, #912020);
  }

  .modal-dark .btn-secondary {
    color: light-dark(#6c757d, #ccc);
    border-color: light-dark(#6c757d, #666);
  }

  .modal-dark .btn-secondary:hover {
    background-color: light-dark(#e2e6ea, #444);
    color: light-dark(#000, #fff);
  }

  /* smooth fade/slide when a row is removed */
  tr.fade‑out {
    opacity: 0;
    height: 0;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    transition: opacity 2s ease, height 2s ease, padding 2s ease;
  }

  /* --------------------------------------------------
   Section headers that fit the current dashboard style
-------------------------------------------------- */

.section-header td {
    padding: 0.6rem 1rem;
    font-weight: 600;
    font-size: 0.95rem;
    border-radius: 6px;

    /* Accent strip on left */
    border-left: 4px solid var(--bs-info);

    /* Light/Dark adaptive background */
    background-color: light-dark(#f2f4f7, #2a2d33);
    color: light-dark(#222, #e5e5e5);

    /* Slight top separation */
    border-top: 1px solid light-dark(#d0d0d0, #3a3a3a);
    margin-top: 6px;
}

/* Approved header gets a neutral accent */
.section-header.approved td {
    border-left-color: var(--bs-success);
}


/* --------------------------------------------------
   Needs-attention row (pending approvals)
-------------------------------------------------- */

.needs-attention {
    background-color: light-dark(
        rgba(255, 220, 220, 0.45),
        rgba(120, 50, 50, 0.25)
    );
}

.needs-attention:hover {
    background-color: light-dark(
        rgba(255, 220, 220, 0.55),
        rgba(130, 60, 60, 0.32)
    );
}


/* --------------------------------------------------
   Table row hover improvements (subtle)
-------------------------------------------------- */

.table-container table tbody tr {
    transition: background-color 0.18s ease;
}

.table-container table tbody tr:hover {
    background-color: light-dark(
        rgba(0, 0, 0, 0.04),
        rgba(255, 255, 255, 0.04)
    );
}


/* --------------------------------------------------
   Dropdown + buttons (subtle rounding only)
-------------------------------------------------- */

.dropdown-menu {
    border-radius: 8px;
}

.dropdown-item {
    border-radius: 4px;
}

.dropdown-item:hover {
    background-color: light-dark(
        rgba(0, 0, 0, 0.08),
        rgba(255, 255, 255, 0.08)
    );
}


/* --------------------------------------------------
   Status icons (professional but readable)
-------------------------------------------------- */

.fa-check-circle {
    color: var(--bs-success);
}

.fa-times-circle {
    color: var(--bs-danger);
}


/* --------------------------------------------------
   Dropdown Menu Styling
-------------------------------------------------- */

/* Dropdown container */
.dropdown-menu {
    border-radius: 8px;
    background-color: light-dark(#ffffff, #1f1f28);
    border: 1px solid light-dark(#dcdcdc, #2c2c36);
    padding: 0.25rem;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

/* Items */
.dropdown-item {
    border-radius: 6px;
    padding: 0.45rem 0.75rem;
    transition: background-color 0.12s ease, color 0.12s ease, padding-left 0.12s ease;
    color: light-dark(#333, #ddd);
}

/* Hover */
.dropdown-item:hover {
    background-color: light-dark(
        rgba(0, 0, 0, 0.06),
        rgba(255, 255, 255, 0.09)
    );
    padding-left: 0.95rem; /* subtle slide effect */
}

/* Active/pressed */
.dropdown-item:active {
    background-color: light-dark(
        rgba(0, 0, 0, 0.12),
        rgba(255, 255, 255, 0.16)
    );
}

/* Disabled */
.dropdown-item.disabled,
.dropdown-item:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Divider consistency */
.dropdown-divider {
    border-color: light-dark(#ddd, #333);
}

/* Text-danger items */
.dropdown-item.text-danger:hover {
    background-color: light-dark(
        rgba(255, 0, 0, 0.12),
        rgba(255, 60, 60, 0.12)
    );
    color: light-dark(#b00020, #ff6b6b);
}

</style>
{% endblock %} {% block scripts %}
<!--<script src="{{ url_for('static', filename='js/deleteModal.js' )}}"></script>-->
<script>
  function acceptSty(demoId) {
    demo = document.getElementById(`demo-${demoId}`);

    demo.children[4].innerText = "{{ _('Kyllä') }}";

    demo.children[5].children[0].remove();

    demo.classList.remove("needs-attention");
  }

  function acceptDemo(demoId) {
    fetch(`/admin/demo/accept_demo/${demoId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({}), // You can add additional data here if needed,
      redirect: "manual",
    })
      .then((response) => response.json())
      .then((data) => {

        if (data.status === "OK") {
          showToast("{{ _('Mielenosoitus hyväksytty onnistuneesti!') }}", 'success');
          acceptSty(demoId);
        } else {
          // Handle error (e.g., show a flash message)
          console.error("Error fetching submitter info:", data.message);
          showToast("{{ _('Virhe hyväksyttäessä mielenosoitusta.') }}", 'danger');
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showToast("{{ _('Yhteysvirhe, yritä uudelleen.') }}", 'danger');
      });
  }


</script>

{% endblock %} {% block main_content %}



<section class="dashboard-container">
  <!-- Intro card -->
  <div class="introduction">
    <h1 id="tabletitle">{{ _('Mielenosoitukset') }}</h1>
    <p class="muted">
      {{ _('Täältä voit hallita mielenosoituksia, joihin sinulla on käyttöoikeus.') }}<br>
      {{ _('Lisätietoja hallinnoimisesta löydät hallinnoijan käsikirjasta, kappaleesta 3.1: Mielenosoitusten
      hallintapaneeli, etusivu.') }}
    </p>
  </div>

  <div class="dashboard-panel">

    <div class="flex justify-center mb-4">
      {% if current_user.has_permission("CREATE_DEMO") %}
      <a href="{{ url_for('admin_demo.create_demo') }}" class="btn new-item">
        <i class="fas fa-plus"></i>{{ _('Uusi mielenosoitus') }}
      </a>
      {% else %}
      <a class="non-suffperm" data-tooltip="Ei käyttöoikeutta">
        <i class="fas fa-ban"></i>{{ _('Uusi mielenosoitus') }}
      </a>
      {% endif %}

      {% if current_user.has_permission("CREATE_RECURRING_DEMO") %}
      <a href="{{ url_for('admin_recu_demo.create_recu_demo') }}" class="btn new-item">
        <i class="fas fa-plus-circle"></i>{{ _('Uusi toistuva mielenosoitus') }}
      </a>
      {% else %}
      <a class="non-suffperm" data-tooltip="Ei käyttöoikeutta">
        <i class="fas fa-ban"></i>{{ _('Uusi toistuva mielenosoitus') }}
      </a>
      {% endif %}
    </div>


    <div class="search-and-filter">
      <!-- Client-side search bar -->
      <div class="search-bar">
        <div class="search-icon">
          <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <input type="search" id="search" class="search-input" placeholder="{{ _('Hae mielenosoituksia...') }}"
          aria-label="{{ _('Hae mielenosoituksia') }}" value="{{ search_query }}">
        <button type="button" id="search-btn" class="search-button">
          <i class="fa-solid fa-arrow-right"></i><span>{{ _('Hae') }}</span>
        </button>
      </div>

      <!-- Server-side filters -->
      <form method="GET" action="{{ url_for('admin_demo.demo_control') }}" class="filter-form" id="dashboard-filter-form">
        <input type="hidden" name="search" id="filter-search-hidden" value="{{ search_query }}">
        <div class="filter-field">
          <label for="approved">{{ _('Näytä vain hyväksytyt mielenosoitukset:') }}</label>
          <select name="approved" id="approved" class="filter-select" onchange="this.form.submit()">
            <option value="true" {% if approved_status %}selected{% endif %}>{{ _('Kyllä') }}</option>
            <option value="false" {% if not approved_status %}selected{% endif %}>{{ _('Ei') }}</option>
          </select>
        </div>

        <div class="filter-field">
          <label for="show_past">{{ _('Näytä menneet mielenosoitukset:') }}</label>
          <select name="show_past" id="show_past" class="filter-select" onchange="this.form.submit()">
            <option value="all" {% if show_past_filter=='all' %}selected{% endif %}>{{ _('Kaikki') }}</option>
            <option value="false" {% if show_past_filter=='false' %}selected{% endif %}>{{ _('Ei') }}</option>
            <option value="true" {% if show_past_filter=='true' %}selected{% endif %}>{{ _('Kyllä') }}</option>
          </select>
        </div>

        <div class="filter-field">
          <label for="show_hidden">{{ _('Näytä piilotetut mielenosoitukset:') }}</label>
          <select name="show_hidden" id="show_hidden" class="filter-select" onchange="this.form.submit()">
            <option value="false" {% if not show_hidden %}selected{% endif %}>{{ _('Ei') }}</option>
            <option value="true" {% if show_hidden %}selected{% endif %}>{{ _('Kyllä') }}</option>
          </select>
        </div>

        <div class="filter-field">
          <label for="show_cancelled">{{ _('Näytä perutut mielenosoitukset:') }}</label>
          <select name="show_cancelled" id="show_cancelled" class="filter-select" onchange="this.form.submit()">
            <option value="false" {% if not show_cancelled %}selected{% endif %}>{{ _('Ei') }}</option>
            <option value="true" {% if show_cancelled %}selected{% endif %}>{{ _('Kyllä') }}</option>
          </select>
        </div>
      </form>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search');
        const searchButton = document.getElementById('search-btn');
        const filterForm = document.getElementById('dashboard-filter-form');
        const filterSearchHidden = document.getElementById('filter-search-hidden');
        if (!searchInput || !searchButton) return;

        const dataRows = Array.from(document.querySelectorAll('tr[data-search-row="true"]'));
        const sectionHeaders = Array.from(document.querySelectorAll('tr.section-header'));

        const updateSectionHeaders = () => {
          sectionHeaders.forEach(header => {
            let hasVisible = false;
            let next = header.nextElementSibling;
            while (next && !next.classList.contains('section-header')) {
              if (!next.classList.contains('d-none')) {
                hasVisible = true;
                break;
              }
              next = next.nextElementSibling;
            }
            header.classList.toggle('d-none', !hasVisible);
          });
        };

        const syncHiddenSearch = () => {
          if (filterSearchHidden) {
            filterSearchHidden.value = searchInput.value || '';
          }
        };

        const applyLocalSearch = term => {
          const normalized = term.trim().toLowerCase();
          dataRows.forEach(row => {
            const haystack = row.getAttribute('data-search-text') || row.textContent.toLowerCase();
            const match = !normalized || haystack.includes(normalized);
            row.classList.toggle('d-none', !match);
          });
          updateSectionHeaders();
        };

        const commitSearch = () => {
          const normalized = (searchInput.value || '').trim();
          const url = new URL(window.location.href);
          if (normalized) {
            url.searchParams.set('search', normalized);
          } else {
            url.searchParams.delete('search');
          }
          window.location.href = url.toString();
        };

        searchInput.addEventListener('input', () => {
          applyLocalSearch(searchInput.value || '');
          syncHiddenSearch();
        });

        searchInput.addEventListener('keydown', event => {
          if (event.key === 'Enter') {
            event.preventDefault();
            commitSearch();
          }
        });

        searchButton.addEventListener('click', () => {
          commitSearch();
        });

        if (filterForm) {
          filterForm.addEventListener('submit', () => {
            syncHiddenSearch();
          });
        }

        applyLocalSearch(searchInput.value || '');
      });
    </script>
    {% if current_user.has_permission("EDIT_DEMO") %}
    <div class="bulk-action-bar mt-3">
      <button type="button" id="bulk-cancel-btn" class="btn btn-danger" disabled>
        <i class="fa-solid fa-ban me-1"></i>{{ _('Peruuta valitut mielenosoitukset') }}
      </button>
      <button type="button" id="merge-demos-btn" class="btn btn-outline-primary ms-2" disabled>
        <i class="fa-solid fa-object-group me-1"></i>{{ _('Yhdistä valitut mielenosoitukset') }}
      </button>
      <span id="bulk-action-feedback" class="text-muted ms-3 d-none"></span>
    </div>
    {% endif %}

  </div>

  <!-- Demonstrations table -->
  {% if demonstrations %}
  {% set column_count = 6
      + (1 if current_user.has_permission("EDIT_DEMO") else 0)
      + (1 if show_cancelled else 0) %}
  <div class="table-container" style="background:none;">
    <table>
      <thead>
        <tr>
          {% if current_user.has_permission("EDIT_DEMO") %}
          <th class="select-col">
            <input type="checkbox" id="select-all-demos" aria-label="{{ _('Valitse kaikki mielenosoitukset') }}">
          </th>
          {% endif %}
          <th>{{ _('Otsikko') }}</th>
          <th>{{ _('Kaupunki') }}</th>
          <th>{{ _('Päivämäärä') }}</th>
          <th>{{ _('Toistuva') }}</th>
          <th>{{ _('Hyväksytty') }}</th>
          {% if show_cancelled %}
          <th>{{ _('Peruttu') }}</th>
          {% endif %}
          <th class="actions-cell-header">{{ _('Toiminnot') }}</th>
        </tr>
      </thead>
      <tbody>

{# Split demos into clean groups #}
{% set pending = demonstrations|selectattr('approved', 'equalto', False)|list %}
{% set approved = demonstrations|selectattr('approved', 'equalto', True)|list %}

{# ----------------------------- #
   PENDING SECTION
   ----------------------------- #}
{% if pending %}
<tr class="section-header">
    <td colspan="{{ column_count }}"><strong>{{ _('Odottaa hyväksyntää') }}</strong></td>
</tr>

{% for demo in pending %}
<tr id="demo-{{ demo._id }}" class="needs-attention" data-search-row="true" data-search-text="{{ (demo.title ~ ' ' ~ demo.city ~ ' ' ~ demo.date ~ ' ' ~ (demo.address or ''))|lower }}">

    {% if current_user.has_permission("EDIT_DEMO") %}
    <td class="select-col">
        <input type="checkbox" class="demo-select form-check-input" value="{{ demo._id }}" data-demo-id="{{ demo._id }}" aria-label="{{ _('Valitse mielenosoitus') }}">
    </td>
    {% endif %}

    <td>{{ demo.title }}</td>
    <td>{{ demo.city }}</td>
    <td>{{ demo.date }}</td>

    <td>
        {% if demo.recurs %}
            <i class="fa-solid fa-check-circle"></i> {{ _('Kyllä') }}
        {% else %}
            <i class="fa-solid fa-times-circle"></i> {{ _('Ei') }}
        {% endif %}
    </td>

    <td data-col="approved">
        <i class="fa-solid fa-times-circle"></i> {{ _('Ei') }}
    </td>

    {% if show_cancelled %}
    <td>
        {% if demo.cancelled %}
            <span class="badge bg-danger">{{ _('Peruttu') }}</span>
            {% if demo.cancelled_at %}
                <div class="text-muted small">{{ demo.cancelled_at }}</div>
            {% endif %}
        {% else %}
            <span class="text-muted">-</span>
        {% endif %}
    </td>
    {% endif %}

    <td class="actions-cell">
        <div class="d-flex align-items-center gap-2">
            {% if current_user.has_permission("VIEW_DEMO") %}
            <a class="btn btn-sm btn-outline-primary command-center-btn"
               href="{{ url_for('admin_demo.demo_command_center', demo_id=demo._id) }}"
               title="{{ _('Hallintanäkymä') }}">
                <i class="fa-solid fa-table-columns"></i>
                <span class="visually-hidden">{{ _('Hallintanäkymä') }}</span>
            </a>
            {% endif %}
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                        id="actionsDropdown-approved-{{ demo._id }}" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-ellipsis-vertical"></i> {{ _('Toiminnot') }}
                </button>

            <ul class="dropdown-menu" aria-labelledby="actionsDropdown-{{ demo._id }}">

                {# Accept #}
                {% if not demo.approved %}
                  {% if current_user.has_permission("ACCEPT_DEMO") %}
                      <li><button class="dropdown-item" type="button"
                                  onclick="acceptDemo('{{ demo._id }}')">
                          <i class="fa-solid fa-check me-2"></i>{{ _('Hyväksy') }}
                      </button></li>
                  {% else %}
                      <li><span class="dropdown-item disabled">
                          <i class="fa-solid fa-check me-2"></i>{{ _('Hyväksy') }}
                      </span></li>
                  {% endif %}
                {% endif %}

                {# Recommend toggle #}
                {% if current_user.global_admin %}
                    {% if demo.is_recommended %}
                        <li><button class="dropdown-item" type="button"
                                    onclick="toggleRecommendation('{{ demo._id }}', this, true)">
                            <i class="fa-solid fa-star-half-stroke me-2"></i>{{ _('Poista suositus') }}
                        </button></li>
                    {% else %}
                        <li><button class="dropdown-item" type="button"
                                    onclick="toggleRecommendation('{{ demo._id }}', this, false)">
                            <i class="fa-solid fa-star me-2"></i>{{ _('Suosittele') }}
                        </button></li>
                    {% endif %}
                {% endif %}

                {# Edit #}
                {% if current_user.has_permission("EDIT_DEMO") %}
                    <li><a class="dropdown-item"
                           href="{{ url_for('admin_demo.edit_demo', demo_id=demo._id) }}">
                        <i class="fas fa-edit me-2"></i>{{ _('Muokkaa') }}
                    </a></li>
                {% endif %}

                {# View #}
                {% if current_user.has_permission("VIEW_DEMO") %}
                    <li><a class="dropdown-item"
                           href="{{ url_for('demonstration_detail', demo_id=demo._id) }}">
                        <i class="fa-solid fa-eye me-2"></i>{{ _('Katsele') }}
                    </a></li>

                    <li><button class="dropdown-item" type="button"
                                onclick="showSubmitterInfoModal('{{ demo._id }}')">
                        <i class="fa-solid fa-user me-2"></i>{{ _('Ilmoittaja') }}
                    </button></li>
                {% endif %}

                {# Screenshot + Freeze #}
                {% if current_user.has_permission("CREATE_DEMO") %}
                    <li><button class="dropdown-item" type="button"
                                onclick="triggerScreenshot('{{ demo._id }}', this)">
                        <i class="fas fa-camera me-2"></i>{{ _('Luo esikatselukuva') }}
                    </button></li>

                    <li><button class="dropdown-item" type="button"
                                data-bs-toggle="modal" data-bs-target="#freezeModal"
                                onclick="openFreezeModal('{{ demo._id }}')">
                        <i class="fas fa-snowflake me-2"></i>Jäädytys
                        <span class="text-muted">(vain toistuville)</span>
                    </button></li>
                {% endif %}

                {# Edit history #}
                <li><a class="dropdown-item"
                       href="{{ url_for('admin_demo.demo_edit_history', demo_id=demo._id) }}">
                    <i class="fa-solid fa-history me-2"></i>{{ _('Muokkaushistoria') }}
                </a></li>

                <li><a class="dropdown-item"
                       href="{{ url_for('admin_demo.view_demo_audit_log', demo_id=demo._id) }}">
                    <i class="fa-solid fa-clipboard-list me-2"></i>{{ _('Audit-loki') }}
                </a></li>

                {# Delete #}
                {% if current_user.has_permission("DELETE_DEMO") %}
                    <li><button class="dropdown-item text-danger" type="button"
                                onclick="openModal(event, '{{ demo.title }}', '{{ demo._id }}')">
                        <i class="fas fa-trash-alt me-2"></i>{{ _('Poista') }}
                    </button></li>
                {% else %}
                    <li><span class="dropdown-item disabled">
                        <i class="fas fa-ban me-2"></i>{{ _('Poista') }}
                    </span></li>
                {% endif %}

            </ul>
        </div>
    </td>

</tr>
{% endfor %}
{% endif %}

{# ----------------------------- #
   APPROVED SECTION
   ----------------------------- #}
{% if approved %}
<tr class="section-header approved">
    <td colspan="{{ column_count }}"><strong>{{ _('Hyväksytyt mielenosoitukset') }}</strong></td>
</tr>

{% for demo in approved %}
<tr id="demo-{{ demo._id }}" data-search-row="true" data-search-text="{{ (demo.title ~ ' ' ~ demo.city ~ ' ' ~ demo.date ~ ' ' ~ (demo.address or ''))|lower }}">

    {% if current_user.has_permission("EDIT_DEMO") %}
    <td class="select-col">
        <input type="checkbox" class="demo-select form-check-input" value="{{ demo._id }}" data-demo-id="{{ demo._id }}" aria-label="{{ _('Valitse mielenosoitus') }}">
    </td>
    {% endif %}

    <td>{{ demo.title }}</td>
    <td>{{ demo.city }}</td>
    <td>{{ demo.date }}</td>

    <td>
        {% if demo.recurs %}
            <i class="fa-solid fa-check-circle"></i> {{ _('Kyllä') }}
        {% else %}
            <i class="fa-solid fa-times-circle"></i> {{ _('Ei') }}
        {% endif %}
    </td>

    <td data-col="approved">
        <i class="fa-solid fa-check-circle"></i> {{ _('Kyllä') }}
    </td>

    {% if show_cancelled %}
    <td>
        {% if demo.cancelled %}
            <span class="badge bg-danger">{{ _('Peruttu') }}</span>
            {% if demo.cancelled_at %}
                <div class="text-muted small">{{ demo.cancelled_at }}</div>
            {% endif %}
        {% else %}
            <span class="text-muted">-</span>
        {% endif %}
    </td>
    {% endif %}

    <td class="actions-cell">
        {% if current_user.has_permission("VIEW_DEMO") %}
        <a class="btn btn-sm btn-outline-primary me-2 command-center-btn"
           href="{{ url_for('admin_demo.demo_command_center', demo_id=demo._id) }}"
           title="{{ _('Hallintanäkymä') }}">
            <i class="fa-solid fa-table-columns"></i>
            <span class="visually-hidden">{{ _('Hallintanäkymä') }}</span>
        </a>
        {% endif %}
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                    id="actionsDropdown-{{ demo._id }}" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-ellipsis-vertical"></i> {{ _('Toiminnot') }}
            </button>

            <ul class="dropdown-menu" aria-labelledby="actionsDropdown-{{ demo._id }}">

                {# Recommend toggle #}
                {% if current_user.global_admin %}
                    {% if demo.is_recommended %}
                        <li><button class="dropdown-item" type="button"
                                    onclick="toggleRecommendation('{{ demo._id }}', this, true)">
                            <i class="fa-solid fa-star-half-stroke me-2"></i>{{ _('Poista suositus') }}
                        </button></li>
                    {% else %}
                        <li><button class="dropdown-item" type="button"
                                    onclick="toggleRecommendation('{{ demo._id }}', this, false)">
                            <i class="fa-solid fa-star me-2"></i>{{ _('Suosittele') }}
                        </button></li>
                    {% endif %}
                {% endif %}

                {# Edit #}
                {% if current_user.has_permission("EDIT_DEMO") %}
                    <li><a class="dropdown-item"
                           href="{{ url_for('admin_demo.edit_demo', demo_id=demo._id) }}">
                        <i class="fas fa-edit me-2"></i>{{ _('Muokkaa') }}
                    </a></li>
                {% endif %}

                {# View #}
                {% if current_user.has_permission("VIEW_DEMO") %}
                    <li><a class="dropdown-item"
                           href="{{ url_for('demonstration_detail', demo_id=demo._id) }}">
                        <i class="fa-solid fa-eye me-2"></i>{{ _('Katsele') }}
                    </a></li>

                    <li><button class="dropdown-item" type="button"
                                onclick="showSubmitterInfoModal('{{ demo._id }}')">
                        <i class="fa-solid fa-user me-2"></i>{{ _('Ilmoittaja') }}
                    </button></li>
                {% endif %}

                {# Screenshot + Freeze #}
                {% if current_user.has_permission("CREATE_DEMO") %}
                    <li><button class="dropdown-item" type="button"
                                onclick="triggerScreenshot('{{ demo._id }}', this)">
                        <i class="fas fa-camera me-2"></i>{{ _('Luo esikatselukuva') }}
                    </button></li>

                    <li><button class="dropdown-item" type="button"
                                data-bs-toggle="modal" data-bs-target="#freezeModal"
                                onclick="openFreezeModal('{{ demo._id }}')">
                        <i class="fas fa-snowflake me-2"></i>Jäädytys
                        <span class="text-muted">(vain toistuville)</span>
                    </button></li>
                {% endif %}

                {# Edit history #}
                <li><a class="dropdown-item"
                       href="{{ url_for('admin_demo.demo_edit_history', demo_id=demo._id) }}">
                    <i class="fa-solid fa-history me-2"></i>{{ _('Muokkaushistoria') }}
                </a></li>

                <li><a class="dropdown-item"
                       href="{{ url_for('admin_demo.view_demo_audit_log', demo_id=demo._id) }}">
                    <i class="fa-solid fa-clipboard-list me-2"></i>{{ _('Audit-loki') }}
                </a></li>

                {# Delete #}
                {% if current_user.has_permission("DELETE_DEMO") %}
                    <li><button class="dropdown-item text-danger" type="button"
                                onclick="openModal(event, '{{ demo.title }}', '{{ demo._id }}')">
                        <i class="fas fa-trash-alt me-2"></i>{{ _('Poista') }}
                    </button></li>
                {% else %}
                    <li><span class="dropdown-item disabled">
                        <i class="fas fa-ban me-2"></i>{{ _('Poista') }}
                    </span></li>
                {% endif %}

            </ul>
        </div>
    </td>

</tr>
{% endfor %}
{% endif %}

</tbody>

    </table>
    <nav aria-label="Stats pagination">
      <ul class="pagination justify-content-center">

        {# Previous button #}
        {% if prev_page %}
        <li class="page-item">
          <a class="page-link" href="?page={{ prev_page }}&per_page={{ per_page }}&search={{ search_query|urlencode }}"
            aria-label="Previous">
            <i class="fas fa-angle-left"></i> {{ _('Edellinen') }}
          </a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link"><i class="fas fa-angle-left"></i> {{ _('Edellinen') }}</span>
        </li>
        {% endif %}

        {# Current page / total pages #}
        <li class="page-item disabled">
          <span class="page-link">{{ _('Sivu') }} {{ current_page }} / {{ total_pages }}</span>
        </li>

        {# Next button #}
        {% if next_page %}
        <li class="page-item">
          <a class="page-link" href="?page={{ next_page }}&per_page={{ per_page }}&search={{ search_query|urlencode }}"
            aria-label="Next">
            {{ _('Seuraava') }} <i class="fas fa-angle-right"></i>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">{{ _('Seuraava') }} <i class="fas fa-angle-right"></i></span>
        </li>
        {% endif %}

      </ul>
    </nav>


  </div>
  {% else %}
  <div class="no-results">
    <i class="fa-solid fa-circle-exclamation"></i> {{ _('Ei mielenosoituksia löytynyt.') }}
  </div>
  {% endif %}
  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" id="deleteModalContent">
        <div class="modal-header">
          <h5 class="modal-title text-danger" id="deleteModalLabel">
            <i class="fa-solid fa-circle-exclamation me-2"></i> {{ _('Poista mielenosoitus') }}
          </h5>
          <button type="button" class="btn-close" aria-label="{{ _('Sulje') }}" id="deleteModalCloseBtn"></button>
        </div>
        <div class="modal-body">
          {{ _('Oletko varma, että haluat poistaa mielenosoituksen') }}
          <strong id="demoTitle"></strong>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="confirmDelete">{{ _('Kyllä, poista') }}</button>
          <button type="button" class="btn btn-secondary" id="cancelDelete">{{ _('Peruuta') }}</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Submitter Info Modal -->
  <div class="modal fade" id="submitterInfoModal" tabindex="-1" aria-labelledby="submitterInfoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4" id="submitterInfoModalContent">
        <div class="modal-header bg-info text-white rounded-top-4">
          <h5 class="modal-title" id="submitterInfoLabel">
            <i class="fa-solid fa-user me-2"></i> {{ _('Ilmoittajan tiedot') }}
          </h5>
          <button type="button" class="btn-close btn-close-white" aria-label="{{ _('Sulje') }}"
            id="submitterInfoCloseBtn"></button>
        </div>
        <div class="modal-body p-4 text-center" id="submitter-info-content" style="color: white;">
          <!-- Dynamically filled content -->
          <div id="noSubmitterInfo" class="alert alert-warning d-none">
            <i class="fa-solid fa-circle-exclamation me-2"></i>
            {{ _('Ilmoittajan tietoja ei löytynyt.') }}
          </div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-outline-info btn-lg px-4" id="closeSubmitterInfo">
            {{ _('Sulje') }}
          </button>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('search');
      const searchBtn = document.getElementById('search-btn');
      const rows = document.querySelectorAll('.table-container tbody tr');

      const filterRows = () => {
        const term = searchInput.value.trim().toLowerCase();
        rows.forEach(row => {
          row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
        });
      };

      searchInput.addEventListener('input', filterRows);
      searchBtn.addEventListener('click', filterRows);
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteModalEl = document.getElementById('deleteModal');
      const deleteModal = new bootstrap.Modal(deleteModalEl);
      // Initialize Bootstrap modal once
      const submitterModalEl = document.getElementById('submitterInfoModal');
      const submitterModal = new bootstrap.Modal(submitterModalEl, {
        backdrop: 'static',  // Optional: prevents closing on outside click
        keyboard: false      // Optional: prevents closing with ESC
      });

      // Dark mode toggle for modals (adjust if your dark mode class is on <html> or <body>)
      const isDark = document.body.classList.contains('dark') || document.documentElement.classList.contains('dark');
      if (isDark) {
        deleteModalEl.querySelector('.modal-content').classList.add('modal-dark');
        submitterModalEl.querySelector('.modal-content').classList.add('modal-dark');
      }

      // Fast delete mode flag
      let fastDeleteMode = false;

      function updateDeleteButtonTexts() {
        document.querySelectorAll('.delete-button').forEach(btn => {
          const icon = btn.querySelector('i');
          if (icon) {
            btn.innerHTML = icon.outerHTML + (fastDeleteMode ? ' Pikapoisto' : ' {{ _("Poista") }}');
          } else {
            // fallback if no icon found
            btn.textContent = fastDeleteMode ? 'Pikapoisto' : '{{ _("Poista") }}';
          }
        });
      }


      // Listen Shift key down/up globally
      document.addEventListener('keydown', e => {
        if (e.key === 'Shift') {
          fastDeleteMode = true;
          updateDeleteButtonTexts();
          console.log('Fast delete mode enabled.');
        }
        if (e.key === 'Escape') {
          deleteModal.hide();
          console.log('Modal closed via Escape.');
        }
      });

      document.addEventListener('keyup', e => {
        if (e.key === 'Shift') {
          fastDeleteMode = false;
          updateDeleteButtonTexts();
          console.log('Fast delete mode disabled.');
        }
      });
      // Helper: Animate then remove the row
      function animateAndRemoveRow(rowEl) {
        if (!rowEl) return;
        rowEl.classList.add('fade-out');
        rowEl.addEventListener('transitionend', () => rowEl.remove(), { once: true });
      }
      // Open delete modal or fast-delete immediately if shift pressed
      window.openModal = (event, title, id) => {
        event.preventDefault();



        // Inside your main script:
        if (fastDeleteMode) {
          // Fast delete directly without modal
          fetch("/admin/demo/delete_demo", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ demo_id: id }),
            redirect: 'manual'
          })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'OK') {
                const row = document.getElementById(`demo-${id}`);
                animateAndRemoveRow(row);
                console.log(`Demo ${id} deleted instantly (pikapoisto).`);
              } else {
                alert(data.message || '{{ _("Virhe poistettaessa.") }}');
              }
            })
            .catch(() => alert('{{ _("Yhteysvirhe, yritä uudelleen.") }}'));

          return;
        }


        // Normal modal open flow
        document.getElementById('demoTitle').textContent = title;
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        confirmDeleteBtn.dataset.id = id;
        deleteModal.show();
      };

      // Close delete modal handlers
      document.getElementById('deleteModalCloseBtn').onclick = () => deleteModal.hide();
      document.getElementById('cancelDelete').onclick = () => deleteModal.hide();

      // Confirm delete button (normal modal delete)
      document.getElementById('confirmDelete').addEventListener('click', () => {
        const id = document.getElementById('confirmDelete').dataset.id;
        if (!id) return;

        fetch("/admin/demo/delete_demo", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ demo_id: id }),
          redirect: 'manual'
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'OK') {
              // Remove the row
              const row = document.getElementById(`demo-${id}`);
              if (row) row.remove();
              deleteModal.hide();
            } else {
              alert(data.message || '{{ _("Virhe poistettaessa.") }}');
            }
          })
          .catch(() => alert('{{ _("Yhteysvirhe, yritä uudelleen.") }}'));
      });


      // Show submitter info modal and fetch data
      window.showSubmitterInfoModal = async (demoId) => {
        const content = document.getElementById('submitter-info-content');
        const noInfoAlert = document.getElementById('noSubmitterInfo');

        // Clear previous content
        content.querySelectorAll("p:not(#noSubmitterInfo)").forEach(p => p.remove());
        noInfoAlert.classList.add("d-none");

        try {
          const res = await fetch(`/admin/demo/get_submitter_info/${demoId}`);
          const data = await res.json();

          if (data.status === 'OK' && data.submitter) {
            const s = data.submitter;

            // Dynamically fill the modal
            const name = s.submitter_name || s.name || '{{ _("Ei saatavilla") }}';
            const email = s.submitter_email || s.email || '{{ _("Ei saatavilla") }}';
            const role = s.submitter_role || s.role || '{{ _("Ei saatavilla") }}';
            const accepted = (s.accept_terms === true || s.accept_terms === 'true') ? '{{ _("Kyllä") }}' : '{{ _("Ei") }}';
            const submittedAt = s.submitted_at || '{{ _("Ei saatavilla") }}';

            content.innerHTML = `
                <p><strong>{{ _('Nimi') }}:</strong> ${name}</p>
                <p><strong>{{ _('Sähköposti') }}:</strong> ${email}</p>
                <p><strong>{{ _('Rooli') }}:</strong> ${role}</p>
                <p><strong>{{ _('Hyväksynyt ehdot') }}:</strong> ${accepted}</p>
                <p><strong>{{ _('Ilmoitettu') }}:</strong> ${submittedAt}</p>
            `;
          } else {
            // Show the "no info" alert
            noInfoAlert.classList.remove("d-none");
          }
        } catch (err) {
          console.error("Error fetching submitter info:", err);
          noInfoAlert.textContent = '{{ _("Virhe haettaessa tietoja.") }}';
          noInfoAlert.classList.remove("d-none");
        } finally {
          submitterModal.show();
        }
      };

      // Close modal buttons
      document.getElementById('submitterInfoCloseBtn').onclick = () => submitterModal.hide();
      document.getElementById('closeSubmitterInfo').onclick = () => submitterModal.hide();

      // Initial button text update
      updateDeleteButtonTexts();
    });


    // animateAndRemoveRow is implemented earlier (kept single canonical implementation)


  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bulkBtn = document.getElementById('bulk-cancel-btn');
      const mergeBtn = document.getElementById('merge-demos-btn');
      if (!bulkBtn && !mergeBtn) return;
      const masterCheckbox = document.getElementById('select-all-demos');
      const feedbackEl = document.getElementById('bulk-action-feedback');
      const selected = new Set();
      const selectionLabel = {{ _('Valittuja mielenosoituksia')|tojson }};
      const defaultBulkContent = bulkBtn ? bulkBtn.innerHTML : '';
      const mergeUrlBase = {{ url_for('admin_demo.merge_demos')|tojson }};
      const maxMergeCount = 4;
      const mergeLimitMessage = {{ _('Voit yhdistää kerrallaan enintään %(count)s mielenosoitusta.', count=4)|tojson }};

      const getCheckboxes = () => Array.from(document.querySelectorAll('.demo-select'));

      function updateState() {
        const total = getCheckboxes().length;
        if (bulkBtn) {
          bulkBtn.disabled = selected.size === 0;
        }
        if (mergeBtn) {
          mergeBtn.disabled = selected.size < 2;
        }
        if (feedbackEl) {
          if (selected.size === 0) {
            feedbackEl.textContent = '';
            feedbackEl.classList.add('d-none');
          } else {
            feedbackEl.textContent = selectionLabel + ': ' + selected.size;
            feedbackEl.classList.remove('d-none');
          }
        }
        if (masterCheckbox) {
          if (selected.size === 0) {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = false;
          } else if (selected.size === total) {
            masterCheckbox.checked = true;
            masterCheckbox.indeterminate = false;
          } else {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = true;
          }
        }
      }

      function handleSelection(cb) {
        if (!cb) return;
        if (cb.checked) {
          selected.add(cb.value);
        } else {
          selected.delete(cb.value);
        }
        updateState();
      }

      getCheckboxes().forEach(cb => cb.addEventListener('change', () => handleSelection(cb)));

      if (masterCheckbox) {
        masterCheckbox.addEventListener('change', () => {
          const checkboxes = getCheckboxes();
          checkboxes.forEach(cb => {
            cb.checked = masterCheckbox.checked;
            handleSelection(cb);
          });
        });
      }

      if (bulkBtn) {
        bulkBtn.addEventListener('click', async () => {
          if (selected.size === 0) return;
          const ids = Array.from(selected);
          const reason = prompt({{ _("Syötä peruutuksen syy (valinnainen)")|tojson }});
          if (reason === null) return;
          bulkBtn.disabled = true;
          bulkBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{{ _("Peruutetaan...") }}';
          try {
            const res = await fetch("/api/admin/demo/bulk_cancel", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ demo_ids: ids, reason })
            });
            const data = await res.json();
            const messages = [];
            (data.results || []).forEach(result => {
              const checkbox = document.querySelector(`.demo-select[data-demo-id="${result.demo_id}"]`);
              if (result.status === "cancelled") {
                const row = document.getElementById(`demo-${result.demo_id}`);
                if (row) row.remove();
                selected.delete(result.demo_id);
              } else if (result.message) {
                messages.push(`${result.demo_id}: ${result.message}`);
                if (checkbox) {
                  checkbox.checked = false;
                }
                selected.delete(result.demo_id);
              }
            });
            if (messages.length) {
              alert(messages.join('\n'));
            }
            if (!data.results || data.results.length === 0) {
              alert(data.error || {{ _("Peruutus epäonnistui.")|tojson }});
            }
          } catch (err) {
            console.error(err);
            alert({{ _("Yhteysvirhe, yritä uudelleen.")|tojson }});
          } finally {
            bulkBtn.innerHTML = defaultBulkContent;
            updateState();
          }
        });
      }

      if (mergeBtn) {
        mergeBtn.addEventListener('click', () => {
          if (selected.size < 2) return;
          if (selected.size > maxMergeCount) {
            alert(mergeLimitMessage);
            return;
          }
          const params = new URLSearchParams();
          params.set('ids', Array.from(selected).join(','));
          window.location.href = `${mergeUrlBase}?${params.toString()}`;
        });
      }

      updateState();
    });
  </script>


  <script>
    function toggleRecommendation(demoId, btn, isRecommended) {
      const confirmMsg = isRecommended
        ? "{{ _('Haluatko varmasti poistaa suosituksen?') }}"
        : "{{ _('Haluatko varmasti suositella tätä mielenosoitusta?') }}";
      if (!confirm(confirmMsg)) return;

      btn.disabled = true;
      const url = isRecommended
        ? `/admin/demo/unrecommend_demo/${demoId}`
        : `/admin/demo/recommend_demo/${demoId}`;

      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
        redirect: 'manual'
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'OK' || data.success) {
            if (isRecommended) {
              btn.innerHTML = `<i class="fa-solid fa-star me-2"></i>{{ _('Suosittele') }}`;
              btn.setAttribute('onclick', `toggleRecommendation('${demoId}', this, false)`);
              showToast("{{ _('Suositus poistettu.') }}", 'info');
            } else {
              btn.innerHTML = `<i class="fa-solid fa-star-half-stroke me-2"></i>{{ _('Poista suositus') }}`;
              btn.setAttribute('onclick', `toggleRecommendation('${demoId}', this, true)`);
              showToast("{{ _('Mielenosoitus suositeltu onnistuneesti!') }}", 'success');
            }
          } else {
            showToast(data.message || "{{ _('Virhe suositellessa.') }}", 'danger');
          }
        })
        .catch(() => {
          showToast("{{ _('Yhteysvirhe, yritä uudelleen.') }}", 'danger');
        })
        .finally(() => {
          btn.disabled = false;
        });
    }
  </script>

  <script>
    function triggerScreenshot(demoId, btn) {
      btn.disabled = true;

      fetch(`/admin/demo/trigger_screenshot/${demoId}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'ok') {
            showToast("{{ _('Esikatselukuva luotu!') }}", 'success');
          } else {
            showToast(data.message || "{{ _('Virhe luotaessa esikatselukuvaa.') }}", 'danger');
          }
          btn.disabled = false;
        })
        .catch(err => {
          console.error(err);
          showToast("{{ _('Yhteysvirhe, yritä uudelleen.') }}", 'danger');
          btn.disabled = false;
        });
    }

  </script>

  <!-- Freeze Modal -->
  <div class="modal fade" id="freezeModal" tabindex="-1" aria-labelledby="freezeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header bg-primary text-white rounded-top-4">
          <h5 class="modal-title" id="freezeModalLabel">
            <i class="fa-solid fa-snowflake me-2"></i> Jäädytyksen hallinta
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Sulje"></button>
        </div>
        <div class="modal-body text-center p-4">
          <p id="freezeStatusText" class="mb-4 fs-6 text-muted">Ladataan tila…</p>
          <button id="freezeToggleBtn" class="btn btn-outline-primary btn-lg px-4">
            <!-- JS will fill text -->
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Non-Recurring Modal -->
  <div class="modal fade" id="nonRecurringModal" tabindex="-1" aria-labelledby="nonRecurringModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header bg-warning text-dark rounded-top-4">
          <h5 class="modal-title" id="nonRecurringModalLabel">
            <i class="fa-solid fa-circle-exclamation me-2"></i> Ei toistuva mielenosoitus
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sulje"></button>
        </div>
        <div class="modal-body text-center p-4">
          <p id="nonRecurringStatusText" class="fs-6 text-muted">
            Tämä mielenosoitus ei ole toistuva.
          </p>
        </div>
      </div>
    </div>
  </div>


  <script>
    let currentDemoId = null;
    let isFrozen = false;

    function openFreezeModal(demoId) {
      currentDemoId = demoId;
      document.getElementById('freezeStatusText').innerText = "Ladataan tila…";
      document.getElementById('freezeToggleBtn').disabled = true;

      // Fetch current freeze status
      fetch(`/admin/demo/demo/${demoId}/is_frozen`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "OK") {
            isFrozen = data.is_frozen;
            updateFreezeModal();
          } else {
            if (data.MR_ERROR && data.MR_ERROR == "NO_RECUR") {
              // lets show non-recurring modal
              non_recurringmodal = new bootstrap.Modal(document.getElementById('nonRecurringModal'));
              non_recurringmodal.show();

              // lets hide the other modal
              freezemodal = bootstrap.Modal.getInstance(document.getElementById('freezeModal'));
              freezemodal.hide();


            } else {
              document.getElementById('freezeStatusText').innerText = "Virhe tilan hakemisessa: " + data.message;
            }
          }
        });
    }

    function updateFreezeModal() {
      const statusText = isFrozen ? "Mielenosoitus on jäädytetty." : "Mielenosoitus ei ole jäädytetty.";
      document.getElementById('freezeStatusText').innerText = statusText;

      const btn = document.getElementById('freezeToggleBtn');
      btn.disabled = false;
      btn.innerText = isFrozen ? "Poista jäädytys" : "Jäädytä";
      btn.className = isFrozen ? "btn btn-warning" : "btn btn-primary";
      btn.onclick = () => toggleFreeze(currentDemoId);
    }

    function toggleFreeze(demoId) {
      const url = isFrozen ? `/admin/demo/demo/${demoId}/unfreeze` : `/admin/demo/demo/${demoId}/freeze`;

      fetch(url, { method: "POST" })
        .then(res => res.json())
        .then(data => {
          if (data.status === "OK") {
            isFrozen = !isFrozen;
            updateFreezeModal();
          } else {
            alert("Virhe: " + data.message);
          }
        });
    }
  </script>
  {% endblock %}
