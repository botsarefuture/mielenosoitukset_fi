{% extends "admin_base.html" %}

{% block styles %}
<style>
  .demo-merge-card {
    border: 1px solid light-dark(#e0e0e0, #2d2d3a);
    border-radius: 12px;
    padding: 1rem;
    height: 100%;
  }

  .merge-field-value {
    font-size: 0.9rem;
    color: light-dark(#444, #c9c9d9);
    white-space: pre-wrap;
  }

  .merge-field-value code {
    background-color: rgba(0, 0, 0, 0.04);
    border-radius: 4px;
    padding: 0.1rem 0.35rem;
  }

  .accordion-button:not(.collapsed) {
    background-color: rgba(13,110,253,.08);
  }

  .guided-plan-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  .guided-plan-list li + li {
    margin-top: 0.35rem;
  }

  [data-manual-section] {
    display: none;
  }

  .manual-mode-active [data-manual-section] {
    display: block;
  }
</style>
{% endblock %}

{% macro render_field_value(demo, field) -%}
  {% set value = demo.get(field.key) %}
  {% if value is none or value == [] or value == '' %}
    <span class="text-muted">—</span>
  {% elif field.type == "list" %}
    {{ value | join(", ") }}
  {% elif field.type == "organizers" %}
    {% set names = [] %}
    {% for org in value %}
      {% if org is mapping %}
        {% set _ = names.append(org.get("name") or org.get("organization_name") or org.get("title")) %}
      {% else %}
        {% set _ = names.append(org) %}
      {% endif %}
    {% endfor %}
    {{ names | reject("equalto", None) | list | join(", ") }}
  {% elif field.type == "bool" %}
    {% if value %}{{ _('Kyllä') }}{% else %}{{ _('Ei') }}{% endif %}
  {% elif field.type == "objectid" %}
    <code>{{ value }}</code>
  {% elif field.type == "longtext" %}
    {{ value | truncate(160, True, "...") }}
  {% else %}
    {{ value }}
  {% endif %}
{%- endmacro %}

{% block main_content %}
<div class="admin-page">
  <div class="admin-header d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
    <div>
      <h1 class="admin-section-title mb-1">{{ _('Yhdistä mielenosoituksia') }}</h1>
      <p class="text-muted mb-0">{{ _('Valittuja mielenosoituksia: %(count)s', count=demos|length) }}</p>
    </div>
    <a href="{{ url_for('admin_demo.demo_control') }}" class="btn btn-outline-secondary">
      <i class="fa-solid fa-arrow-left me-2"></i>{{ _('Takaisin hallintapaneeliin') }}
    </a>
  </div>

  <div class="alert alert-warning">
    <i class="fa-solid fa-triangle-exclamation me-2"></i>
    {{ _('Yhdistäminen siirtää tilastot, muistutukset ja seurannat valittuihin mielenosoituksiin. Järjestelmä ehdottaa turvallisia oletuksia, mutta tarvittaessa voit ottaa manuaalisen tilan käyttöön.') }}
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
    {% for demo in demos %}
    <div class="col">
      <div class="demo-merge-card h-100">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="mb-1">{{ demo.title }}</h5>
            <div class="text-muted small">{{ demo.date }} · {{ demo.city }}</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            {% if demo.status_label %}
            <span class="badge bg-{{ demo.status_variant }}" data-bs-toggle="tooltip" title="{{ demo.status_hint }}">{{ demo.status_label }}</span>
            {% endif %}
            {% if demo.is_recommended %}
            <span class="badge bg-success">{{ _('Suositeltu') }}</span>
            {% endif %}
          </div>
        </div>
        <dl class="mt-3 mb-0 small">
          <dt class="text-muted">{{ _('ID') }}</dt>
          <dd class="mb-2"><code>{{ demo.id }}</code></dd>
          <dt class="text-muted">{{ _('Lyhytlinkki') }}</dt>
          <dd class="mb-2">
            {% if demo.slug %}
            <code>{{ demo.slug }}</code>
            {% else %}
            <span class="text-muted">—</span>
            {% endif %}
          </dd>
          <dt class="text-muted">{{ _('Ilmoittaja') }}</dt>
          <dd class="mb-2">
            {% if demo.submitter %}
              <div>{{ demo.submitter.name or _('Nimi puuttuu') }}</div>
              <div class="text-muted">{{ demo.submitter.email or _('Sähköposti puuttuu') }}</div>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </dd>
          <dt class="text-muted">{{ _('Osoite') }}</dt>
          <dd class="mb-0">{{ demo.address or '—' }}</dd>
        </dl>
      </div>
    </div>
    {% endfor %}
  </div>

  <form method="POST" action="{{ url_for('admin_demo.merge_demos') }}" class="mt-4" id="mergeForm">
    {% for demo_id in selected_ids %}
      <input type="hidden" name="demo_ids" value="{{ demo_id }}">
    {% endfor %}

    <div class="card shadow-sm mb-4" id="guided-summary-card">
      <div class="card-header fw-semibold d-flex align-items-center justify-content-between flex-wrap gap-2">
        <span>{{ _('Ohjattu yhdistäminen') }}</span>
        <div class="form-check form-switch mb-0">
          <input class="form-check-input" type="checkbox" id="manual-mode-toggle" name="manual_mode" value="1">
          <label class="form-check-label" for="manual-mode-toggle">
            {{ _('Ota manuaalinen tila käyttöön') }}
          </label>
        </div>
      </div>
      <div class="card-body">
        {% if merge_warnings %}
        <div class="alert alert-danger mb-3">
          <ul class="mb-0 ps-3">
            {% for warning in merge_warnings %}
              <li>{{ warning }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <h6 class="text-uppercase text-muted small">{{ _('Ehdotettu päätapahtuma') }}</h6>
            <p class="mb-2">
              <strong>{{ demo_lookup[default_primary].title }}</strong><br>
              <small class="text-muted">{{ demo_lookup[default_primary].date }} · {{ demo_lookup[default_primary].city }}</small>
            </p>
            <h6 class="text-uppercase text-muted small">{{ _('Kenttien säilytys (automaattinen)') }}</h6>
            <table class="table table-sm table-borderless align-middle mb-0">
              <tbody>
                {% for field in guided_field_summary %}
                <tr>
                  <td class="text-muted small">{{ field.label }}</td>
                  <td class="small">{{ demo_lookup[field.source_id].title if field.source_id in demo_lookup else _('Tuntematon') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="col-12 col-lg-6">
            <h6 class="text-uppercase text-muted small">{{ _('Tilannekuva') }}</h6>
            <div class="table-responsive">
              <table class="table table-sm table-borderless align-middle mb-0">
                <thead>
                  <tr class="text-muted small">
                    <th>{{ _('Mielenosoitus') }}</th>
                    <th>{{ _('Tila') }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for demo in demos %}
                  <tr>
                    <td class="small">
                      <div class="fw-semibold">{{ demo.title }}</div>
                      <div class="text-muted">{{ demo.date }} · {{ demo.city }}</div>
                    </td>
                    <td>
                      {% if demo.status_label %}
                      <span class="badge bg-{{ demo.status_variant }}" data-bs-toggle="tooltip" title="{{ demo.status_hint }}">{{ demo.status_label }}</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="mt-3">
              <h6 class="text-uppercase text-muted small">{{ _('Ilmoittajat') }}</h6>
              {% if submitter_summary %}
                <ul class="guided-plan-list small">
                  {% for group in submitter_summary %}
                  <li>
                    <strong>{{ group.label }}</strong>
                    <div class="text-muted">{{ _('%(count)s ilmoitusta', count=group.count) }}</div>
                  </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted small mb-0">{{ _('Ilmoittajatietoja ei löytynyt.') }}</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div id="manual-mode-hint" class="text-muted small mt-3">
          {{ _('Ohjattu tila on käytössä. Jos tarvitset täydellistä hallintaa, kytke manuaalinen tila päälle yllä olevasta kytkimestä.') }}
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4" data-manual-section>
      <div class="card-header fw-semibold">
        {{ _('Valitse päätapahtuma (säilytettävä ID)') }}
      </div>
      <div class="card-body">
        {% for demo in demos %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="primary_demo_id" id="primary-{{ demo.id }}"
                 value="{{ demo.id }}" {% if demo.id == default_primary %}checked{% endif %} required>
          <label class="form-check-label" for="primary-{{ demo.id }}">
            {{ demo.title }} · <small class="text-muted">{{ demo.date }} · {{ demo.city }}</small>
          </label>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="card shadow-sm mb-4" data-manual-section>
      <div class="card-header fw-semibold">
        {{ _('Kenttien lähde') }}
      </div>
      <div class="card-body">
        <div class="accordion" id="mergeFieldAccordion">
          {% for field in merge_fields %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ field.key }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapse-{{ field.key }}" aria-expanded="false"
                      aria-controls="collapse-{{ field.key }}">
                {{ field.label }}
              </button>
            </h2>
            <div id="collapse-{{ field.key }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ field.key }}"
                 data-bs-parent="#mergeFieldAccordion">
              <div class="accordion-body">
                {% for demo in demos %}
                <div class="form-check mb-3">
                  <input class="form-check-input" type="radio"
                         name="field_source[{{ field.key }}]" id="{{ field.key }}-{{ demo.id }}"
                         value="{{ demo.id }}"
                         {% set auto_source = guided_sources.get(field.key, default_primary) %}
                         {% if demo.id == auto_source %}checked{% endif %}>
                  <label class="form-check-label fw-semibold" for="{{ field.key }}-{{ demo.id }}">
                    {{ demo.title }}
                  </label>
                  <div class="merge-field-value mt-1">
                    {{ render_field_value(demo, field) }}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4" data-manual-section>
      <div class="card-header fw-semibold">
        {{ _('Suosittelu ja toistuvuus') }}
      </div>
      <div class="card-body">
        <p class="text-muted mb-2">{{ _('Valitse, minkä demon suositusmerkintä säilytetään (tai poistetaan kokonaan).') }}</p>
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="recommendation_source" id="recommend-none"
                 value="none" {% if guided_recommendation == 'none' %}checked{% endif %}>
          <label class="form-check-label" for="recommend-none">
            {{ _('Ei säilytettyä suositusta') }}
          </label>
        </div>
        {% for demo in demos %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="recommendation_source"
                 id="recommend-{{ demo.id }}" value="{{ demo.id }}"
                 {% if guided_recommendation == demo.id %}checked{% endif %}>
          <label class="form-check-label" for="recommend-{{ demo.id }}">
            {{ _('Pidä suositus mielenosoitukselta %(title)s', title=demo.title) }}
            {% if demo.is_recommended %}
              <span class="badge bg-success ms-1">{{ _('Suositeltu') }}</span>
            {% endif %}
          </label>
          {% if demo.recommendation and demo.recommendation.recommend_till %}
          <div class="small text-muted ms-4">
            {{ _('Suositus voimassa: %(date)s', date=demo.recommendation.recommend_till) }}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fa-solid fa-object-group me-2"></i>{{ _('Yhdistä mielenosoitukset') }}
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('manual-mode-toggle');
    const form = document.getElementById('mergeForm');
    const manualSections = form ? form.querySelectorAll('[data-manual-section]') : [];
    const hint = document.getElementById('manual-mode-hint');
    const container = document.querySelector('.admin-page');

    const updateManualMode = () => {
      const manualEnabled = toggle && toggle.checked;
      if (container) {
        container.classList.toggle('manual-mode-active', manualEnabled);
      }
      manualSections.forEach(section => {
        section.style.display = manualEnabled ? '' : 'none';
      });
      if (hint) {
        hint.style.display = manualEnabled ? 'none' : '';
      }
    };

    if (toggle) {
      toggle.addEventListener('change', updateManualMode);
      updateManualMode();
    }

    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
    });
  });
</script>
{% endblock %}
