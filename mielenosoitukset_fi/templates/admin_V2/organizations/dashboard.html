{% extends 'admin_base.html' %}


{% block main_content %}
<section class="dashboard-container">
    <!-- Intro card -->
    <div class="introduction">
        <h1 id="tabletitle">{{ _('Organisaatiot') }}</h1>
        <p class="muted">
            {{ _('Täältä voit hallita organisaatioita, joihin sinulla on käyttöoikeus.') }}<br>
            {{ _('Lisätietoja hallinnoimisesta löydät hallinnoijan käsikirjasta, kappaleesta 2.1: Organisaatioiden
            hallintapaneeli, etusivu.') }}
        </p>
    </div>

    <!-- Action panel -->
    <div class="dashboard-panel">

        <div class="flex justify-center mb-4">
            {% if current_user.has_permission("CREATE_ORGANIZATION", strict=true) %}
            <a href="{{ url_for('admin_org.create_organization') }}" class="btn new-item">
                <i class="fas fa-plus"></i>{{ _('Luo uusi organisaatio') }}
            </a>
            {% else %}
            <a class="non-suffperm" data-tooltip="Ei käyttöoikeutta"><i class="fas fa-ban"></i> {{ _('Luo uusi
                organisaatio') }}</a>
            {% endif %}
        </div>

        <!-- Client‑side search (no backend round‑trip) -->
        <div class="search-bar">
            <label for="search" class="sr-only">{{ _('Hae organisaatioita:') }}</label>
            <input type="search" id="search" class="search-input" placeholder="{{ _('Hae organisaatioita...') }}"
                aria-label="{{ _('Hae organisaatioita') }}">
            <button type="button" id="search-btn" class="search-button">
                <i class="fas fa-search"></i>{{ _('Hae') }}
            </button>
        </div>
    </div>

    <!-- Table of organisations -->
    {% if organizations %}
    <div class="table-container" style="background:none;">
        <table id="org-table">
            <thead>
                <tr>
                    <th class="cbox-cell"><input type="checkbox" id="select-all" /></th>
                    <th>{{ _('Nimi') }}</th>
                    <th>{{ _('Kuvaus') }}</th>
                    <th>{{ _('Sähköpostiosoite') }}</th>
                    <th>{{ _('Verkkosivu') }}</th>
                    <th class="actions-cell-header">{{ _('Toiminnot') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for org in organizations %}
                <tr>
                    <td class="cbox-cell"><input type="checkbox" name="selected_orgs" value="{{ org._id }}"></td>
                    <td>{{ org.name }}</td>
                    <td>{{ org.description }}</td>
                    <td>{{ org.email }}</td>
                    <td><a href="{{ org.website }}" target="_blank" class="link">{{ org.website }}</a></td>
                    <td class="actions-cell">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                id="actionsDropdown-{{ org._id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa-solid fa-ellipsis-vertical"></i> {{ _('Toiminnot') }}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="actionsDropdown-{{ org._id }}">
                                {% if current_user.has_permission("EDIT_ORGANIZATION", org._id) %}
                                <li>
                                    <a class="dropdown-item"
                                        href="{{ url_for('admin_org.edit_organization', org_id=org._id) }}">
                                        <i class="fas fa-edit me-2"></i>{{ _('Muokkaa') }}
                                    </a>
                                </li>
                                {% else %}
                                <li>
                                    <span class="dropdown-item disabled" data-tooltip="Ei käyttöoikeutta">
                                        <i class="fas fa-ban me-2"></i>{{ _('Muokkaa') }}
                                    </span>
                                </li>
                                {% endif %}

                                {% if current_user.has_permission("DELETE_ORGANIZATION", org._id) %}
                                <li>
                                    <a class="dropdown-item text-danger"
                                        href="{{ url_for('admin_org.confirm_delete_organization', org_id=org._id) }}">
                                        <i class="fas fa-trash-alt me-2"></i>{{ _('Poista') }}
                                    </a>
                                </li>
                                {% else %}
                                <li>
                                    <span class="dropdown-item disabled" data-tooltip="Ei käyttöoikeutta">
                                        <i class="fas fa-ban me-2"></i>{{ _('Poista') }}
                                    </span>
                                </li>
                                {% endif %}

                                {% if current_user.has_permission("VIEW_ORGANIZATION", org._id) %}
                                <li>
                                    <a class="dropdown-item"
                                        href="{{ url_for('admin_org.view_organization', org_id=org._id) }}">
                                        <i class="fa-solid fa-eye me-2"></i>{{ _('Yhteenveto') }}
                                    </a>
                                </li>
                                {% else %}
                                <li>
                                    <span class="dropdown-item disabled" data-tooltip="Ei käyttöoikeutta">
                                        <i class="fas fa-ban me-2"></i>{{ _('Yhteenveto') }}
                                    </span>
                                </li>
                                {% endif %}

                                <!-- Always visible link to public org page -->
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('org', org_id=org._id) }}">
                                        <i class="fa-solid fa-eye me-2"></i>{{ _('Katsele') }}
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-container d-flex justify-content-between align-items-center mt-3">
        <div class="pagination-info">
            {{ _('Sivu') }} {{ current_page }} / {{ total_pages }}
        </div>
        <div class="pagination-controls">
            <ul class="pagination mb-0">
                <li class="page-item {% if not prev_page %}disabled{% endif %}">
                    <a class="page-link" href="{% if prev_page %}?page={{ prev_page }}&per_page={{ per_page }}&search={{ search_query|urlencode }}{% else %}#{% endif %}"
                        aria-label="{{ _('Edellinen sivu') }}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item disabled"><span class="page-link">{{ current_page }}</span></li>
                <li class="page-item {% if not next_page %}disabled{% endif %}">
                    <a class="page-link" href="{% if next_page %}?page={{ next_page }}&per_page={{ per_page }}&search={{ search_query|urlencode }}{% else %}#{% endif %}"
                        aria-label="{{ _('Seuraava sivu') }}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    {% else %}
    <div class="no-orgs">
        <p>{{ _('Organisaatioita ei löytynyt.') }}</p>
    </div>
    {% endif %}
</section>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const selectAll = document.getElementById('select-all');
        const checkBoxes = document.querySelectorAll("input[name='selected_orgs']");

        selectAll?.addEventListener('change', () => {
            checkBoxes.forEach(cb => {
                cb.checked = selectAll.checked;
                cb.closest('tr').classList.toggle('selected', cb.checked);
            });
        });

        checkBoxes.forEach(cb => {
            cb.addEventListener('change', () => {
                cb.closest('tr').classList.toggle('selected', cb.checked);
            });
        });

        const searchInput = document.getElementById('search');
        const searchBtn = document.getElementById('search-btn');
        const rows = document.querySelectorAll('#org-table tbody tr');

        const filterRows = () => {
            const term = searchInput.value.trim().toLowerCase();
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        };

        searchInput.addEventListener('input', filterRows);
        searchBtn.addEventListener('click', filterRows);
    });
</script>
{% endblock %}

{% block extra_buttons %}
<div class="extra-buttons">
    <a href="{{ url_for('admin_org.invite_to_organization') }}" class="button invite-button"><i
            class="fas fa-user-plus"></i>{{ _('Kutsu henkilö') }}</a>
    <a href="{{ url_for('admin_org.manage_roles') }}" class="button manage-roles-button"><i
            class="fas fa-user-cog"></i>{{ _('Hallitse rooleja') }}</a>
</div>
{% endblock %}
