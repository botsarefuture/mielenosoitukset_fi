{% extends 'admin_base.html' %}

{% block main_content %}
<!-- Include CSS and JS files -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/demo_form.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/submit.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/demo_checkbox.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/recu_dash.css') }}"> <!-- Load recu_dash.css -->
<script src="{{ url_for('static', filename='js/admin_demo_checkbox.js') }}"></script>

<!-- Main content container -->
<div class="container container-form">
    <h2>{{ title }}</h2>
    <form method="POST" action="{{ form_action }}">

        <!-- Form fields with required indicators -->
        <div class="form-group">
            <label for="title">Otsikko <span class="required">*</span></label>
            <input type="text" id="title" name="title" class="form-control" value="{{ demo.title if demo and demo.title else '' }}" required>
        </div>
        <div class="form-group">
            <label for="date">Päivämäärä (pp.kk.vvvv) <span class="required">*</span></label>
            <input type="text" id="date" name="date" class="form-control" value="{{ demo.date if demo and demo.date else '' }}" required>
        </div>
        <div class="form-group">
            <label for="start_time">Alkamisaika <span class="required">*</span></label>
            <input type="time" id="start_time" name="start_time" class="form-control" value="{{ demo.start_time if demo and demo.start_time else '' }}" required>
        </div>
        <div class="form-group">
            <label for="end_time">Päättymisaika</label>
            <input type="time" id="end_time" name="end_time" class="form-control" value="{{ demo.end_time if demo and demo.end_time else '' }}">
        </div>
        <div class="form-group">
            <label for="topic">Aihe <span class="required">*</span></label>
            <input type="text" id="topic" name="topic" class="form-control" value="{{ demo.topic if demo and demo.topic else '' }}" required>
        </div>
        <div class="form-group">
            <label for="facebook">Facebook linkki</label>
            <input type="url" id="facebook" name="facebook" class="form-control" value="{{ demo.facebook if demo and demo.facebook else '' }}">
        </div>

        {% include "paikkakunta-dropdown.html" %}

        <!-- Address Field -->
        <div class="form-group">
            <label for="address">Osoite <span class="required">*</span></label>
            <input type="text" id="address" name="address" class="form-control" value="{{ demo.address if demo and demo.address else '' }}" required>
        </div>

        <!-- Event Type Selector -->
        <div class="form-group">
            <label for="type">Tyyppi <span class="required">*</span></label>
            <select id="type" name="type" class="form-control" required>
                <option value="marssi" {% if demo and demo.event_type == 'marssi' %}selected{% endif %}>Marssi</option>
                <option value="paikallaan" {% if demo and demo.event_type == 'paikallaan' %}selected{% endif %}>Paikallaan</option>
                <option value="muut" {% if demo and demo.event_type == 'muut' %}selected{% endif %}>Muut</option>
            </select>
        </div>

        <!-- March Route Input -->
        <div id="march-route-container" class="form-group" {% if demo and demo.event_type != 'marssi' %}style="display:none;"{% endif %}>
            <label for="route">Reitti (marssin)</label>
            <input type="text" id="route" name="route" class="form-control" value="{{ demo.route if demo and demo.route else '' }}">
        </div>

        <h4>Järjestäjätahojen tiedot</h4>

        <!-- Organizers Section -->
        <div id="organizers-container" class="container-columns">
            {% if demo and demo.organizers %}
                {% for organizer in demo.organizers %}
                <div class="form-group organizer-item">
                    <hr>
                    <label for="organizer_name_{{ loop.index }}">Järjestäjätahon nimi <span class="required">*</span></label>
                    <input type="text" id="organizer_name_{{ loop.index }}" name="organizer_name_{{ loop.index }}" class="form-control" value="{{ organizer.name }}" required>
                    <label for="organizer_website_{{ loop.index }}">Nettisivu</label>
                    <input type="url" id="organizer_website_{{ loop.index }}" name="organizer_website_{{ loop.index }}" class="form-control" value="{{ organizer.website }}">
                    <label for="organizer_email_{{ loop.index }}">Sähköposti</label>
                    <input type="email" id="organizer_email_{{ loop.index }}" name="organizer_email_{{ loop.index }}" class="form-control" value="{{ organizer.email }}">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeOrganizer(this)">Poista</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <button type="button" class="btn btn-primary mt-2" onclick="addOrganizer()">Lisää järjestäjä</button>

        <!-- Approval Checkbox -->
        <div class="approval-wrapper mt-4">
            <div class="form-group" id="approval-container">
                <label for="approved">Hyväksytty</label>
                <div>
                    <input type="checkbox" id="approved" name="approved" class="form-check-input" {% if demo and demo.approved %}checked{% endif %}>
                    <span id="approval-status" class="status-text">{% if demo and demo.approved %}Kyllä{% else %}Ei{% endif %}</span>
                </div>
            </div>
        </div>
<!-- Recurrence Settings -->
<section class="form-section dashboard-panel mb-8">
    <h2 class="text-xl font-semibold mb-4">{{ _('Toistuvuusasetukset') }}</h2>

    <div class="form-group grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label for="frequency_type" class="block font-medium mb-1">{{ _('Toistuvuustyyppi') }}</label>
            <select id="frequency_type" name="frequency_type" class="form-control w-full">
                {% set freq = demo.repeat_schedule.frequency if demo and demo.repeat_schedule else 'none' %}
                <option value="none" {% if freq=='none' %}selected{% endif %}>{{ _('Ei toistu') }}</option>
                <option value="daily" {% if freq=='daily' %}selected{% endif %}>{{ _('Päivittäin') }}</option>
                <option value="weekly" {% if freq=='weekly' %}selected{% endif %}>{{ _('Viikoittain') }}</option>
                <option value="monthly" {% if freq=='monthly' %}selected{% endif %}>{{ _('Kuukausittain') }}</option>
                <option value="yearly" {% if freq=='yearly' %}selected{% endif %}>{{ _('Vuosittain') }}</option>
            </select>
        </div>
        <div>
            <label for="frequency_interval" class="block font-medium mb-1">{{ _('Toistuvuusväli') }}</label>
            <input type="number" id="frequency_interval" name="frequency_interval" min="1" class="form-control w-32"
                value="{{ demo.repeat_schedule.interval if demo and demo.repeat_schedule else 1 }}">
            <small class="text-muted">{{ _('Kuinka monta kertaa toisto tapahtuu (esim. joka 2. viikko)') }}</small>
        </div>
    </div>

    <!-- Weekly options -->
    <div id="weekly-options" class="form-group mt-4" style="display: {% if freq=='weekly' %}block{% else %}none{% endif %}">
        <label class="block font-medium mb-1">{{ _('Valitse viikonpäivät') }}</label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            {% for day, label in [('mon', _('Ma')), ('tue', _('Ti')), ('wed', _('Ke')), ('thu', _('To')), ('fri', _('Pe')), ('sat', _('La')), ('sun', _('Su'))] %}
            <label class="inline-flex items-center">
                <input type="checkbox" name="weekday" value="{{ day }}"
                    {% if demo and demo.repeat_schedule and day == demo.repeat_schedule.weekday %}checked{% endif %}
                    class="form-checkbox">
                <span class="ml-2">{{ label }}</span>
            </label>
            {% endfor %}
        </div>
    </div>

    <!-- Monthly options -->
    <div id="monthly-options" class="form-group mt-4" style="display: {% if freq=='monthly' %}block{% else %}none{% endif %}">
        <label class="block font-medium mb-1">{{ _('Kuukauden vaihtoehto') }}</label>
        <select id="monthly_option" name="monthly_option" class="form-control w-full">
            {% set monthly_opt = demo.repeat_schedule.monthly_option if demo and demo.repeat_schedule else 'day_of_month' %}
            <option value="day_of_month" {% if monthly_opt=='day_of_month' %}selected{% endif %}>{{ _('Päivä kuukaudessa') }}</option>
            <option value="nth_weekday" {% if monthly_opt=='nth_weekday' %}selected{% endif %}>{{ _('nth viikonpäivä') }}</option>
        </select>

        <div class="mt-2">
            <input type="number" id="day_of_month" name="day_of_month" min="1" max="31" class="form-control w-32"
                placeholder="{{ _('Päivä') }}"
                value="{{ demo.repeat_schedule.day_of_month if demo and demo.repeat_schedule else '' }}">
        </div>

        <div class="mt-2">
            <select id="nth_weekday" name="nth_weekday" class="form-control w-32">
                {% set nth = demo.repeat_schedule.nth_weekday if demo and demo.repeat_schedule else '' %}
                <option value="">--</option>
                <option value="first" {% if nth=='first' %}selected{% endif %}>{{ _('1.') }}</option>
                <option value="second" {% if nth=='second' %}selected{% endif %}>{{ _('2.') }}</option>
                <option value="third" {% if nth=='third' %}selected{% endif %}>{{ _('3.') }}</option>
                <option value="fourth" {% if nth=='fourth' %}selected{% endif %}>{{ _('4.') }}</option>
                <option value="last" {% if nth=='last' %}selected{% endif %}>{{ _('viimeinen') }}</option>
            </select>

            <select id="weekday_of_month" name="weekday_of_month" class="form-control w-32">
                {% set wd_month = demo.repeat_schedule.weekday_of_month if demo and demo.repeat_schedule else '' %}
                {% for day, label in [('mon', _('Ma')), ('tue', _('Ti')), ('wed', _('Ke')), ('thu', _('To')), ('fri', _('Pe')), ('sat', _('La')), ('sun', _('Su'))] %}
                <option value="{{ day }}" {% if wd_month==day %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group mt-4">
        <label for="end_date" class="block font-medium mb-1">{{ _('Toistuvuuden loppupäivä') }}</label>
        <input type="text" id="end_date" name="end_date" class="form-control w-full"
            value="{{ demo.repeat_schedule.end_date if demo and demo.repeat_schedule else '' }}" autocomplete="off">
    </div>

    <script>
        const freqSelect = document.getElementById('frequency_type');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');

        freqSelect.addEventListener('change', () => {
            weeklyOptions.style.display = freqSelect.value === 'weekly' ? 'block' : 'none';
            monthlyOptions.style.display = freqSelect.value === 'monthly' ? 'block' : 'none';
        });
    </script>
</section>


        <!-- Submit Button -->
        <div class="form-group">
            <button type="submit" class="btn btn-success">Tallenna</button>
        </div>
    </form>
</div>

<script>
    // JavaScript functions for handling the dynamic parts
    function selectCity(city) {
        document.getElementById('selected-city').value = city;
        document.querySelector('.dropbtn').textContent = city;
        document.getElementById('dropdown-content').style.display = 'none'; // Hide dropdown
    }

    function filterFunction() {
        var input, filter, div, a, i;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        div = document.getElementById("dropdown-content");
        a = div.getElementsByTagName("a");
        for (i = 0; i < a.length; i++) {
            if (a[i].textContent.toUpperCase().indexOf(filter) > -1) {
                a[i].style.display = "";
            } else {
                a[i].style.display = "none";
            }
        }
    }

    function addOrganizer() {
        const container = document.getElementById('organizers-container');
        const index = container.getElementsByClassName('organizer-item').length + 1; // New index for unique IDs
        const newItem = `
        <div class="form-group organizer-item">
            <hr>
            <label for="organizer_name_${index}">Järjestäjätahon nimi <span class="required">*</span></label>
            <input type="text" id="organizer_name_${index}" name="organizer_name_${index}" class="form-control" required>
            <label for="organizer_website_${index}">Nettisivu</label>
            <input type="url" id="organizer_website_${index}" name="organizer_website_${index}" class="form-control">
            <label for="organizer_email_${index}">Sähköposti</label>
            <input type="email" id="organizer_email_${index}" name="organizer_email_${index}" class="form-control">
            <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeOrganizer(this)">Poista</button>
        </div>`;
        container.insertAdjacentHTML('beforeend', newItem);
    }

    function removeOrganizer(button) {
        button.closest('.organizer-item').remove(); // Remove the organizer item
    }

    document.getElementById('type').addEventListener('change', function () {
        document.getElementById('march-route-container').style.display = this.value === 'marssi' ? 'block' : 'none';
    });
</script>

{% endblock %}
