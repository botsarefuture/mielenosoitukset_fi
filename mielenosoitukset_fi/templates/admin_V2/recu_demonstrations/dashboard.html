{% extends 'admin_base.html' %}

{% block title %}{{ _('Toistuvat mielenosoitukset') }}{% endblock %}

{% block styles %}
<style>
  .search-and-filter {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 768px) {
    .search-and-filter {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .filter-form {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
  }
</style>
{% endblock %}

{% block main_content %}
<section class="dashboard-container">
  <div class="introduction">
    <h1 id="tabletitle">{{ _('Toistuvat mielenosoitukset') }}</h1>
    <p class="muted">
      {{ _('Täältä voit hallita toistuvia mielenosoituksia, joihin sinulla on käyttöoikeus.') }}
    </p>
  </div>

  <div class="dashboard-panel">
    <div class="flex justify-center mb-4">
      {% if current_user.has_permission("CREATE_RECURRING_DEMO") %}
      <a href="{{ url_for('admin_recu_demo.create_recu_demo') }}" class="button new-item">
        <i class="fas fa-plus-circle"></i> {{ _('Luo uusi toistuva mielenosoitus') }}
      </a>
      {% else %}
      <a class="non-suffperm" data-tooltip="{{ _('Ei käyttöoikeutta') }}">
        <i class="fas fa-ban"></i> {{ _('Luo uusi toistuva mielenosoitus') }}
      </a>
      {% endif %}
    </div>

    <form method="GET" action="{{ url_for('admin_recu_demo.recu_demo_control') }}" class="search-and-filter filter-form">
      <div>
        <label for="search" class="sr-only">{{ _('Hae toistuvia mielenosoituksia:') }}</label>
        <input type="search" id="search" name="search" class="search-input" placeholder="{{ _('Hae toistuvia mielenosoituksia...') }}"
          value="{{ search_query }}" aria-label="{{ _('Hae toistuvia mielenosoituksia') }}">
      </div>

      <label for="approved">{{ _('Näytä vain hyväksytyt toistuvat mielenosoitukset:') }}</label>
      <select name="approved" id="approved" class="filter-select" onchange="this.form.submit()">
        <option value="true" {% if approved_status %}selected{% endif %}>{{ _('Kyllä') }}</option>
        <option value="false" {% if not approved_status %}selected{% endif %}>{{ _('Ei') }}</option>
      </select>

      <button type="submit" class="search-button">
        <i class="fas fa-search"></i> {{ _('Hae') }}
      </button>
    </form>
  </div>

  {% if recurring_demos %}
  <div class="table-container" style="background:none;">
    <table>
      <thead>
        <tr>
          <th>{{ _('Otsikko') }}</th>
          <th>{{ _('Toistuvuus') }}</th>
          <th>{{ _('Aika') }}</th>
          <th>{{ _('Kaupunki') }}</th>
          <th>{{ _('Hyväksytty') }}</th>
          <th class="actions-cell-header">{{ _('Toiminnot') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for demo in recurring_demos %}
        <tr id="recu-demo-{{ demo._id }}" {% if not demo.approved %}class="needs-attention"{% endif %}>
          <td>{{ demo.title }}</td>
          <td>{{ demo.repeat_schedule.as_string() }}</td>
          <td>{{ demo.start_time }} - {{ demo.end_time }}</td>
          <td>{{ demo.city }}</td>
          <td data-col="approved">
            {% if demo.approved %}
            <i class="fa-solid fa-check-circle"></i> {{ _('Kyllä') }}
            {% else %}
            <i class="fa-solid fa-times-circle"></i> {{ _('Ei') }}
            {% endif %}
          </td>
          <td class="actions-cell">
            {% if current_user.has_permission("EDIT_DEMO") %}
            <a href="{{ url_for('admin_recu_demo.edit_recu_demo', demo_id=demo._id) }}" class="button edit-button">
              <i class="fas fa-edit"></i> {{ _('Muokkaa') }}
            </a>
            {% else %}
            <a class="non-suffperm" data-tooltip="{{ _('Ei käyttöoikeutta') }}">
              <i class="fas fa-ban"></i> {{ _('Muokkaa') }}
            </a>
            {% endif %}

            {% if current_user.has_permission("DELETE_DEMO") %}
            <button type="button" class="button delete-button"
              onclick="openModal(event, '{{ demo.title }}', '{{ demo._id }}', 'recu')">
              <i class="fas fa-trash-alt"></i> {{ _('Poista') }}
            </button>
            {% else %}
            <a class="non-suffperm" data-tooltip="{{ _('Ei käyttöoikeutta') }}">
              <i class="fas fa-ban"></i> {{ _('Poista') }}
            </a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="no-results">
    <i class="fa-solid fa-circle-exclamation"></i> {{ _('Ei löytynyt toistuvia mielenosoituksia.') }}
  </div>
  {% endif %}

  <!-- Delete modal (same structure as dashboard) -->
  <div id="deleteModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3><i class="fa-solid fa-circle-exclamation"></i> {{ _('Poista toistuva mielenosoitus') }}</h3>
      <p>
        {{ _('Oletko varma, että haluat poistaa toistuvan mielenosoituksen') }}
        <strong id="demoTitle"></strong>?
      </p>
      <div class="button-container">
        <button type="button" class="button delete-confirm" id="confirmDelete">
          {{ _('Kyllä, poista') }}
        </button>
        <button type="button" class="button" onclick="closeModal()">
          {{ _('Peruuta') }}
        </button>
      </div>
    </div>
  </div>

</section>

<script>
  // Reuse your dashboard's modal JS functions (adapt if needed)

  function openModal(event, title, id, type = 'single') {
    event.preventDefault();
    document.getElementById('demoTitle').textContent = title;
    // Store id and type for delete action
    document.getElementById('confirmDelete').dataset.id = id;
    document.getElementById('confirmDelete').dataset.type = type;
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('confirmDelete').dataset.id = '';
    document.getElementById('confirmDelete').dataset.type = '';
  }

  document.getElementById('confirmDelete').addEventListener('click', () => {
    const id = document.getElementById('confirmDelete').dataset.id;
    const type = document.getElementById('confirmDelete').dataset.type;
    let url = '';
    if (type === 'recu') {
      url = `/admin/recu_demo/delete_recu_demo/${id}`;
    } else {
      url = `/admin/demo/delete_demo/${id}`;
    }
    fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === 'OK'){
        location.reload();
      } else {
        alert(data.message || '{{ _("Virhe poistettaessa.") }}');
      }
    })
    .catch(() => alert('{{ _("Yhteysvirhe, yritä uudelleen.") }}'));
  });

  // Simple client-side search filter (optional)
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search');
    const rows = document.querySelectorAll('.table-container tbody tr');

    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase().trim();
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
      });
    });
  });
</script>
{% endblock %}
