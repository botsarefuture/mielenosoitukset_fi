{% extends "admin_base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/stats.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/activities.css') }}">

<style>
  .no-data {
    color: var(--error_text, #721c24);
    font-weight: 600;
    background: var(--error_bg, #f8d7da);
    padding: 1.5rem;
    border: 1px dashed var(--error_border, #f5c6cb);
    border-radius: 6px;
    text-align: center;
    margin: 2rem 0;
  }

  .back-button {
    margin-top: 2rem;
    text-align: left;
  }

  .analytics-container {
    margin-top: 3rem;
    background: var(--container_background);
    border: 1px solid var(--border_color);
    border-radius: 8px;
    padding: 1.5rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    color: var(--text);
  }

  th, td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border_color);
  }

  th {
    background: var(--bg_secondary);
    text-align: left;
  }

  tbody tr:hover {
    background-color: var(--bg_hover);
  }

  a.demo-link {
    color: var(--primary_color);
    text-decoration: none;
    font-weight: 600;
  }

  a.demo-link:hover {
    text-decoration: underline;
  }
</style>

<style>
  th.sortable {
    cursor: pointer;
    position: relative;
  }
  th.sortable::after {
    content: "‚¨ç"; /* up/down arrow */
    font-size: 0.7em;
    color: var(--text_muted, #888);
    position: absolute;
    right: 8px;
  }
  th.sortable.asc::after {
    content: "‚¨Ü";
  }
  th.sortable.desc::after {
    content: "‚¨á";
  }
</style>
{% endblock %}

{% block main_content %}
<div class="dashboard-container">
    <div class="introduction">
    <h1 id="tabletitle">{{ _('Tilastot') }}</h1>
    <p class="muted">
      {{ _('T√§ss√§ osiossa voit tarkastella sivuston tilastoja.') }}
    </p>
  </div>


  <div class="stats-overview">
    <stats>
      <stat>
        <stitle>{{ _('K√§ytt√§ji√§') }}</stitle>
        <snum>{{ total_users }}</snum>
      </stat>
      <stat>
        <stitle>{{ _('Vahvistetut k√§ytt√§j√§t') }}</stitle>
        <sdisc>{{ _('K√§ytt√§ji√§, jotka ovat vahvistaneet s√§hk√∂postiosoitteensa') }}</sdisc>
        <snum>{{ active_users }}</snum>
      </stat>
      <stat>
        <stitle>{{ _('Organisaatioita') }}</stitle>
        <snum>{{ total_organizations }}</snum>
      </stat>
      <div style="width: 100%; background-color: transparent; height: 1px;"></div>
      <stat>
        <stitle>{{ _('Mielenosoituksia') }}</stitle>
        <snum>{{ total_demos }}</snum>
      </stat>
      <stat>
        <stitle>{{ _('Katselukerrat') }}</stitle>
        <sdisc>{{ _('Kaikkien mielenosoitusten katselukerrat') }}</sdisc>
        <snum>{{ total_views }}</snum>
      </stat>
      <stat>
        <stitle>{{ _('Keskim√§√§r√§inen katselukerrat') }}</stitle>
        <sdisc>{{ _('Keskim√§√§r√§inen katselukerrat mielenosoituksille') }}</sdisc>
        <snum>{{ avg_views }}</snum>
      </stat>
      <last-updated>
        <p>{{ _('Tilastot p√§ivitetty viimeksi') }}: {{ last_updated }}</p>
      </last-updated>
    </stats>
  </div>

  <div class="analytics-container">
    <h2>{{ _('Mielenosoitus analytiikka') }}</h2>
<!-- üÜï pretty 24‚ÄØh overview button -->
  <a href="{{ url_for('admin.analytics_overall_24h') }}"
     class="btn btn-outline-primary btn-sm mb-3 d-inline-flex align-items-center gap-1">
      <i class="fas fa-clock"></i>
      {{ _('Yleiskatsaus ‚Ä¢ viimeiset 24‚ÄØh') }}
  </a>
    {% if data %}
   <table>
  <thead>
    <tr>
      <th class="sortable" data-sort-key="id">{{ _('Mielenosoituksen ID') }}</th>
      <th class="sortable" data-sort-key="views">{{ _('Katselukerrat') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for demo in data %}
    <tr>
      <td>
        <a href="{{ url_for('admin.demo_analytics', demo_id=demo.id) }}" class="demo-link" title="{{ _('N√§yt√§ analytiikka') }}">
          {{ demo.id }}
        </a>
      </td>
      <td>{{ demo.views }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
    {% else %}
    <div class="no-data">
      <p>{{ _('Ei tietoja saatavilla.') }}</p>
    </div>
    {% endif %}
  </div>

<nav aria-label="Demo pagination">
  <ul class="pagination justify-content-center align-items-center">

    {# --- Previous button --- #}
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page - 1 }}&per_page={{ per_page }}" aria-label="Previous">
          <i class="fas fa-angle-left"></i> {{ _('Edellinen') }}
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link"><i class="fas fa-angle-left"></i> {{ _('Edellinen') }}</span>
      </li>
    {% endif %}

    {# --- Numbered page links --- #}
    {% set page_window = 2 %} {# number of pages to show on each side of current page #}
    {% set start_page = page - page_window if page - page_window > 1 else 1 %}
    {% set end_page = page + page_window if page + page_window < total_pages else total_pages %}

    {% if start_page > 1 %}
      <li class="page-item">
        <a class="page-link" href="?page=1&per_page={{ per_page }}">1</a>
      </li>
      {% if start_page > 2 %}
        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
      {% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
      {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
      {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ p }}&per_page={{ per_page }}">{{ p }}</a></li>
      {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
      {% if end_page < total_pages - 1 %}
        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
      {% endif %}
      <li class="page-item">
        <a class="page-link" href="?page={{ total_pages }}&per_page={{ per_page }}">{{ total_pages }}</a>
      </li>
    {% endif %}

    {# --- Next button --- #}
    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page + 1 }}&per_page={{ per_page }}" aria-label="Next">
          {{ _('Seuraava') }} <i class="fas fa-angle-right"></i>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">{{ _('Seuraava') }} <i class="fas fa-angle-right"></i></span>
      </li>
    {% endif %}

  </ul>
</nav>



  <div class="back-button">
    <a href="{{ url_for('admin.admin_dashboard') }}" class="button">
      <i class="fas fa-arrow-left"></i> {{ _('Palaa hallintapaneeliin') }}
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/activities.js') }}"></script>

<script>
  // Vanilla JS sorting for the demo analytics table
  (() => {
    const table = document.querySelector(".analytics-container table");
    if (!table) return;

    const tbody = table.querySelector("tbody");
    const headers = table.querySelectorAll("th.sortable");
    let sortOrder = {};  // track asc/desc per column

    function sortTable(key, asc) {
      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.sort((a, b) => {
        let aVal, bVal;

        if (key === "id") {
          // sort by text content of first td (demo id)
          aVal = a.cells[0].textContent.trim();
          bVal = b.cells[0].textContent.trim();
          // natural string compare
          return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else if (key === "views") {
          // sort by numeric views count (2nd td)
          aVal = parseInt(a.cells[1].textContent.trim(), 10) || 0;
          bVal = parseInt(b.cells[1].textContent.trim(), 10) || 0;
          return asc ? aVal - bVal : bVal - aVal;
        }
      });

      // clear and re-append rows in new order
      tbody.innerHTML = "";
      rows.forEach(row => tbody.appendChild(row));
    }

    headers.forEach(header => {
      header.addEventListener("click", () => {
        const key = header.getAttribute("data-sort-key");
        // toggle order
        const asc = !sortOrder[key];
        sortOrder = {}; // reset others
        sortOrder[key] = asc;

        // reset all header classes
        headers.forEach(h => h.classList.remove("asc", "desc"));
        header.classList.add(asc ? "asc" : "desc");

        sortTable(key, asc);
      });
    });
  })();
</script>

{% endblock %}
