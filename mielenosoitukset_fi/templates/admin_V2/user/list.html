{% extends 'admin_base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/users.css') }}">
<style>
  /* Toasts */
  #toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1055;
  }

  .toast {
    min-width: 250px;
  }

  /* Table enhancements */
  .table-hover tbody tr:hover {
    background-color: #f1f3f5;
    cursor: pointer;
  }

  .badge-role {
    text-transform: capitalize;
  }

  /* Sortable column indicators */
  th.sortable {
    cursor: pointer;
    position: relative;
  }

  th.sortable::after {
    content: '⬍';
    font-size: 0.7em;
    position: absolute;
    right: 8px;
    color: #888;
  }

  th.sortable.asc::after {
    content: '⬆';
  }

  th.sortable.desc::after {
    content: '⬇';
  }
</style>
{% endblock %}

{% block main_content %}
<div class="container-fluid">
  <h2 class="mb-4">{{ _('Käyttäjät') }}</h2>

  <!-- User Manual Link -->
  <div class="mb-3">
    <a href="{{ url_for('admin.manual_page', page='users') }}" target="_blank" class="btn btn-info">
      <i class="fa-solid fa-book me-1"></i> Käyttöohje
    </a>
    <a href="{{ url_for('admin_dev.list_requests') }}" class="btn btn-outline-primary ms-2">
      <i class="fa-solid fa-key me-1"></i> API-avainten pyynnöt
      {% if pending_token_requests %}
      <span class="badge bg-danger">{{ pending_token_requests }}</span>
      {% endif %}
    </a>
  </div>


  <!-- Search + Create -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <input type="text" id="userSearch" class="form-control me-2" placeholder="{{ _('Hae käyttäjiä...') }}"
      value="{{ search_query }}">

    {% if current_user.has_permission("CREATE_USER") %}
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
      <i class="fas fa-user-plus me-1"></i>{{ _('Luo uusi käyttäjä') }}
    </button>
    {% endif %}
  </div>

  <div id="usersTableContainer">
    {% include 'admin_V2/_users_table.html' %}
  </div>
</div>

<!-- Toasts -->
<div id="toast-container"></div>

<!-- Include Modals -->
{% include 'admin_V2/_modals_users.html' %}
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
  // ======== Toast Helper ========
  function showToast(message, type = 'success') {
    const toastContainer = $('#toast-container');
    const toastEl = $(`
      <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`);
    toastContainer.append(toastEl);
    const toast = new bootstrap.Toast(toastEl[0], { delay: 4000 });
    toast.show();
    toastEl.on('hidden.bs.toast', () => toastEl.remove());
  }

  // ======== Live Search ========
  let searchTimeout;
  $('#userSearch').on('input', function () {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const query = encodeURIComponent($(this).val());
      $.get(`{{ url_for('admin_user.user_control') }}?search=${query}`, function (html) {
        // Extract only the table part from the returned HTML
        const newTable = $(html).find('#usersTableContainer').html();
        $('#usersTableContainer').html(newTable);
      });
    }, 300);
  });

  // ======== Sortable Table Columns ========
  $(document).on('click', 'th.sortable', function () {
    const table = $(this).closest('table');
    const tbody = table.find('tbody');
    const index = $(this).index();
    const asc = !$(this).hasClass('asc');

    // Reset classes
    table.find('th.sortable').removeClass('asc desc');
    $(this).addClass(asc ? 'asc' : 'desc');

    const rows = tbody.find('tr').get();
    rows.sort((a, b) => {
      const A = $(a).children('td').eq(index).text().toUpperCase();
      const B = $(b).children('td').eq(index).text().toUpperCase();
      if ($.isNumeric(A) && $.isNumeric(B)) {
        return asc ? A - B : B - A;
      } else {
        return asc ? A.localeCompare(B) : B.localeCompare(A);
      }
    });
    $.each(rows, (_, row) => tbody.append(row));
  });
</script>


<script src="{{ url_for('static', filename='js/admin/users_modals.js') }}"></script>
{% endblock %}
