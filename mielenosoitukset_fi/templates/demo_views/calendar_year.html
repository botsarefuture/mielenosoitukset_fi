{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.css">

<style>
:root {
    --pink-primary: #ff3366;
    --pink-light: #ff99c8;
    --pink-lighter: #ffd6e8;
    --pink-bg: #fff0f6;
    --pink-pale: #fffafc;
    --pink-dark: #ff4d91;
}

.year-calendar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    font-family: 'Poppins', sans-serif;
}

.month-grid {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    background: var(--pink-pale);
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    border-radius: 10px;
    overflow: hidden;
}

.month-grid th,
.month-grid td {
    width: 14.28%;
    text-align: center;
    vertical-align: top;
    padding: 3px;
    border: 1px solid var(--pink-lighter);
}

.month-grid th {
    background: #f8c8dc;
    color: #fff;
    font-weight: 600;
    font-size: 12px;
}

.month-grid td {
    background: var(--pink-bg);
    position: relative;
}

.month-grid td strong {
    display: block;
    margin-bottom: 3px;
    color: var(--pink-primary);
    font-size: 12px;
}

.demo-cell {
    display: block;
    background: #ff66a3;
    color: #fff;
    text-decoration: none;
    border-radius: 6px;
    padding: 1px 3px;
    margin-bottom: 1px;
    font-size: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.demo-cell:hover {
    background: var(--pink-dark);
}

#demo-preview {
    position: absolute;
    display: none;
    background: var(--pink-pale);
    border: 1px solid #ffb3d1;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-width: 300px;
    z-index: 9999;
}

#demo-preview img {
    max-width: 100%;
    border-radius: 6px;
    margin-bottom: 5px;
}

.year-header {
    text-align: center;
    margin-bottom: 20px;
}

.calendar-year-nav {
    text-align: center;
    margin-bottom: 15px;
}

.calendar-year-nav a {
    background: var(--pink-light);
    color: #fff;
    padding: 6px 12px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    margin: 0 2px;
    transition: background 0.2s;
}

.calendar-year-nav a:hover {
    background: #ff66a3;
}

.onboarding-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000002;
    display: none;
}

.onboarding-tooltip {
    position: absolute;
    background: #fff;
    color: #333;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    max-width: 250px;
    text-align: center;
    z-index: 1000003;
    pointer-events: auto;
}

.onboarding-tooltip::after {
    content:'';
    position: absolute;
    border-width: 8px;
    border-style: solid;
    border-color: #fff transparent transparent transparent;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000004;
}

.onboarding-tooltip strong {
    display:block;
    font-size:16px;
    margin-bottom:6px;
}

.onboarding-tooltip p {
    font-size:14px;
    margin-bottom:10px;
}

.onboarding-tooltip button {
    background:#0056b3;
    color:#fff;
    border:none;
    border-radius:5px;
    padding:6px 12px;
    cursor:pointer;
    font-weight:600;
    transition: background 0.2s;
    z-index: 1000005;
}

.onboarding-tooltip button:hover {
    background:#004080;
}

/* Mobile List View */
.mobile-year-list {
    display: none;
}

.mobile-month-section {
    margin-bottom: 30px;
}

.mobile-month-header {
    background: var(--pink-light);
    color: white;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.mobile-month-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
}

.mobile-month-link {
    color: white;
    text-decoration: none;
    font-size: 14px;
    opacity: 0.9;
}

.mobile-month-link:hover {
    opacity: 1;
    text-decoration: underline;
}

.mobile-events-grid {
    display: grid;
    gap: 10px;
}

.mobile-event-card {
    background: white;
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border-left: 4px solid var(--pink-primary);
    display: block;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.mobile-event-card:hover, .mobile-event-card:active {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.mobile-event-date {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    font-weight: 500;
}

.mobile-event-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--pink-primary);
    margin-bottom: 5px;
}

.mobile-event-desc {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

.mobile-event-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    margin-top: 8px;
}

.mobile-empty-month {
    background: var(--pink-bg);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    color: #999;
    font-size: 14px;
}

.mobile-stats {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-around;
    text-align: center;
}

.mobile-stat-item {
    flex: 1;
}

.mobile-stat-number {
    font-size: 24px;
    font-weight: 700;
    color: var(--pink-primary);
    display: block;
}

.mobile-stat-label {
    font-size: 12px;
    color: #666;
}

@media(max-width: 768px){
    .year-calendar {
        display: none;
    }
    
    .mobile-year-list {
        display: block;
    }

    .calendar-year-nav {
        display: flex;
        align-items: center;
    }
    
    .calendar-year-nav a {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .year-header {
        font-size: 28px;
    }
    
    #demo-preview {
        position: fixed !important;
        max-width: 90%;
        left: 5% !important;
        top: 50% !important;
        transform: translateY(-50%);
    }
}

@media(min-width: 769px){
    .month-grid th, .month-grid td { font-size: 10px; padding: 2px; }
    .demo-cell { font-size: 9px; }
}
</style>

<!-- Onboarding Overlay -->
<div id="calendar-onboarding" class="onboarding-overlay" aria-hidden="true">
    <div class="onboarding-tooltip">
        <strong></strong>
        <p></p>
        <button class="onboarding-next">Seuraava ‚Üí</button>
    </div>
</div>

<h1 class="year-header">{{ year }}</h1>

<div class="calendar-year-nav">
    <a href="{{ url_for('calendar_year_view', year=year-1) }}">‚Üê Edellinen vuosi</a>
    <span style="margin:0 10px; font-weight:600;">{{ year }}</span>
    <a href="{{ url_for('calendar_year_view', year=year+1) }}">Seuraava vuosi ‚Üí</a>
</div>

<!-- Desktop: Year Calendar Grid -->
<div class="year-calendar">
    {% for month in range(1, 13) %}
    <div>
        <h3 style="text-align:center">
            <a href="{{ url_for('calendar_month_view', year=year, month=month) }}" 
               style="text-decoration:none; color:#ff3366;">
               {{ month_names[month] }}
            </a>
        </h3>

        <table class="month-grid">
            <tr>
                <th>Ma</th><th>Ti</th><th>Ke</th><th>To</th><th>Pe</th><th>La</th><th>Su</th>
            </tr>
            {% for week in year_demos[month]['weeks'] %}
            <tr>
                {% for day in week %}
                <td>
                    {% if day != 0 %}
                        <strong>{{ day }}</strong>
                        {% if year_demos[month]['days'].get(day) %}
                        <ul style="padding:0; margin:0; list-style:none;">
                            {% for demo in year_demos[month]['days'][day] %}
                            <li>
                                <a href="{{ url_for('demonstration_detail', demo_id=demo._id) }}" 
                                   class="demo-cell"
                                   data-title="{{ demo.title|e or 'Ei otsikkoa' }}"
                                   data-desc="{{ demo.description|e or '' }}"
                                   data-img="{{ demo.preview_image|e or demo.img|e }}">
                                    {{ demo.title|e or 'Ei otsikkoa' }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endfor %}
</div>

<!-- Mobile: Month List View -->
<div class="mobile-year-list">
    {% set total_events = 0 %}
    {% for month in range(1, 13) %}
        {% set month_event_count = year_demos[month]['days'].values()|map('length')|sum|default(0) %}
        {% set total_events = total_events + month_event_count %}
    {% endfor %}
    
    <!-- Stats -->
    <div class="mobile-stats">
        <div class="mobile-stat-item">
            <span class="mobile-stat-number">{{ year }}</span>
            <span class="mobile-stat-label">Vuosi</span>
        </div>
        <div class="mobile-stat-item">
            <span class="mobile-stat-number">{{ total_events }}</span>
            <span class="mobile-stat-label">Tapahtumaa</span>
        </div>
        <div class="mobile-stat-item">
            <span class="mobile-stat-number">12</span>
            <span class="mobile-stat-label">Kuukautta</span>
        </div>
    </div>
    
    {% for month in range(1, 13) %}
    <div class="mobile-month-section">
        <div class="mobile-month-header">
            <div class="mobile-month-title">{{ month_names[month] }}</div>
            <a href="{{ url_for('calendar_month_view', year=year, month=month) }}" class="mobile-month-link">
                N√§yt√§ kuukausin√§kym√§ ‚Üí
            </a>
        </div>
        
        {% set month_demos_list = [] %}
        {% for day, demos in year_demos[month]['days'].items() %}
            {% for demo in demos %}
                {% set _ = month_demos_list.append((day, demo)) %}
            {% endfor %}
        {% endfor %}
        
        {% if month_demos_list %}
            <div class="mobile-events-grid">
                {% for day, demo in month_demos_list %}
                    <a href="{{ url_for('demonstration_detail', demo_id=demo._id) }}" class="mobile-event-card">
                        <div class="mobile-event-date">{{ day }}. {{ month_names[month] }} {{ year }}</div>
                        <div class="mobile-event-title">{{ demo.title|e or 'Ei otsikkoa' }}</div>
                        {% if demo.description %}
                            <div class="mobile-event-desc">{{ demo.description[:80]|e|safe}}{% if demo.description|length > 80 %}...{% endif %}</div>
                        {% endif %}
                        {% if demo.preview_image or demo.img %}
                            <img src="{{ demo.preview_image|e or demo.img|e }}" alt="{{ demo.title|e }}" class="mobile-event-image">
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="mobile-empty-month">
                üìÖ Ei tapahtumia t√§ss√§ kuussa
            </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div id="demo-preview" aria-hidden="true"></div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
$(function() {
    // Check if mobile view
    const isMobileView = window.matchMedia('(max-width: 768px)').matches;
    
    if (isMobileView) {
        // Skip desktop features on mobile
        return;
    }

    // ---------------------------
    // Onboarding (Desktop only)
    // ---------------------------
    if (!localStorage.getItem('calendarOnboardingDone')) {
        const $overlay = $('#calendar-onboarding');
        const $tooltip = $overlay.find('.onboarding-tooltip');
        let stepIndex = 0;

        const steps = [
            {
                selector: '.calendar-year-nav', 
                title: 'Vuosinavigaatio', 
                text: 'Klikkaa nuolia siirty√§ksesi edelliseen tai seuraavaan vuoteen.'
            },
            {
                selector: '.year-calendar a', 
                title: 'Kuukausilinkit', 
                text: 'Klikkaa kuukauden nime√§ siirty√§ksesi kuukausin√§kym√§√§n.'
            },
            {
                selector: '.demo-cell:first', 
                title: 'Mielenosoitukset', 
                text: 'Klikkaa mielenosoituksen nime√§ siirty√§ksesi yksitt√§isen mielenosoituksen sivulle.'
            }
        ];

        function showStep(index) {
            const step = steps[index];
            const $el = $(step.selector).first();
            if(!$el.length) return;

            $tooltip.find('strong').text(step.title);
            $tooltip.find('p').text(step.text);

            $overlay.fadeIn(200).css('z-index',1000002);

            // Temporarily show tooltip off-screen to measure
            $tooltip.css({ top: -9999, left: -9999, display: 'block' });

            const offset = $el.offset();
            const elHeight = $el.outerHeight();
            const elWidth = $el.outerWidth();
            const tooltipHeight = $tooltip.outerHeight();
            const tooltipWidth = $tooltip.outerWidth();

            // Calculate tooltip position dynamically
            let top = offset.top - tooltipHeight - 12;
            if (top < $(window).scrollTop() + 10) {
                top = offset.top + elHeight + 12;
            }

            let left = offset.left + elWidth / 2 - tooltipWidth / 2;
            if (left < 10) left = 10;
            if (left + tooltipWidth > $(window).width() - 10) left = $(window).width() - tooltipWidth - 10;

            $tooltip.css({ top: top + 'px', left: left + 'px', 'z-index': 1000003 });
        }

        $tooltip.find('.onboarding-next').on('click', function() {
            stepIndex++;
            if(stepIndex < steps.length){
                showStep(stepIndex);
            } else {
                $overlay.fadeOut(300);
                localStorage.setItem('calendarOnboardingDone','true');
            }
        });

        showStep(stepIndex);
        $(window).on('resize scroll', function() {
            showStep(stepIndex);
        });
    }

    // ---------------------------
    // Demo preview hover
    // ---------------------------
    const preview = $('#demo-preview');
    let hoverTimeout;

    function showPreview(el) {
        const title = el.data('title');
        const desc = el.data('desc');
        const img = el.data('img');

        let html = '';
        if(img) html += `<img src="${img}" alt="${title}">`;
        html += `<strong>${title}</strong>`;
        if(desc) html += `<p>${desc}</p>`;
        preview.html(html).fadeIn(200);
    }

    $('.demo-cell').on('mouseenter', function(e) {
        hoverTimeout = setTimeout(() => showPreview($(this)), 150);
    });

    $('.demo-cell').on('mouseleave', function() {
        clearTimeout(hoverTimeout);
        preview.fadeOut(200);
    });

    $('.demo-cell').on('mousemove', function(e) {
        const offset = 15;
        const windowWidth = $(window).width();
        const windowHeight = $(window).height();
        const previewWidth = preview.outerWidth();
        const previewHeight = preview.outerHeight();
        let left = e.pageX + offset;
        let top = e.pageY + offset;
        if(left + previewWidth > windowWidth) left = e.pageX - previewWidth - offset;
        if(top + previewHeight > windowHeight) top = e.pageY - previewHeight - offset;
        preview.css({ top: top + 'px', left: left + 'px' });
    });

    // ---------------------------
    // Prefetch month links
    // ---------------------------
    $('.calendar-year-nav a').each(function(){
        const url = $(this).attr('href');
        $('<link/>', { rel: 'prefetch', href: url }).appendTo('head');
        $.get(url, data => {}); // cache
    });
});
</script>
{% endblock %}