{% extends 'base.html' %}

{% set formatted_date = demo.get('formatted_date') %}

{% block title %}
{{ demo.get('title', 'Mielenosoitus') }}{% if formatted_date %} – {{ formatted_date }}{% endif %}
{% endblock %}

{% block og_title %}
{{ demo.get('title', 'Mielenosoitus') }}{% if formatted_date %} – {{ formatted_date }}{% endif %}
{% endblock %}

{% block og_description %}
{{ demo.get('description', demo.get('title', 'Mielenosoitus')) ~
' - mielenosoitus kaupungissa ' ~
demo.get('city', 'Tuntematon') ~
('. ' ~ formatted_date if formatted_date else '') }}
{% endblock %}

{% block og_image %}
{{ demo.get('preview_image') or url_for('static', filename='demo_preview/' ~ demo['_id'] ~ '.png', _external=True) }}
{% endblock %}

{% block twitter_title %}
{{ demo.get('title', 'Mielenosoitus') }}{% if formatted_date %} – {{ formatted_date }}{% endif %}
{% endblock %}

{% block twitter_description %}
{{ demo.get('description', 'Mielenosoituksen tiedot.') }}
{% endblock %}

{% block twitter_image %}
{{ demo.get('preview_image') or url_for('static', filename='demo_preview/' ~ demo['_id'] ~ '.png', _external=True) }}
{% endblock %}

{% block meta %}
<!-- Event Meta -->
<meta property="og:event:start_time" content="{{ demo.get('start_time', '00:00:00') }}" />
<meta property="og:event:end_time" content="{{ demo.get('end_time', '23:59:00') }}" />
<meta property="og:event:location"
  content="{{ demo.get('address', 'Tuntematon osoite') ~ ', ' ~ demo.get('city', 'Tuntematon') }}" />

<!-- Article Meta -->
<meta property="article:author"
  content="{{ demo['organizers'][0]['name'] if demo.get('organizers') else 'Tuntematon kirjoittaja' }}" />
<meta property="article:section" content="{{ demo.get('section', 'Tapahtumat') }}" />
{% set tags = demo.get('tags') or ['mielenosoitus', 'tapahtuma'] %}
{% for tag in tags %}
<meta property="article:tag" content="{{ tag }}" />
{% endfor %}

<!-- JSON-LD Structured Data -->
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Event",
    "name": "{{ demo.get('title', 'Tuntematon tapahtuma') }}",
    "startDate": "{{ demo.get('date', '') }}T{{ demo.get('start_time', '00:00:00') }}",
    "endDate": "{{ demo.get('date', '') }}T{{ demo.get('end_time', '23:59:00') }}",
    "location": {
      "@type": "Place",
      "name": "{{ demo.get('address', 'Tuntematon paikka') }}",
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": "{{ demo.get('latitude', '') }}",
        "longitude": "{{ demo.get('longitude', '') }}"
      }
    },
    "description": "{{ demo.get('description', 'Mielenosoituksen tiedot.') }}",
    "image": "{{ demo.get('preview_image') or url_for('screenshot', demo_id=demo['_id'], _external=True) }}",
    "url": "{{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}",
    "organizer": {
      "@type": "Organization",
      "name": "{{ demo['organizers'][0]['name'] if demo.get('organizers') else 'Tuntematon' }}",
      "url": "{{ url_for('org', org_id=demo['organizers'][0]['organization_id']) if demo.get('organizers') and demo['organizers'][0].get('organization_id') else '#' }}"
    }
  }
  </script>
{% endblock %}




{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='/css/toolbox.css' )}}" />
<!--<link rel="stylesheet" href="{{ url_for('static', filename='/css/details.css' )}}" />-->
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}" />
<!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/modal.css') }}" />
<style>
  :root {
    --color-bg: light-dark(#f9f9f9, #181a1b);
    --color-bg-hero: light-dark(#e3f0ff, #23272a);
    --color-card-bg: light-dark(#fff, #23272a);
    --color-text: light-dark(#222, #f3f3f3);
    --color-text-secondary: light-dark(#444, #c7c7c7);
    --color-primary: light-dark(#0056b3, #4ea1ff);
    --color-shadow: light-dark(0 2px 12px rgba(0, 0, 0, 0.06), 0 2px 12px rgba(0, 0, 0, 0.3));
    --color-shadow-hover: light-dark(0 4px 16px rgba(0, 86, 179, 0.08), 0 4px 16px rgba(78, 161, 255, 0.12));
    --color-title-accent: light-dark(#e3f0ff, #2a3a4a);
    --primary_color: var(--color-primary);
    --primary_dark_color: light-dark(#003d80, #0056b3);
    --background: var(--color-card-bg);
    --primary_text_color: var(--color-text);
    --primary_strong_text_color: var(--color-primary);
    --box_shadow: var(--color-shadow);
    --yellow: #ffe066;
    --black: light-dark(#222, #f3f3f3);
  }

  .button,
  .btn,
  .btn-primary,
  .btn-warning,
  .btn-secondary {
    background: var(--primary_color) !important;
    color: #fff !important;
    border: 2px solid var(--primary_dark_color) !important;
    border-radius: 2em !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    font-weight: 600;
    transition: background 0.2s, box-shadow 0.2s, color 0.2s;
  }

  .button:hover,
  .btn:hover,
  .btn-primary:hover,
  .btn-warning:hover,
  .btn-secondary:hover {
    background: var(--primary_dark_color) !important;
    color: #fff !important;
    border-color: var(--primary_color) !important;
  }

  /* Modal z-index fix */
  .modal-backdrop {
    z-index: 1000001 !important;
  }

  .modal {
    z-index: 1000002 !important;
  }

  main body {
    background: var(--color-bg);
    color: var(--color-text);
  }

  main .container-main-content {
    background: var(--color-card-bg);
    border-radius: 1.2em;
    box-shadow: var(--box_shadow);
    padding: 2em 1em 2em 1em;
    margin-bottom: 2em;
    margin-top: 1.5em;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }


  /* Element | https://mielenosoitukset.fi/demonstration/68affd4c3896ae7c4985e030 */



  main h1,
  main .subtitle {
    color: var(--primary_color);
    font-weight: 800;
    letter-spacing: 0.01em;
    text-align: center;
  }

  main h1 {
    font-size: 2.1em;
    margin-bottom: 0.5em;
  }

  main .subtitle {
    font-size: 1.5em;
    margin-bottom: 0.7em;
  }

  main .button-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
  }

  main .button {
    background-color: var(--primary_color);
    color: #fff;
    padding: 0.7em 1.5em;
    border: 2px solid var(--primary_dark_color);
    border-radius: 2em;
    cursor: pointer;
    text-decoration: none;
    font-size: 1.05em;
    font-weight: 600;
    transition: background 0.2s, box-shadow 0.2s, color 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  main .button:hover {
    background-color: var(--primary_dark_color);
    color: #fff;
    box-shadow: var(--color-shadow-hover);
    filter: brightness(1.08);
    border-color: var(--primary_color);
  }

  main .like-count {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 1em;
    color: var(--primary_strong_text_color);
  }

  main .like-count i {
    color: var(--primary_color);
  }

  main .topics ul {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  main .topics .tag {
    background-color: var(--primary_color);
    color: #fff;
    padding: 5px 10px;
    border-radius: 5px;
    text-decoration: none;
    transition: transform 0.2s, background-color 0.2s;
  }

  main .topics .tag:hover {
    background-color: var(--primary_dark_color);
    transform: translateY(-2px);
  }

  main #basicshit {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    margin-bottom: 20px;
  }

  main #basicshit h1 {
    margin: 10px 0;
    padding: 0;
    font-size: 2.5em;
    color: var(--primary_strong_text_color);
  }

  .dark .repeating-alert.mt-3 {
    color: black;
  }

  main #basicshit img {
    max-width: 100%;
    max-height: 400px;
    margin: 10px 0;
    border-radius: 10px;
  }

  main #date {
    font-size: 1.2em;
    margin: 0;
    padding: 0;
    color: var(--primary_strong_text_color);
  }

  main .container {
    margin-top: 20px;
    padding: 20px;
    background: var(--background);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    text-align: center;
    border: none;
    margin-bottom: 24px;
  }

  main .container:last-child {
    margin-bottom: 0;
  }

  main #orginfo,
  main #infocontainer {
    border: none;
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.04);
    background: var(--color-title-accent);
    border-radius: 0.7em;
    margin-bottom: 24px;
  }

  main .repeating-alert {
    border: none;
    box-shadow: none;
    background-color: var(--yellow);
    color: var(--black);
    padding: 1em;
    border-radius: 0.5em;
    text-align: center;
    margin-top: 1em;
  }

  main .repeating-alert strong {
    font-size: 1.2em;
    display: block;
  }

  main .display-all {
    display: block;
    margin-top: 0.5em;
  }

  #report-selection-btn {
    position: absolute;
    z-index: 2000;
    display: none;
    padding: 6px 14px;
    background: #ffc107;
    color: #222;
    border: none;
    border-radius: 5px;
    font-size: 1em;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    transition: background 0.2s;
    pointer-events: auto;
  }

  #report-selection-btn:hover {
    background: #ffdb5c;
  }

  #reminder-modal .modal-content {
    background: var(--color-card-bg);
    color: var(--color-text);
    border-radius: 1em;
    box-shadow: var(--box_shadow);
  }

  #reminder-modal .modal-header,
  #reminder-modal .modal-footer {
    background: var(--color-title-accent);
    color: var(--primary_color);
    border-top-left-radius: 1em;
    border-top-right-radius: 1em;
  }

  #reminder-modal .modal-title {
    color: var(--primary_color);
  }

  #reminder-modal .form-control {
    background: var(--background);
    color: var(--primary_text_color);
    border: 1px solid var(--primary_color);
  }

  #reminder-modal .form-control:focus {
    border-color: var(--primary_dark_color);
    box-shadow: 0 0 0 2px var(--primary_color);
  }

  #reminder-modal input.form-control::placeholder {
    color: var(--color-text-secondary);
    opacity: 1;
  }

  .modal input.form-control:focus {
    border-color: var(--primary_dark_color);
    box-shadow: 0 0 0 2px var(--primary_color);
  }

  .modal input.form-control::placeholder,
  textarea.form-control::placeholder {
    color: var(--color-text-secondary);
    opacity: 1;
  }

  #reminder-modal .button {
    background: var(--primary_color);
    color: #fff;
  }

  #reminder-modal .button:hover {
    background: var(--primary_dark_color);
  }

  /* Popup/modal base styles */

  .button,
  .btn-primary,
  .btn-warning,
  .btn-secondary {
    background: var(--primary_color) !important;
    color: #fff !important;
    border: none;
  }

  .button:hover,
  .btn-primary:hover,
  .btn-warning:hover,
  .btn-secondary:hover {
    background: var(--primary_dark_color) !important;
  }

  .alert-success,
  .alert-danger {
    color: var(--primary_text_color);
    background: var(--color-title-accent);
    border: 1px solid var(--primary_color);
  }

  .button-container.reminder-top {
    justify-content: flex-start;
    position: relative;
  }

  .organizer-info p {
    color: #444;
  }


  .demo-cover-picture img {
    /* object-fit: cover; */
    object-fit: scale-down !important;
    aspect-ratio: 16 / 9 !important;
  }

  #main * {
    box-sizing: border-box;
  }

  /* Ensure all modals are above the header */
</style>
{% endblock %}

{% block content %}
<div class="container-main-content">

  <!-- Make sure to include Font Awesome in your <head> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <main id="main">
    <div class="button-container" style="margin-bottom: 1.2em;">
      <button class="button btn btn-warning" data-bs-toggle="modal" data-bs-target="#report-modal">
        <i class="fa fa-question-circle"></i> {{ _('Ilmoita virheestä') }}
      </button>
    </div>

    <!-- IMAGE -->
    {% if demo['img'] and not demo['img'] == 'None' %}
    <img src="{{ demo['img'] }}" alt="{{ demo['title'] }}" />
    {% endif %}

    {% if demo.cover_picture and not demo.cover_picture == 'None' %}
    <div class="demo-cover-picture">
      <img src="{{ demo.cover_picture }}" alt="Cover Photo" style="width:100%;max-height:350px;object-fit:cover;">
    </div>
    {% endif %}

    <section id="basicshit" class="mb-4">
      <h1 class="display-4 fw-bold mb-2">{{ demo['title'] }}</h1>
      <p id="date" class="lead text-primary mb-0">
        {{ demo['date'] | date('%d.%m.%Y') }}
        {% if demo['end_time'] %}
        {{ _('klo') }} {{ demo['start_time'] | time('%H:%M') }} - {{ demo['end_time'] | time('%H:%M') }}
        {% else %}
        {{ _('klo') }} {{ demo['start_time'] | time('%H:%M') }} {{ _('alkaen') }}
        {% endif %}
      </p>
    </section>

    <nav class="button-container flex-wrap mb-3" aria-label="Pikatoiminnot">
      <a href="https://www.facebook.com/sharer/sharer.php?u={{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}"
        target="_blank" class="button btn btn-primary d-flex align-items-center gap-2"
        aria-label="{{ _('Jaa Facebookissa') }}">
        <i class="fab fa-facebook-f"></i> {{ _('Jaa Facebookissa') }}
      </a>
      <a href="https://twitter.com/intent/tweet?url={{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}&text={{ demo['title'] }}"
        target="_blank" class="button btn btn-primary d-flex align-items-center gap-2" aria-label="{{ _('Jaa Xssä') }}">
        <i class="fab fa-x-twitter"></i> {{ _('Jaa Xssä') }}
      </a>
      <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}&title={{ demo['title'] }}"
        target="_blank" class="button btn btn-primary d-flex align-items-center gap-2"
        aria-label="{{ _('Jaa LinkedInissä') }}">
        <i class="fab fa-linkedin-in"></i> {{ _('Jaa LinkedInissä') }}
      </a>
      <!--
      <a href="{{ url_for('download_material', demo_id=demo['_id']) }}" class="button btn btn-primary d-flex align-items-center gap-2" aria-label="{{ _('Lataa graafinen materiaali') }}">
        <i class="fas fa-download"></i> {{ _('Lataa graafinen materiaali') }}
      </a>-->

      <button type="button" class="button btn btn-primary d-flex align-items-center gap-2" id="open-reminder-btn"
        data-bs-toggle="modal" data-bs-target="#reminder-modal" aria-label="{{ _('Tilaa muistutus sähköpostiisi') }}">
        <i class="fas fa-bell"></i> {{ _('Tilaa muistutus sähköpostiisi') }}
      </button>
    </nav>
    <section
      class="d-flex flex-column align-items-center justify-content-center py-3 px-2 border rounded bg-light-dark() text-light-dark() w-auto mx-auto"
      style="max-width: 250px;" aria-label="{{ _('Osallistuminen') }}">

      <button id="like-button"
        class="btn btn-primary like-button d-flex align-items-center gap-2 mb-2 position-relative"
        onclick="handleLikeClick('{{ demo['_id'] }}')" aria-pressed="false">
        <i class="fas fa-thumbs-up"></i>
        <span id="like-btn-text">{{ _('Osallistun') }}</span>

        {% if not current_user.is_authenticated %}
        <!-- login prompt tooltip -->
        <span
          class="login-prompt position-absolute top-100 start-50 translate-middle mt-1 px-2 py-1 rounded shadow text-white bg-dark"
          style="display:none; white-space: nowrap; z-index:1000;">
          {{ _('Kirjaudu sisään osallistuaksesi') }}
        </span>
        {% endif %}
      </button>

      <div class="like-count d-flex align-items-center gap-1">
        <i class="fas fa-users text-secondary"></i>
        <span id="like-count" class="fw-bold" style="transition: transform 0.3s ease;">{{ demo['likes'] }}</span>
      </div>
    </section>

    <script>
      // handle ?action=like in URL
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'like') {
          handleLikeClick('{{ demo["_id"] }}');
        }
        if (urlParams.has('action')) {
          urlParams.delete('action');
          const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
          window.history.replaceState({}, document.title, newUrl);
        }
      });

      function handleLikeClick(demoId) {
        {% if not current_user.is_authenticated %}
        window.location.href = "{{ url_for('users.auth.login') }}?next={{ request.path }}?action=like";
        return;
        {% else %}
        toggleLike(demoId, true); // pass 'true' to trigger animation
        {% endif %}
      }

      {% if not current_user.is_authenticated %}
      const likeButton = document.getElementById("like-button");
      const loginPrompt = likeButton.querySelector(".login-prompt");

      likeButton.addEventListener("mouseenter", () => loginPrompt.style.display = "block");
      likeButton.addEventListener("mouseleave", () => loginPrompt.style.display = "none");
      {% endif %}

      // bounce animation on count
      function animateLikeCount() {
        const count = document.getElementById("like-count");
        count.style.transform = "scale(1.4)";
        setTimeout(() => count.style.transform = "scale(1)", 300);
      }
    </script>



    <hr style="margin: 20px 0;">

    {% if demo["tags"] and demo["tags"]|length > 0 %}
    <nav class="topics mb-3" aria-label="Tunnisteet">
      <ul>
        {% for tag in demo["tags"] %}
        <li>
          <a href="{{ url_for('tag_detail', tag_name=tag) }}" class="tag" aria-label="#{{ tag }}">
            #{{ tag }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </nav>
    {% endif %}

    {% if demo['description'] %}
    <section class="container mb-4" aria-label="Kuvaus">
      <h2 class="subtitle">{{ _('Mielenosoituksen esittelyteksti') }}</h2>
      <div class="fs-5">{{ demo['description']|safe }}</div>
    </section>
    {% endif %}

    <section class="countdown mb-4" aria-label="Ajanlaskuri">
      <h2 class="subtitle">{{ _('Aikaa mielenosoituksen alkuun') }}</h2>
      <div id="timer" class="fs-4 text-center text-primary"></div>
    </section>

    <section class="container mt-4 mb-4" aria-label="Sijainti ja reitti">
      <h2 class="subtitle text-center">{{ _('Sijainti') }}</h2>
      <p class="text-center mb-2">{{ demo['address'] }}, {{ demo['city'] }}</p>
      {% if demo['route'] and demo['route'] != 'None' %}
      <div class="route mt-3 mb-3">
        <p><strong>{{ _('Marssin reitti:') }}</strong></p>
        {% if demo['route'] is string %}
        <p>{{ demo['route'] }}</p>
        {% elif demo['route'] is iterable %}
        <ol class="list-group list-group-numbered">
          {% for step in demo['route'] %}
          <li class="list-group-item">{{ step }}</li>
          {% endfor %}
        </ol>
        {% endif %}
      </div>
      {% endif %}
      <div class="map mt-4 d-flex justify-content-center">
        <div id="map-container" style="position:relative; width: 100%; max-width: 700px; margin: 0 auto;">
          <div id="map" class="rounded shadow" style="height: 350px; width: 100%; min-width: 250px;"></div>
        </div>
      </div>
    </section>

    <section id="subcontainer1" class="mb-4 container">

      {% if demo['facebook'] or demo['recurs'] %}
      <section id="infocontainer" class="mb-4" aria-label="Lisätiedot">
        <h2 class="subtitle mb-3">{{ _('Lisätiedot') }}</h2>
        <div class="row g-3">

          {% if demo['facebook'] %}
          <div class="col-12 col-md-6">
            <a class="btn btn-facebook w-100 d-flex align-items-center justify-content-center animate-btn"
              href="{{ demo['facebook'] }}" target="_blank">
              <i class="fab fa-facebook me-2"></i> {{ _('Facebook-tapahtuma') }}
            </a>
          </div>
          {% endif %}

          {% if demo["recurs"] and demo['repeat_schedule'] %}
          <div class="col-12 col-md-6">
            <div class="alert alert-info p-3 d-flex flex-column justify-content-between h-100 animate-badge">
              <div>
                <strong>{{ _('Mielenosoitus toistuu säännöllisesti') }}</strong>
                <div class="mt-1">{{ toistuvuus }}</div>


              </div>
              <a href="{{ url_for('siblings_meeting', parent=demo['parent']) }}"
                class="btn btn-outline-primary mt-3 w-100 animate-btn">
                <i class="fas fa-arrow-right"></i> {{ _('Näytä seuraavat') }}
              </a>
            </div>
          </div>
          {% endif %}

        </div>
      </section>
      {% endif %}

      <section id="orginfo" class="mb-4" aria-label="Järjestäjät">
        <h2 class="subtitle mb-3">{{ _('Järjestäjät') }}</h2>
        <div class="row g-4" id="organizers-list">

          {% if demo['organizers'] and demo['organizers']|length > 0 %}
          {% for org in demo['organizers'] %}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0 bg-card text-card animate-card">
              <div class="card-body">
                <h5 class="card-title mb-2"><i class="fas fa-user me-2"></i>{{ org.name }}</h5>

                {% if org.organization_id and org.organization_id != "None" %}

                <a href="{{ org.url if org.url else '/organization/' ~ org._id }}"
                  class="btn btn-sm btn-outline-primary d-flex align-items-center" target="_blank"
                  rel="noopener noreferrer">
                  <i class="fas fa-id-badge me-1"></i> {{ _('Mielenosoitukset.fi -profiili') }}
                </a>
                {% endif %}


                {% if org.website %}
                <p class="mb-2">
                  <i class="fas fa-globe me-1 text-secondary"></i>
                  <a href="{{ org.website }}" target="_blank" class="text-link">{{ org.website }}</a>
                </p>
                {% endif %}

                {% if org.email %}
                <p class="mb-2">
                  <i class="fas fa-envelope me-1 text-secondary"></i>
                  <a href="mailto:{{ org.email }}" class="text-link">{{ org.email }}</a>
                </p>
                {% endif %}

              </div>

              {% if org.tags %}
              <div class="card-footer bg-card-footer">
                {% for tag in org.tags %}
                <span class="badge bg-secondary me-1 animate-badge">{{ tag }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="col-12">
            <div class="alert alert-secondary">{{ _('Ei järjestäjätietoja saatavilla.') }}</div>
          </div>
          {% endif %}

        </div>
      </section>
    </section>

    <style>
      /* Cards and text using light-dark() for automatic theme switch */
      .bg-card {
        background-color: light-dark(#fff, #1c1c1c);
        color: light-dark(#212529, #e9ecef);
        border-radius: 0.75rem;
      }

      .text-card {
        color: inherit;
      }

      .bg-card-footer {
        background-color: light-dark(#f8f9fa, #2c2c2c);
      }

      /* Alerts, badges, buttons */
      .alert-info {
        background-color: light-dark(#e7f1ff, #2a2a3a);
        color: light-dark(#0d6efd, #a0c4ff);
      }

      .badge {
        background-color: light-dark(#6c757d, #495057);
        color: #fff;
      }

      .btn-outline-primary {
        color: light-dark(#0d6efd, #74b9ff);
        border-color: light-dark(#0d6efd, #74b9ff);
      }

      .btn-outline-primary:hover {
        background-color: light-dark(#0d6efd, #74b9ff);
        color: #fff;
      }

      /* Facebook button */
      .btn-facebook {
        background-color: #1877f2;
        color: #fff;
      }

      .btn-facebook:hover {
        background-color: #145dbf;
      }

      /* Animations and hover effects */
      .animate-badge {
        animation: pop-in 0.4s ease forwards;
      }

      .animate-btn {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .animate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .animate-card {
        animation: fade-in 0.5s ease forwards;
      }

      .animate-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }

      /* Keyframes */
      @keyframes pop-in {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }

        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes fade-in {
        0% {
          opacity: 0;
          transform: translateY(10px);
        }

        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Links */
      .text-link {
        color: inherit;
        text-decoration: none;
      }

      .text-link:hover {
        text-decoration: underline;
      }
    </style>


    <nav class="d-flex justify-content-center flex-wrap gap-2 mb-3" aria-label="Linkit takaisin">
      {% if request.referrer is defined %}
      <a href="{{ request.referrer }}" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left me-1"></i>{{ _('Takaisin edelliselle sivulle') }}
      </a>
      {% endif %}

      <a href="{{ url_for('demonstrations') }}" class="btn btn-primary">
        <i class="fa-solid fa-list me-1"></i>{{ _('Takaisin kaikkiin mielenosoituksiin') }}
      </a>
    </nav>


    </section>
    <button id="report-selection-btn" type="button">{{ _('Ilmoita virheestä tästä kohdasta') }}</button>

    <!-- MODALS -->
    {% import '_modals/reminder-modal.html' as reminder_modal %}
    {{ reminder_modal.render_reminder_modal(demo) }}

    {% import '_modals/report-error-modal.html' as report_modal %}
    {{ report_modal.render_report_error_modal(demo) }}

    {% import '_modals/past-demo-modal.html' as past_demo_modal %}
    {{ past_demo_modal.render_past_demo_modal(demo) }}

  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
  /**
   * Checks if the demonstration date is in the past and shows a warning popup.
   * THIS IS THE FIXED VERSION.
   * Changelog:
   * - Changed demoDate to demoEnds for clarity
   * - Added handling for missing end_time
   * - Improved comments and code readability
   * Parameters
   * ----------
   * None.
   * 
   * Returns
   * -------
   * None.
   */
  document.addEventListener("DOMContentLoaded", () => {
    demo_endtime = "{{ demo['end_time'] if demo['end_time'] else '23:59:59' }}";
    if (demo_endtime === "None") {
      demo_endtime = "23:59:59"; // Default to end of day if end_time is "None"
    }
    // if demo['end_time'] is None, assume it ends at 23:59:59, it might also be formatted as a string "None"
    const demoEnds = new Date("{{ demo['date'] }}T" + demo_endtime);
    console.log("{{ demo['end_time'] }}");
    const now = new Date();

    // Show the modal if the demo has already ended

    if (demoEnds < now) {
      const pastDemoModal = new bootstrap.Modal(document.getElementById("past-demo-modal"));
      pastDemoModal.show();
    }
  });
</script>

<script>
  // Data initialization: use a single demo object for clarity
  var demoData = {{ demo | tojson | safe }};

  // could we put it in window.demoData = ... ?

  function _has_coords(demo) {
    return demo.latitude && demo.longitude;
  }


  // Map Initialization if location data is available
  document.addEventListener("DOMContentLoaded", function () {
    if (_has_coords(demoData)) {
      // Initialize the map

      const map = L.map("map", {
        center: [demoData.latitude, demoData.longitude],
        zoom: 13,
        scrollWheelZoom: false,
        zoomControl: true,
        attributionControl: true,
      });
      map.invalidateSize();
      setTimeout(() => { map.invalidateSize(); }, 300);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);
      L.marker([demoData.latitude, demoData.longitude])
        .addTo(map)
        .bindPopup(demoData.address)
        .openPopup();
    } else {
      // Remove the map container if no coordinates are available
      const mapElement = document.getElementById("map");
      if (mapElement) {
        mapElement.remove();
      }
      console.warn("No coordinates available for the demonstration.");
      const mapContainer = document.getElementById("map-container");
      if (mapContainer) {
        const noLocationMsg = document.createElement("p");
        noLocationMsg.textContent = "{{ _('Sijaintitietoja ei ole saatavilla.') }}";
        noLocationMsg.style.textAlign = "center";
        mapContainer.appendChild(noLocationMsg);
      }
    }
  });

</script>
<script>
  /**
   * Updates the countdown to the event using ISO-8601 date.
   *
   * Parameters
   * ----------
   * None.
   *
   * Returns
   * -------
   * None.
   */
  document.addEventListener("DOMContentLoaded", function () {
    function updateCountdown() {
      const demoDate = demoData.date; // ISO-8601 format (yyyy-mm-dd)
      const demoTime = demoData.start_time;
      const demoEnds = demoData.end_time || null;
      // TODO: If the end time is missing, assume it ends 23.59:59
      if (!demoEnds || demoEnds === "None") {
        // we cant just set const demoEnds again, so we use let instead
        let demoEnds = "23:59:59";
      }
      // Directly combine ISO-8601 date and time
      const eventDateStr = `${demoDate}T${demoTime}`;
      const eventDate = new Date(eventDateStr);
      const now = new Date();
      const timeRemaining = eventDate - now;
      const time_until_end = new Date(`${demoDate}T${demoEnds}`) - now;
      const timerElement = document.getElementById("timer");

      if (!timerElement) return;

      if (timeRemaining <= 0 && time_until_end >= 0) { // Event is ongoing
        timerElement.innerText = "{{ _('Mielenosoitus on käynnissä!') }}";
        return;
      }

      if (time_until_end <= 0) {
        timerElement.innerText = "{{ _('Mielenosoitus on päättynyt.') }}";
        return;
      }

      const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

      timerElement.innerText = `${days} {{ _('päivää') }} ${hours} {{ _('tuntia') }} ${minutes} {{ _('minuuttia') }} ${seconds} {{ _('sekuntia') }}`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();
  });

</script>


<!-- Leaflet JS and Map Integration -->
<script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
<script>
  window.demoId = "{{ demo['_id'] }}";
</script>
<script src="{{ url_for('static', filename='js/admin_demo_info.js') }}"></script>
<!--<link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css' )}}">-->


<script>
  /**
   * Shows a floating "report error" button when user selects text.
   *
   * Parameters
   * ----------
   * None.
   *
   * Returns
   * -------
   * None.
   */
  document.addEventListener("DOMContentLoaded", function () {
    const reportBtn = document.getElementById("report-selection-btn");
    let selectedText = "";

    function showReportBtnAtSelection() {
      const selection = window.getSelection();
      selectedText = selection && selection.toString().trim();
      if (selectedText && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        // Only show if selection is in main content
        const main = document.getElementById("main");
        // Check if anchorNode is inside main
        let node = selection.anchorNode;
        let insideMain = false;
        while (node) {
          if (node === main) {
            insideMain = true;
            break;
          }
          node = node.parentNode;
        }
        if (insideMain) {
          reportBtn.style.display = "block";
          reportBtn.style.position = "absolute";
          // Position button above selection, or below if near top
          const scrollY = window.scrollY || window.pageYOffset;
          const scrollX = window.scrollX || window.pageXOffset;
          let top = rect.top + scrollY - reportBtn.offsetHeight - 8;
          if (top < 0) {
            top = rect.bottom + scrollY + 8;
          }
          reportBtn.style.top = top + "px";
          reportBtn.style.left = (rect.left + scrollX) + "px";
        } else {
          reportBtn.style.display = "none";
        }
      } else {
        reportBtn.style.display = "none";
      }
    }

    document.addEventListener("mouseup", function (e) {
      setTimeout(showReportBtnAtSelection, 10);
    });

    // Hide button on scroll or click elsewhere
    document.addEventListener("scroll", function () {
      reportBtn.style.display = "none";
    });
    document.addEventListener("mousedown", function (e) {
      if (!reportBtn.contains(e.target)) {
        reportBtn.style.display = "none";
      }
    });

    // When user clicks the floating report button, open modal and prefill error field
    reportBtn.addEventListener("click", function () {
      var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("report-modal"));
      modal.show();
      var textarea = document.getElementById("error");
      if (textarea && selectedText) {
        textarea.value = "{{ _('Virheellinen kohta:') }}\n" + selectedText + "\n\n";
        textarea.focus();
      }
      reportBtn.style.display = "none";
      window.getSelection().removeAllRanges();
    });
  });
</script>

<script>
  /**
   * Gets a cookie value by name.
   */
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  let liked = getCookie(`liked_{{ demo._id }}`) === 'true';
  let likeRequestInProgress = false;

  /**
   * Shows a loading overlay on the button.
   */
  function showButtonLoading(button) {

    button.disabled = true;
    button.classList.add("processing");
    const textEl = button.querySelector(".like-btn-text");
    if (textEl) textEl.textContent = "{{ _('Käsitellään...') }}";
    else {
      button.textContent = "{{ _('Käsitellään...') }}";
    }
  }

  /**
   * Hides the loading overlay on the button.
   */
  function hideButtonLoading(button) {
    button.disabled = false;
    button.classList.remove("processing");
    const textEl = button.querySelector(".like-btn-text");
    if (textEl) textEl.textContent = "{{ _('Osallistun') }}";
    else {
      button.textContent = "{{ _('Osallistun') }}";
    }
  }

  /**
   * Toggles the like state for the demonstration.
   */
  async function toggleLike(demoId) {
    if (likeRequestInProgress) return;
    likeRequestInProgress = true;

    const likeButton = document.getElementById("like-button");
    const likeCountEl = document.getElementById("like-count");
    showButtonLoading(likeButton);

    try {
      const url = liked
        ? `/api/demonstrations/${demoId}/unlike`
        : `/api/demonstrations/${demoId}/like`;

      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include"
      });

      const data = await response.json();

      // Update UI
      likeCountEl.textContent = data.likes;
      liked = !liked;
      document.cookie = `liked_${demoId}=${liked}; path=/`;
      likeButton.setAttribute("aria-pressed", liked ? "true" : "false");
      liked
        ? likeButton.classList.add("liked")
        : likeButton.classList.remove("liked");

    } catch (err) {
      console.error("Like request failed:", err);
    } finally {
      hideButtonLoading(likeButton);
      likeRequestInProgress = false;
    }
  }

  /**
   * Fetches the current like count and updates the UI.
   */
  async function getLikes(demoId) {
    const likeCountEl = document.getElementById("like-count");
    const likeButton = document.getElementById("like-button");

    try {
      const response = await fetch(`/api/demonstrations/${demoId}/likes`, {
        method: "GET",
        credentials: "include"
      });
      const data = await response.json();
      likeCountEl.textContent = data.likes;

      // Set initial button state
      likeButton.setAttribute("aria-pressed", liked ? "true" : "false");
      if (liked) likeButton.classList.add("liked");

    } catch (err) {
      console.error("Fetching likes failed:", err);
    } finally {
      hideElementLoading("like-button-container");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Load likes after DOM ready
    getLikes("{{ demo['_id'] }}");
  });
</script>

{% endblock %}