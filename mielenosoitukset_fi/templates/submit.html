{% extends 'base.html' %}

{% block title %} {{_('Ilmoita mielenosoituksesta') }} {%endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/toolbox.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/buttons.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/submit.css') }}" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/ck.css') }}" />
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.2.0/ckeditor5.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- import jquery -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/gen.css') }}" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn2.mielenosoitukset.fi/cropperjs/cropper.min.js"></script>
<style>
  :root {
    --color-bg: light-dark(#f8fafc, #0f1419);
    --color-card-bg: light-dark(#ffffff, #1a1d23);
    --color-text: light-dark(#1e293b, #e2e8f0);
    --color-text-secondary: light-dark(#64748b, #94a3b8);
    --color-primary: light-dark(#0052cc, #3b82f6);
    --color-primary-hover: light-dark(#003d99, #2563eb);
    --color-secondary: light-dark(#ff6b00, #f97316);
    --color-secondary-hover: light-dark(#e55a00, #ea580c);
    --color-accent: light-dark(#06b6d4, #0891b2);
    --color-success: light-dark(#10b981, #34d399);
    --color-border: light-dark(#e2e8f0, #374151);
    --color-shadow: light-dark(0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 10px 15px -3px rgba(0, 0, 0, 0.3));
    --color-shadow-lg: light-dark(0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 25px 50px -12px rgba(0, 0, 0, 0.4));
    --color-gradient-primary: linear-gradient(135deg, #0052cc 0%, #003d99 100%);
    --color-gradient-secondary: linear-gradient(135deg, #ff6b00 0%, #e55a00 100%);
    --color-gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --border-radius: 16px;
    --border-radius-lg: 24px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    box-sizing: border-box;
  }

  body {
    background: var(--color-bg);
    color: var(--color-text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    line-height: 1.7;
    margin: 0;
    font-feature-settings: 'liga' 1, 'kern' 1;
  }

  .container-main-content {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 2rem;
  }

  /* Hero Section - Compact */
  .hero-section {
    background: var(--color-gradient-primary);
    border-radius: var(--border-radius-lg);
    padding: 2.5rem 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: var(--color-shadow-lg);
    margin-bottom: 2rem;
  }

  .hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
    pointer-events: none;
  }

  .hero-content {
    position: relative;
    z-index: 2;
    max-width: 600px;
    margin: 0 auto;
  }

  .hero-section h1 {
    color: white;
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 800;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  .hero-section .lead {
    color: rgba(255, 255, 255, 0.95);
    font-size: 1rem;
    margin: 0;
    line-height: 1.6;
  }

  /* Progress Bar */
  .progress-container {
    background: var(--color-card-bg);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--color-shadow);
    border: 1px solid var(--color-border);
  }

  @media screen and (max-width: 768px) {
    .progress-container {
      background: var(--color-card-bg);
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0px 0px;
      padding: 2rem 1rem;
      padding-bottom: 1rem;
      margin: 0px;

      box-shadow: var(--color-shadow);
      border: 1px solid var(--color-border);
      display: fixed;
      margin-bottom: 0px;
      position: absolute;
      bottom: 0;
      display: block;
      z-index: 200;
      width: 100vw;
      left: 0;
      height: min-content;
      /* ignore touch and click events */
      pointer-events: none;

    }
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 1rem;
  }

  .progress-line {
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--color-border);
    z-index: 1;
  }

  .progress-line-fill {
    height: 100%;
    background: var(--color-gradient-primary);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 2px;
  }

  .progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    z-index: 2;
    flex: 1;
  }

  @media screen and (max-width: 768px) {
    .progress-step {
      font-size: 0.75rem;
      gap: 0.5rem;
    }
  }

  .step-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--color-card-bg);
    border: 3px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    color: var(--color-text-secondary);
    transition: var(--transition);
    position: relative;
  }

  .progress-step.completed .step-circle {
    background: var(--color-gradient-success);
    border-color: var(--color-success);
    color: white;
  }

  .progress-step.active .step-circle {
    background: var(--color-gradient-primary);
    border-color: var(--color-primary);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
  }

  .step-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-align: center;
    transition: var(--transition);
  }

  .progress-step.active .step-label {
    color: var(--color-primary);
  }

  .progress-step.completed .step-label {
    color: var(--color-success);
  }

  .step-icon {
    font-size: 1.1rem;
    margin: auto;
  }

  .step-icon .fa-solid {
    margin: auto;
  }

  /* Form Container */
  .form-container {
    background: var(--color-card-bg);
    border-radius: var(--border-radius-lg);
    padding: 3rem 2.5rem;
    box-shadow: var(--color-shadow);
    border: 1px solid var(--color-border);
    position: relative;
    overflow: hidden;

  }

  form.form-container {
    min-height: 500px;
  }

  .form-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--color-gradient-primary);
  }

  /* Page Content */
  .form-page {
    display: none;
    animation: fadeInSlide 0.4s ease-out;
  }

  .form-page.active {
    display: block;
  }

  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateX(30px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .page-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--color-border);
  }

  .page-header h2 {
    color: var(--color-primary);
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .page-header p {
    color: var(--color-text-secondary);
    font-size: 1rem;
    margin: 0;
    line-height: 1.6;
  }

  /* Form Groups */
  .form-group {
    margin-bottom: 1.75rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  label {
    display: block;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
  }

  .required-asterisk {
    color: var(--color-secondary);
    margin-left: 0.25rem;
  }

  .helper-text {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .helper-text i {
    color: var(--color-accent);
  }

  /* Form Controls */
  input[type="text"],
  input[type="url"],
  input[type="email"],
  input[type="time"],
  input[type="file"],
  select,
  textarea {
    width: 100%;
    padding: 1rem 1.25rem;
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius);
    background: var(--color-card-bg);
    color: var(--color-text);
    font-size: 1rem;
    font-family: inherit;
    transition: var(--transition);
  }

  input:focus,
  select:focus,
  textarea:focus {
    border-color: var(--color-primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  textarea {
    min-height: 120px;
    resize: vertical;
  }

  input[type="file"] {
    border-style: dashed;
    background: var(--color-bg);
    cursor: pointer;
  }

  /* Navigation Buttons */
  .form-navigation {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1rem;
    font-weight: 600;
    padding: 1rem 2rem;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--color-gradient-primary);
    color: white;
    box-shadow: var(--color-shadow);
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--color-shadow-lg);
  }

  .btn-secondary {
    background: transparent;
    color: var(--color-text-secondary);
    border: 2px solid var(--color-border);
  }

  .btn-secondary:hover:not(:disabled) {
    background: var(--color-bg);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .btn-success {
    background: var(--color-gradient-success);
    color: white;
    box-shadow: var(--color-shadow);
  }

  .btn-success:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--color-shadow-lg);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .btn-nav-spacer {
    flex: 1;
  }

  /* Organizers Section */
  .organizer-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .organizer-card {
    background: var(--color-bg);
    border-radius: var(--border-radius);
    padding: 2rem;
    border: 2px solid var(--color-border);
    position: relative;
    transition: var(--transition);
  }

  .privacy-options {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-top: 1rem;
    padding: 1rem;
    border-radius: var(--border-radius);
    border: 1px dashed var(--color-border);
    background: rgba(255, 255, 255, 0.03);
  }

  .privacy-checkbox {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    color: var(--color-text);
  }

  .privacy-hint {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin-top: 0.35rem;
  }

  .organizer-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--color-shadow);
  }

  .organizer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--color-border);
  }

  .organizer-header h3 {
    color: var(--color-secondary);
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-remove {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    background: transparent;
    border: 2px solid var(--color-border);
    color: var(--color-text-secondary);
    cursor: pointer;
    font-size: 1.05rem;
    transition: var(--transition);
    box-shadow: var(--color-shadow);
  }

  .btn-remove:hover {
    background: linear-gradient(135deg, #ff4d4f 0%, #ff1f2d 100%);
    border-color: #ff1f2d;
    color: #fff;
    transform: translateY(-6px) scale(1.06) rotate(-1deg);
    box-shadow: 0 12px 24px rgba(255, 31, 45, 0.18), 0 4px 10px rgba(255, 77, 79, 0.12);
    transition: transform 0.35s cubic-bezier(0.2, 0.9, 0.2, 1), box-shadow 0.35s ease, background 0.35s ease, border-color 0.35s ease, color 0.2s ease;
  }

  .btn-remove:focus-visible {
    outline: none;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
  }

  .add-organizer-button {
    background: var(--color-gradient-secondary);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: var(--color-shadow);
    font-family: inherit;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .add-organizer-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--color-shadow-lg);
  }

  /* Checkbox */
  .checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--color-bg);
    border-radius: var(--border-radius);
    border: 2px solid var(--color-border);
  }

  input[type="checkbox"] {
    width: auto;
    margin-top: 0.25rem;
    transform: scale(1.3);
    accent-color: var(--color-primary);
    cursor: pointer;
  }

  .checkbox-group label {
    font-weight: 400;
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.6;
    cursor: pointer;
  }

  .checkbox-group a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
  }

  .checkbox-group a:hover {
    color: var(--color-secondary);
    text-decoration: underline;
  }

  /* Success Page */
  .success-page {
    text-align: center;
    padding: 3rem 2rem;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    background: var(--color-gradient-success);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 2rem;
    animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .success-icon i {
    font-size: 2.5rem;
    color: white;
  }

  @keyframes scaleIn {
    from {
      transform: scale(0);
      opacity: 0;
    }

    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  .success-page h2 {
    color: var(--color-success);
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .success-page p {
    color: var(--color-text-secondary);
    font-size: 1.1rem;
    margin-bottom: 2rem;
    line-height: 1.7;
  }

  /* Editor */
  .editor-container {
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius);
    overflow: hidden;
    transition: var(--transition);
    background: var(--color-card-bg);
  }

  .editor-container:focus-within {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* Optional Section */
  .optional-section {
    display: none;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      max-height: 0;
    }

    to {
      opacity: 1;
      max-height: 500px;
    }
  }

  .cache-notice {
    background: rgba(255, 170, 200, 0.25);
    border: 1px solid #ffa3c6;
    padding: 12px 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    font-size: 15px;
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cache-notice button {
    background: #ff8dbf;
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    font-weight: 600;
  }

  .hidden {
    display: none;
  }


  /* Validation Messages */
  .validation-message {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: none;
    align-items: center;
    gap: 0.5rem;
  }

  .validation-message.show {
    display: flex;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .container-main-content {
      padding: 0 1rem;
      margin: 1rem auto;
    }

    .hero-section {
      padding: 2rem 1.5rem;
    }

    .form-container {
      padding: 2rem 1.5rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .progress-steps {
      flex-wrap: wrap;
      gap: 1rem;
    }

    .step-label {
      font-size: 0.75rem;
    }

    .step-circle {
      width: 36px;
      height: 36px;
      font-size: 0.875rem;
    }

    .form-navigation {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>

  let currentPage = 1;
  const totalPages = 5;
  // Page Navigation
  function showPage(pageNumber) {
    document.querySelectorAll('.form-page').forEach(page => {
      page.classList.remove('active');
    });

    const page = document.getElementById(`page-${pageNumber}`);
    if (page) {
      page.classList.add('active');
      currentPage = pageNumber;
      localStorage.setItem("form_step", currentPage);

      updateProgressBar();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function updateProgressBar() {
    const progressFill = document.querySelector('.progress-line-fill');
    const percentage = ((currentPage - 1) / (totalPages - 1)) * 100;
    progressFill.style.width = `${percentage}%`;



    document.querySelectorAll('.progress-step').forEach((step, index) => {
      step.classList.remove('active', 'completed');
      if (index + 1 < currentPage) {
        step.classList.add('completed');
      } else if (index + 1 === currentPage) {
        step.classList.add('active');
      }
    });
  }

  function nextPage() {
    if (validateCurrentPage() && currentPage < totalPages) {
      showPage(currentPage + 1);
    }
  }

  function previousPage() {
    if (currentPage > 1) {
      showPage(currentPage - 1);
    }
  }

  function validateCurrentPage() {
    const currentPageElement = document.getElementById(`page-${currentPage}`);
    const requiredInputs = currentPageElement.querySelectorAll('[required]');
    let isValid = true;

    requiredInputs.forEach(input => {
      if (!input.value.trim()) {
        input.style.borderColor = '#ef4444';
        isValid = false;
      } else {
        input.style.borderColor = '';
      }
    });

    if (!isValid) {
      alert('{{ _("T√§yt√§ kaikki pakolliset kent√§t ennen jatkamista.") }}');
    }

    return isValid;
  }

  // Organizer Management
  let organizerCount = 0;

  window.addOrganizer = function () {
    organizerCount++;
    const container = document.getElementById("organizers-container");
    const organizerDiv = document.createElement("div");
    organizerDiv.className = "organizer-card";
    organizerDiv.id = `organizer-${organizerCount}`;

    organizerDiv.innerHTML = `
      <div class="organizer-header">
        <h3><i class="fa-solid fa-building"></i> {{ _('J√§rjest√§j√§') }} ${organizerCount}</h3>
        <button type="button" class="btn-remove" onclick="removeOrganizer(${organizerCount})">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      
      <div class="form-group">
        <label for="org_search_${organizerCount}">{{ _('Etsi olemassa olevaa organisaatiota') }}</label>
        <div style="position: relative;">
          <input type="text" id="org_search_${organizerCount}" placeholder="{{ _('Kirjoita organisaation nimi...') }}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-border); border-radius: 8px; font-family: inherit;" onkeyup="searchOrganizations(${organizerCount})">
          <div id="org_search_results_${organizerCount}" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--color-card-bg); border: 2px solid var(--color-border); border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 10; display: none;"></div>
        </div>
        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin-top: 0.5rem;">{{ _('tai t√§yt√§ tiedot alla manuaalisesti') }}</p>
      </div>
      
      <div class="form-group">
        <label for="organizer_name_${organizerCount}">{{ _('Nimi') }}<span class="required-asterisk">*</span></label>
        <input type="text" id="organizer_name_${organizerCount}" name="organizer_name_${organizerCount}" placeholder="{{ _('J√§rjest√§j√§n nimi') }}" required>
      </div>
      <div class="form-group">
        <label for="organizer_website_${organizerCount}">{{ _('Verkkosivut') }}</label>
        <input type="url" id="organizer_website_${organizerCount}" name="organizer_website_${organizerCount}" placeholder="https://example.com">
      </div>
      <div class="form-group">
        <label for="organizer_email_${organizerCount}">{{ _('S√§hk√∂postiosoite') }}</label>
        <input type="email" id="organizer_email_${organizerCount}" name="organizer_email_${organizerCount}" placeholder="email@example.com">
      </div>
      <div class="privacy-options">
        <label class="privacy-checkbox">
          <input type="checkbox" id="organizer_is_private_${organizerCount}" name="organizer_is_private_${organizerCount}" onchange="handlePrivateToggle(${organizerCount})">
          {{ _('Olen yksityishenkil√∂ enk√§ edusta organisaatiota') }}
        </label>
        <label class="privacy-checkbox">
          <input type="checkbox" id="organizer_show_name_${organizerCount}" name="organizer_show_name_${organizerCount}" checked>
          {{ _('Saa n√§ytt√§√§ nimeni julkisesti') }}
        </label>
        <label class="privacy-checkbox">
          <input type="checkbox" id="organizer_show_email_${organizerCount}" name="organizer_show_email_${organizerCount}" checked>
          {{ _('Saa n√§ytt√§√§ s√§hk√∂postiosoitteeni julkisesti') }}
        </label>
        <p class="privacy-hint">{{ _('Jos valitset yksityishenkil√∂n, voit piilottaa nimesi ja s√§hk√∂postisi. K√§yt√§mme tietoja silti yhteydenottoja varten.') }}</p>
      </div>
    `;

    container.appendChild(organizerDiv);
    organizerDiv.style.opacity = '0';
    organizerDiv.style.transform = 'translateY(20px)';
    setTimeout(() => {
      organizerDiv.style.transition = 'all 0.3s ease-out';
      organizerDiv.style.opacity = '1';
      organizerDiv.style.transform = 'translateY(0)';
    }, 10);
  };

  window.handlePrivateToggle = function (index) {
    const privateToggle = document.getElementById(`organizer_is_private_${index}`);
    const showNameToggle = document.getElementById(`organizer_show_name_${index}`);
    const showEmailToggle = document.getElementById(`organizer_show_email_${index}`);
    if (!privateToggle || !showNameToggle || !showEmailToggle) {
      return;
    }

    if (privateToggle.checked) {
      showEmailToggle.checked = false;
    } else {
      showNameToggle.checked = true;
      showEmailToggle.checked = true;
    }
  };

  // Search organizations and populate results
  window.searchOrganizations = async function(organizerNum) {
    const searchInput = document.getElementById(`org_search_${organizerNum}`);
    const resultsContainer = document.getElementById(`org_search_results_${organizerNum}`);
    const query = searchInput.value.trim();
    
    if (query.length < 2) {
      resultsContainer.style.display = 'none';
      return;
    }
    
    try {
      const response = await fetch(`/api/v1/search_organizations?q=${encodeURIComponent(query)}`);
      const results = await response.json();
      
      if (results.length === 0) {
        resultsContainer.innerHTML = `<div style="padding: 1rem; color: var(--color-text-secondary); text-align: center;">{{ _('Organisaatiota ei l√∂ytynyt') }}</div>`;
        resultsContainer.style.display = 'block';
        return;
      }
      
      let html = '';
      results.forEach(org => {
        html += `
          <div style="padding: 1rem; border-bottom: 1px solid var(--color-border); cursor: pointer; transition: var(--transition);" 
               onmouseover="this.style.backgroundColor = 'var(--color-shadow)'" 
               onmouseout="this.style.backgroundColor = 'transparent'"
               onclick="selectOrganization(${organizerNum}, '${org.name.replace(/'/g, "\\'")}', '${org.email.replace(/'/g, "\\'")}', '${org.website.replace(/'/g, "\\'")}')" >
            <strong style="color: var(--color-text);">${org.name}</strong>
            ${org.email ? `<br><small style="color: var(--color-text-secondary);">${org.email}</small>` : ''}
            ${org.description ? `<br><small style="color: var(--color-text-secondary);">${org.description}</small>` : ''}
          </div>
        `;
      });
      resultsContainer.innerHTML = html;
      resultsContainer.style.display = 'block';
    } catch (err) {
      console.error('Error searching organizations:', err);
    }
  };

  // Select organization from search results
  window.selectOrganization = function(organizerNum, name, email, website) {
    document.getElementById(`organizer_name_${organizerNum}`).value = name;
    document.getElementById(`organizer_email_${organizerNum}`).value = email;
    document.getElementById(`organizer_website_${organizerNum}`).value = website;
    const privateToggle = document.getElementById(`organizer_is_private_${organizerNum}`);
    const showNameToggle = document.getElementById(`organizer_show_name_${organizerNum}`);
    const showEmailToggle = document.getElementById(`organizer_show_email_${organizerNum}`);
    if (privateToggle) privateToggle.checked = false;
    if (showNameToggle) showNameToggle.checked = true;
    if (showEmailToggle) showEmailToggle.checked = true;
    document.getElementById(`org_search_${organizerNum}`).value = '';
    document.getElementById(`org_search_results_${organizerNum}`).style.display = 'none';
  };

  window.removeOrganizer = function (id) {
    const organizer = document.getElementById(`organizer-${id}`);
    if (organizer) {
      organizer.style.opacity = '0';
      organizer.style.transform = 'translateY(-20px)';
      setTimeout(() => organizer.remove(), 300);
    }
  };

  const SUBMIT_ERROR_LABEL = "{{ _('Virhekoodi') }}";

  async function showSubmitError(response, fallbackMessage) {
    let message = fallbackMessage || "{{ _('L√§hetyksess√§ tapahtui virhe. Yrit√§ uudelleen.') }}";
    try {
      const contentType = response.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        const data = await response.json();
        if (data && data.message) {
          message = data.message;
        }
        if (data && data.error_code) {
          message += ` (${SUBMIT_ERROR_LABEL}: ${data.error_code})`;
        }
      } else {
        const txt = await response.text();
        if (txt && txt.trim()) {
          message = txt;
        }
      }
    } catch (err) {
      console.error('Error parsing server response', err);
    }
    alert(message);
  }

  // Type change handler
  document.getElementById("type").addEventListener("change", function () {
    const marchRouteContainer = document.getElementById("march-route-container");
    if (this.value === "marssi") {
      marchRouteContainer.style.display = "block";
    } else {
      marchRouteContainer.style.display = "none";
    }
  });

  // Form submission
  let submittingDemo = false;
  document.getElementById("myForm").addEventListener("submit", async (event) => {
    event.preventDefault();

    // render the editor content to hidden input on form submit
    // wait till quill is defined


    if (!document.getElementById("accept_terms").checked) {
      alert("{{ _('Sinun t√§ytyy hyv√§ksy√§ k√§ytt√∂ehdot ja tietosuojaseloste ennen l√§hett√§mist√§.') }}");
      return;
    }

    const form = document.querySelector("form");
    const missingRequired = Array.from(form.querySelectorAll("[required]")).filter(el => {
      if (el.type === "checkbox" || el.type === "radio") {
        return !el.checked;
      }
      return !el.value || !el.value.trim();
    });

    if (missingRequired.length) {
      alert("{{ _('T√§yt√§ kaikki pakolliset kent√§t ennen l√§hett√§mist√§.') }}");
      return;
    }

    if (submittingDemo) {
      return;
    }
    submittingDemo = true;
    const submitBtn = document.getElementById("submit-form");
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;

    // Safely read editor content. Use a function-scoped variable so finally sees the value.
    let editorData = "";
    try {
      if (typeof quill !== 'undefined' && quill && quill.root) {
        editorData = quill.root.innerHTML;
      } else {
        // fallback to existing description field value
        editorData = document.getElementById("description").value || "";
      }
    } catch (err) {
      console.error('Error reading editor content:', err);
    }
    document.getElementById("description").value = editorData;

    const formData = new FormData(form);
    // Ensure checkbox values are sent reliably (some browsers/forms omit unchecked inputs)
    const acceptCheckbox = document.getElementById('accept_terms');
    if (acceptCheckbox) {
      // Use explicit value so backend can detect presence reliably
      formData.set('accept_terms', acceptCheckbox.checked ? '1' : '');
    }

    try {
      const response = await fetch(form.action, {
        method: form.method,
        body: formData,
        // mark as AJAX so backend can return JSON instead of redirect
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      // Treat 2xx and 3xx statuses as success (redirects from server are 302).
      if (response.ok || (response.status >= 300 && response.status < 400)) {
        showPage(5); // Show success page
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith("form_")) localStorage.removeItem(key);
        });
      } else {
        if (response.status === 409) {
          let conflictData = null;
          const contentType = response.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            try {
              conflictData = await response.json();
            } catch (err) {
              console.error('Error parsing conflict response JSON', err);
            }
          }

          if (conflictData && conflictData.conflict) {
            formData.set('force_submit', '1');
            const response2 = await fetch(form.action, {
              method: form.method,
              body: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (response2.ok || (response2.status >= 300 && response2.status < 400)) {
              showPage(5);
              Object.keys(localStorage).forEach(key => {
                if (key.startsWith("form_")) localStorage.removeItem(key);
              });
              return;
            } else {
              await showSubmitError(response2);
              return;
            }
          } else {
            alert("{{ _('L√§hetyksess√§ tapahtui virhe. Yrit√§ uudelleen.') }} (" + SUBMIT_ERROR_LABEL + ": SUBMIT_CONFLICT)");
            return;
          }
        }

        await showSubmitError(response);
      }
    } catch (e) {
      console.error("Network error:", e);
      alert("{{ _('L√§hetyksess√§ tapahtui virhe. Yrit√§ uudelleen.') }}");
    } finally {
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
      submittingDemo = false; // allow retries after failures or cancellations
    }
  });

  // Expose functions globally
  window.nextPage = nextPage;
  window.previousPage = previousPage;

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    showPage(1);
  });

  // server-provided flag ‚Äî only allow test-mode for authorized users
  const __TEST_MODE_ALLOWED = {{ 'true' if test_mode_allowed else 'false' }};
  const __CAN_EDIT = {{ 'true' if can_edit_demo else 'false' }};

  // Autofill test data when visiting /submit?mode=test
  function fillTestData() {
    try {
      // Helper to set value by selector (id or name)
      const setById = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
      };
      const setByName = (name, val) => {
        const el = document.querySelector(`[name="${name}"]`);
        if (el) el.value = val;
      };

      const today = new Date();
      const future = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      const yyyy = future.getFullYear();
      const mm = String(future.getMonth() + 1).padStart(2, '0');
      const dd = String(future.getDate()).padStart(2, '0');
      const isoDate = `${yyyy}-${mm}-${dd}`;

      setById('name', 'Testi-ilmoitus ‚Äî automatisoitu');
      setById('tags', 'testi, automaattinen');
      // set iso date ‚Äî backend accepts string; flatpickr may reformat if enabled
      setById('date', isoDate);
      setById('start_time', '18:00');
      setById('end_time', '20:00');
      // city dropdown uses selectCity helper which also sets the hidden input
      if (typeof selectCity === 'function') {
        selectCity('Helsinki');
      } else {
        setById('selected-city', 'Helsinki');
      }
      setById('address', 'Testikatu 1, 00100 Helsinki');
      setById('facebook', 'https://facebook.com/events/0000000000');

      // Ensure at least one organizer exists; use provided helper if available
      if (typeof addOrganizer === 'function') {
        // add one more organizer to ensure predictable IDs (it may already add one by default)
        addOrganizer();
      }
      // Fill organizer fields by name (organizer_name_1 etc.)
      const orgName = document.querySelector('[name^="organizer_name_"]');
      if (orgName) orgName.value = 'Testij√§rjest√§j√§';
      const orgEmail = document.querySelector('[name^="organizer_email_"]');
      if (orgEmail) orgEmail.value = 'organizer@example.com';
      const orgWebsite = document.querySelector('[name^="organizer_website_"]');
      if (orgWebsite) orgWebsite.value = 'https://example.org';

      // Submitter
      setById('submitter_role', 'j√§rjest√§j√§');
      setById('submitter_name', 'Testik√§ytt√§j√§');
      setById('submitter_email', 'test@example.com');
      const accept = document.getElementById('accept_terms');
      if (accept) accept.checked = true;

      // Description ‚Äî quill editor
      const descriptionHtml = '<p>T√§m√§ on automaattisesti t√§ytetty testi-ilmoitus. Poista ennen julkaisua.</p>';
      if (typeof quill !== 'undefined' && quill && quill.root) {
        quill.root.innerHTML = descriptionHtml;
      }
      setById('description', descriptionHtml);

      // Show a small non-blocking notice (console + visual)
      console.info('Test mode: form auto-filled');
    } catch (err) {
      console.error('Error applying test data:', err);
    }
  }

  // Check URL param
  (function () {
    try {
      const params = new URLSearchParams(window.location.search);
      if (params.get('mode') === 'test' && __TEST_MODE_ALLOWED) {
          // show visible test-mode banner and autofill after load
          (function showTestBanner() {
            try {
              const container = document.querySelector('.container-main-content') || document.body;
              const existing = document.getElementById('testModeBanner');
              if (existing) return;
              const banner = document.createElement('div');
              banner.id = 'testModeBanner';
              banner.setAttribute('role', 'status');
              banner.setAttribute('aria-live', 'polite');
              banner.style.cssText = 'background: linear-gradient(90deg,#fff7ed,#ffedd5); border-left:4px solid #fb923c; padding:12px 16px; border-radius:8px; margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; gap:12px;';
              banner.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                  <strong style="color:#92400e">Test Mode</strong>
                  <span style="color:#92400e">Automaattinen testidata t√§ytetty lomakkeelle. Muista poistaa ennen julkaisua.</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button id="testModeClose" style="background:transparent;border:none;color:#92400e;font-weight:700;cursor:pointer;padding:6px 8px;border-radius:6px">Sulje</button>
                </div>
              `;
              // prepend so it's visible above the form
              if (container.firstChild) container.insertBefore(banner, container.firstChild);
              else container.appendChild(banner);
              document.getElementById('testModeClose').addEventListener('click', function () { banner.remove(); });
            } catch (e) { console.error('Could not show test banner', e); }
          })();

          // Wait a tick to ensure other DOM init code ran
          window.addEventListener('load', () => setTimeout(fillTestData, 200));
        }
    } catch (e) {
      // ignore
    }
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{{ url_for('static', filename='js/date.js') }}"></script>

<script>
  // Real-time conflict checking (debounced)
  (function () {
    const debounce = (fn, wait) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    };

    function createConflictBox() {
      let box = document.getElementById('conflictBox');
      if (box) return box;
      box = document.createElement('div');
      box.id = 'conflictBox';
      box.style.cssText = `
        background: var(--color-card-bg);
        border: 2px solid var(--color-border);
        border-left: 4px solid var(--color-secondary);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin: 1.5rem 0;
        display: none;
        box-Noneshadow: var(--color-shadow);
      `;
      const container = document.querySelector('.form-container') || document.querySelector('.container-main-content');
      if (container) container.parentNode.insertBefore(box, container);
      return box;
    }

    function renderConflict(matches) {
      const box = createConflictBox();
      if (!matches || matches.length === 0) {
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }
      
      let html = `
        <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
          <div style="font-size: 1.5rem; min-width: 2rem;">‚ö†Ô∏è</div>
          <div>
            <strong style="color: var(--color-text); font-size: 1.1rem; display: block; margin-bottom: 0.5rem;">
              {{ _('Samankaltaisia mielenosoituksia l√∂ytyi') }}
            </strong>
            <p style="color: var(--color-text-secondary); margin: 0; font-size: 0.95rem;">
              {{ _('Tarkista alla listatut mielenosoitukset varmistaaksesi, ettet luo p√§√§llekk√§ist√§ ilmoitusta.') }}
            </p>
          </div>
        </div>
        <ul style="margin: 1rem 0; padding: 0; list-style: none;">
      `;
      
      matches.forEach((m, idx) => {
        const url = `/demonstration/${m._id}`;
        const dateStr = m.date ? new Date(m.date).toLocaleDateString('fi-FI') : '?';
        html += `
          <li style="
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            transition: var(--transition);
          " onmouseover="this.style.boxShadow='var(--color-shadow)'" onmouseout="this.style.boxShadow='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <a href="${url}" target="_blank" style="
                  color: var(--color-primary);
                  text-decoration: none;
                  font-weight: 600;
                  font-size: 1rem;
                  transition: var(--transition);
                " onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                  ${m.title || '(ilman otsikkoa)'}
                </a>
                <p style="color: var(--color-text-secondary); margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                  üìç ${m.address || '?'} ‚Ä¢ üìÖ ${dateStr}
                </p>
              </div>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end;">
                <a href="${url}" target="_blank" style="
                  padding: 0.5rem 1rem;
                  background: var(--color-primary);
                  color: white;
                  text-decoration: none;
                  border-radius: 6px;
                  font-size: 0.85rem;
                  font-weight: 600;
                  transition: var(--transition);
                  display: inline-flex;
                  align-items: center;
                  gap: 0.3rem;
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                  <i class="fa-solid fa-eye"></i> {{ _('Katso') }}
                </a>
        `;
        
        if (__CAN_EDIT) {
          html += `
            <a href="/admin/demo/edit_demo/${m._id}" target="_blank" style="
              padding: 0.5rem 1rem;
              background: var(--color-secondary);
              color: white;
              text-decoration: none;
              border-radius: 6px;
              font-size: 0.85rem;
              font-weight: 600;
              transition: var(--transition);
              display: inline-flex;
              align-items: center;
              gap: 0.3rem;
            " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              <i class="fa-solid fa-pen"></i> {{ _('Muokkaa') }}
            </a>
          `;
        }
        
        html += `
            <a href="/suggest_change/${m._id}" target="_blank" style="
              padding: 0.5rem 1rem;
              background: var(--color-success);
              color: white;
              text-decoration: none;
              border-radius: 6px;
              font-size: 0.85rem;
              font-weight: 600;
              transition: var(--transition);
              display: inline-flex;
              align-items: center;
              gap: 0.3rem;
            " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              <i class="fa-solid fa-lightbulb"></i> {{ _('Ehdota') }}
            </a>
              </div>
            </div>
          </li>
        `;
      });
      
      html += `
        </ul>
        <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); margin-top: 1rem;">
          <button id="conflictIgnore" class="btn btn-secondary" style="flex: 1;">
            <i class="fa-solid fa-check-circle"></i> {{ _('Jatka silti') }}
          </button>
          <button id="conflictReview" class="btn btn-primary" style="flex: 1;">
            <i class="fa-solid fa-arrow-up"></i> {{ _('Muokkaa tietoja') }}
          </button>
        </div>
      `;
      
      box.innerHTML = html;
      box.style.display = 'block';
      
      // Auto-scroll to conflict box when it appears
      box.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      document.getElementById('conflictIgnore').addEventListener('click', () => { box.style.display = 'none'; });
      document.getElementById('conflictReview').addEventListener('click', () => {
        try {
          if (__CAN_EDIT && matches && matches.length > 0) {
            // If user can edit, open admin edit page for the first matched demo
            window.location.href = `/admin/demo/edit_demo/${matches[0]._id}`;
            return;
          }
          // Otherwise, bring user to the form to edit details: show page 1 and focus the title field
          if (typeof showPage === 'function') showPage(1);
          const field = document.getElementById('name');
          if (field) {
            field.focus();
            const prev = field.style.boxShadow;
            field.style.boxShadow = '0 0 0 4px rgba(250,180,60,0.35)';
            setTimeout(() => { field.style.boxShadow = prev; }, 3000);
          } else {
            // Fallback to scrolling to the top of the form
            window.scrollTo({ top: box.getBoundingClientRect().top + window.scrollY - 80, behavior: 'smooth' });
          }
        } catch (e) {
          console.error('Conflict review action failed', e);
        }
      });
    }

    async function checkConflictNow() {
      try {
        const title = (document.getElementById('name') || {}).value || '';
        const date = (document.getElementById('date') || {}).value || '';
        const city = (document.getElementById('selected-city') || {}).value || '';
        const address = (document.getElementById('address') || {}).value || '';
        if (!title || !date || !city) {
          renderConflict([]);
          return;
        }
        const params = new URLSearchParams({ title, date, city, address });
        const res = await fetch(`/api/v1/check_demo_conflict?${params.toString()}`, { method: 'GET' });
        if (!res.ok) { renderConflict([]); return; }
        const data = await res.json();
        renderConflict(data.matches || []);
      } catch (e) {
        console.error('Conflict check failed', e);
      }
    }

    const debouncedCheck = debounce(checkConflictNow, 500);

    // Wire inputs
    ['name', 'date', 'address'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', debouncedCheck);
    });

    // selected-city is a hidden input; hook into selectCity if available or observe clicks
    const cityInput = document.getElementById('selected-city');
    if (cityInput) {
      // If selectCity is defined by the paikkakunta dropdown, wrap it to emit a custom event
      if (typeof window.selectCity === 'function') {
        const _origSelectCity = window.selectCity;
        window.selectCity = function (city) {
          _origSelectCity(city);
          try {
            cityInput.dispatchEvent(new Event('citychanged'));
          } catch (e) {}
        };
      }
      cityInput.addEventListener('citychanged', debouncedCheck);
      // attach click handlers to dropdown links as fallback
      document.querySelectorAll('#dropdown-content a[role="option"]').forEach(a => a.addEventListener('click', debouncedCheck));
      // also trigger on load if filled
      if (cityInput.value) setTimeout(checkConflictNow, 300);
    }

    // initial check after page load if fields have values
    window.addEventListener('load', () => setTimeout(checkConflictNow, 600));
  })();
</script>

{% endblock %}

{% block content %}
<div class="container-main-content">

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-content">
      <h1>{{ _('Ilmoita mielenosoituksesta') }}</h1>
      <p class="lead">
        {{ _('Ilmoittamalla mielenosoituksesta autat muita l√∂yt√§m√§√§n tietoa mielenosoituksista. Mit√§ useampia ja
        kattavammin alustalla on mielenosoituksista tietoa, sit√§ useammille siit√§ on hy√∂ty√§.') }}
      </p>
    </div>
  </section>

  <div id="cacheNotice" class="cache-notice hidden">
    Lomake ladattiin automaattisesti tallennetuista tiedoista üíæ
    <button id="resetCacheBtn" type="button">Tyhjenn√§ ja aloita alusta</button>
  </div>


  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-steps">
      <div class="progress-line">
        <div class="progress-line-fill"></div>
      </div>

      <div class="progress-step" data-page="1">
        <div class="step-circle">
          <span class="step-icon">1</span>
        </div>
        <div class="step-label">{{ _('Perustiedot') }}</div>
      </div>

      <div class="progress-step" data-page="2">
        <div class="step-circle">
          <span class="step-icon">2</span>
        </div>
        <div class="step-label">{{ _('Aika & Paikka') }}</div>
      </div>

      <div class="progress-step" data-page="3">
        <div class="step-circle">
          <span class="step-icon">3</span>
        </div>
        <div class="step-label">{{ _('J√§rjest√§j√§t') }}</div>
      </div>

      <div class="progress-step" data-page="4">
        <div class="step-circle">
          <span class="step-icon">4</span>
        </div>
        <div class="step-label">{{ _('Yhteystiedot') }}</div>
      </div>

      <div class="progress-step" data-page="5">
        <div class="step-circle">
          <span class="step-icon"><i class="fa-solid fa-check"></i></span>
        </div>
        <div class="step-label">{{ _('Valmis') }}</div>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <form method="POST" action="{{ url_for('submit') }}" enctype="multipart/form-data" id="myForm">
    <input type="hidden" name="submission_token" value="{{ submission_token or '' }}">
    <div class="form-container">

      <!-- Page 1: Basic Information -->
      <div class="form-page active" id="page-1">
        <div class="page-header">
          <h2>
            <i class="fa-solid fa-info-circle"></i>
            {{ _('Perustiedot') }}
          </h2>
          <p>{{ _('Kerro meille mielenosoituksesi t√§rkeimm√§t tiedot. T√§m√§ auttaa ihmisi√§ l√∂yt√§m√§√§n tapahtumasi!') }}</p>
        </div>

        <div class="form-group">
          <label for="name">
            {{ _('Mielenosoituksen nimi') }}<span class="required-asterisk">*</span>
          </label>
          <input type="text" id="name" name="title" placeholder="{{ _('esim. Ilmastonmuutoksen vastainen marssi') }}"
            required />
          <div class="helper-text">
            <i class="fa-solid fa-lightbulb"></i>
            {{ _('Valitse lyhyt ja kuvaava nimi') }}
          </div>
        </div>

        <div class="form-group">
          <label for="tags">
            {{ _('Tagit (pilkuilla erotettuna)') }}<span class="required-asterisk">*</span>
          </label>
          <input type="text" id="tags" name="tags" placeholder="{{ _('esim. ilmasto, tasa-arvo, oikeudet') }}"
            required />
          <div class="helper-text">
            <i class="fa-solid fa-tags"></i>
            {{ _('Tagit auttavat ihmisi√§ l√∂yt√§m√§√§n tapahtumasi') }}
          </div>
        </div>

        <div class="form-group">
          <label for="description">{{ _('Kuvausteksti') }}</label>
          <div class="editor-container">
            <div id="editor"></div>
          </div>
          <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
          <!-- rest of the quil css-->
          <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
          <link href="https://cdn.quilljs.com/1.3.6/quill.core.css" rel="stylesheet">

          <!-- include quill library -->
          <style>
            .ql-editor {
              /* use all the available height */
              height: 100%;
              min-height: 130px;
            }
          </style>
          <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

          <script>
            const quill = new Quill('#editor', {
              modules: {
                toolbar: [
                  ['bold', 'italic'],
                  ['link', 'blockquote'],
                  [{ list: 'ordered' }, { list: 'bullet' }],
                ],
              },
              theme: 'snow',
            });

            document.querySelector('form').onsubmit = function () {
              document.querySelector('#description').value = quill.root.innerHTML;
            };


            // no matter where on the quill element we click, the same event should be as if we click the 
          </script>
          <!-- import Quill -->
          <input type="hidden" id="description" name="description" />
          <div class="helper-text">
            <i class="fa-solid fa-info-circle"></i>
            {{ _('Kuvaile mielenosoituksen tarkoitus ja tavoitteet') }}
          </div>
        </div>

        <div class="form-group">
          <label for="image">{{ _('Kuva (valinnainen)') }}</label>
          <input type="file" id="image" name="image" accept="image/*" />
          <div class="helper-text">
            <i class="fa-solid fa-image"></i>
            {{ _('Lis√§√§ houkutteleva kuva tapahtumallesi') }}
          </div>
          <div class="image-preview-container">
            <img id="image-preview" style="max-width: 100%; display: none;" />
          </div>
          <!-- image remove button -->
          <button class="btn btn-danger" id="removeImage" style="margin-top: 1rem;">
            <i class="fa-solid fa-trash"></i> Poista kuva
          </button>
          <script>
            // when loading from cache, show the preview if image is present
            document.addEventListener('DOMContentLoaded', function () {
              const imageInput = document.getElementById('image');
              const preview = document.getElementById('image-preview');
              if (imageInput.files.length > 0) {
                const file = imageInput.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                  preview.src = e.target.result;
                  preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
              }
            });
          </script>
        </div>

        {% include 'cropper-modal.html' %}

        <!-- cropperjs -->

        <!-- after image preview is shown -->
        <!--<script>
        let cropper;
        document.addEventListener('DOMContentLoaded', function () {
          const imagePreview = document.getElementById('image-preview');
          imagePreview.addEventListener('load', function () {
          if (imagePreview) {
            cropper = Cropper(imagePreview, {
              aspectRatio: 16 / 9,
              viewMode: 1,
            });
          }
        });
        });
      </script>-->
        <!--
<script type="module">
import Cropper from 'https://cdn2.mielenosoitukset.fi/cropperjs/cropper.esm.min.js';

let cropper;

const fileInput = document.getElementById('image');

fileInput.addEventListener('change', (event) => {
  const file = event.target.files?.[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = (e) => {
    let preview = document.getElementById('image-preview');

    // Create preview element if missing
    if (!preview) {
      preview = document.createElement('img');
      preview.id = 'image-preview';
      preview.style.display = 'block';
      preview.style.maxWidth = '100%';
      preview.style.marginTop = '1rem';
      event.target.parentNode.appendChild(preview);
    }

    preview.src = e.target.result;

    preview.onload = () => {
      if (cropper) cropper.destroy();

      cropper = new Cropper(preview, {
        template: `
          <cropper-canvas style="width: max-content; height: auto; min-height:200px; margin: auto;">
            <cropper-image style="width: 100%; height: auto;"  scalable  translatable ></cropper-image>
            <cropper-shade hidden></cropper-shade>
            <cropper-handle action="select" plain></cropper-handle>
            <cropper-selection id="selection" initial-coverage="0.5" aspect-ratio="1.777777778" movable resizable @change="onCropperSelectionChange">
              <cropper-grid role="grid" bordered covered></cropper-grid>
              <cropper-crosshair centered></cropper-crosshair>
              <cropper-handle action="move" theme-color="rgba(255,255,255,0.35)"></cropper-handle>
              <cropper-handle action="n-resize"></cropper-handle>
              <cropper-handle action="e-resize"></cropper-handle>
              <cropper-handle action="s-resize"></cropper-handle>
              <cropper-handle action="w-resize"></cropper-handle>
              <cropper-handle action="ne-resize"></cropper-handle>
              <cropper-handle action="nw-resize"></cropper-handle>
              <cropper-handle action="se-resize"></cropper-handle>
              <cropper-handle action="sw-resize"></cropper-handle>
            </cropper-selection>
          </cropper-canvas>
        `
      });

      console.log(cropper);
   
      // make cropper global for testing
      window.cropper = cropper;
  //cropper.getCropperImage().$transform = (event) => this.onCropperImageTransform(event);

  // Handle selection changes
  cropper.getCropperImage().$ready(() => {
    const selection = cropper.getCropperSelection();
    if (selection) {
      selection.addEventListener('change', onCropperSelectionChange);
      //document.querySelector('#selection').addEventListener('change', function (event) {
  //console.log(event);
//});

      //selection.$change = (event) => onCropperSelectionChange(event);
    }
  });

  function clampSelection(selection, maxSelection) {
  // Clamp X
  if (selection.x < maxSelection.x) selection.x = maxSelection.x;
  if (selection.x + selection.width > maxSelection.x + maxSelection.width) {
    selection.x = maxSelection.x + maxSelection.width - selection.width;
  }

  // Clamp Y
  if (selection.y < maxSelection.y) selection.y = maxSelection.y;
  if (selection.y + selection.height > maxSelection.y + maxSelection.height) {
    selection.y = maxSelection.y + maxSelection.height - selection.height;
  }

  // Optionally clamp width/height if bigger than max
  if (selection.width > maxSelection.width) selection.width = maxSelection.width;
  if (selection.height > maxSelection.height) selection.height = maxSelection.height;

  return selection;
}

function onCropperSelectionChange(event) {
  const cropperCanvas = cropper.getCropperCanvas();
  const cropperImage = cropper.getCropperImage();
  console.log(event);
  const selection = event.detail; // <-- safe access
  //const selection = cropper.e()?.getData();
  console.log('Selection changed:', selection);

  if (!selection) return; // nothing to do

  const cropperImageRect = cropperImage.getBoundingClientRect();
  const cropperCanvasRect = cropperCanvas.getBoundingClientRect();

  const maxSelection = {
    x: cropperImageRect.left - cropperCanvasRect.left,
    y: cropperImageRect.top - cropperCanvasRect.top,
    width: cropperImageRect.width,
    height: cropperImageRect.height,
  };


  /* TODO: make this actually work, before it works, lets js use the original selection
  
  
  se = clampSelection(selection, maxSelection);

  // set the selection to clamped values
  selection.x = se.x;
  selection.y = se.y;
  selection.width = se.width;
  selection.height = se.height;*/
  
  if (inSelection(selection, maxSelection)) {
    return; // all good
  } else {
    console.log('Selection out of bounds, preventing change');
    event.preventDefault();
  }
}



// Helper function to check if selection is within max bounds
function inSelection(selection, maxSelection) {
  return (
    selection.x >= maxSelection.x &&
    selection.y >= maxSelection.y &&
    selection.x + selection.width <= maxSelection.x + maxSelection.width &&
    selection.y + selection.height <= maxSelection.y + maxSelection.height
  );
}


  const onCropperImageTransform = (event) => {
    // javascript code
      const cropperCanvas = this.$regs.cropperCanvas;

      if (!cropperCanvas || this.imageFit === 'none') {
        return;
      }

      const cropperImage = this.$refs.cropperImage;
      const cropperCanvasRect = cropperCanvas.getBoundingClientRect();

      // 1. Clone the cropper image.
      const cropperImageClone = cropperImage.cloneNode();

      // 2. Apply the new matrix to the cropper image clone.
      cropperImageClone.style.transform = `matrix(${event.detail.matrix.join(', ')})`;

      // 3. Make the cropper image clone invisible.
      cropperImageClone.style.opacity = '0';

      // 4. Append the cropper image clone to the cropper canvas.
      cropperCanvas.appendChild(cropperImageClone);

      // 5. Compute the boundaries of the cropper image clone.
      const cropperImageRect = cropperImageClone.getBoundingClientRect();

      // 6. Remove the cropper image clone.
      cropperCanvas.removeChild(cropperImageClone);

      if (
        (this.imageFit === 'contain' && (
          (
            cropperImageRect.top > cropperCanvasRect.top
            && cropperImageRect.right < cropperCanvasRect.right
          )
          || (
            cropperImageRect.right < cropperCanvasRect.right
            && cropperImageRect.bottom < cropperCanvasRect.bottom
          )
          || (
            cropperImageRect.bottom < cropperCanvasRect.bottom
            && cropperImageRect.left > cropperCanvasRect.left
          )
          || (
            cropperImageRect.left > cropperCanvasRect.left
            && cropperImageRect.top > cropperCanvasRect.top
          )
        ))
        || (this.imageFit === 'cover' && (
          cropperImageRect.top > cropperCanvasRect.top
          || cropperImageRect.right < cropperCanvasRect.right
          || cropperImageRect.bottom < cropperCanvasRect.bottom
          || cropperImageRect.left > cropperCanvasRect.left
        ))
      ) {
        event.preventDefault();
      }
  }; };
  };


  reader.readAsDataURL(file);
});
</script>

<style scoped>
.cropper-container {
  border: 1px solid var(--vp-c-divider);
  border-radius: 8px;
  margin: 1rem 0;
  padding: 1rem 1.25rem;
}


</style>
-->
        <div class="form-group">
          <label for="facebook">{{ _('Facebook-tapahtumalinkki (valinnainen)') }}</label>
          <input type="url" id="facebook" name="facebook" placeholder="https://facebook.com/events/..." />
          <div class="helper-text">
            <i class="fa-brands fa-facebook"></i>
            {{ _('Linkit√§ Facebook-tapahtuma jos sellainen on') }}
          </div>
        </div>

        <div class="form-navigation">
          <button type="button" class="btn btn-secondary" disabled>
            <i class="fa-solid fa-arrow-left"></i>
            {{ _('Edellinen') }}
          </button>
          <div class="btn-nav-spacer"></div>
          <button type="button" class="btn btn-primary" onclick="nextPage()">
            {{ _('Seuraava') }}
            <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Page 2: Date & Location -->
      <div class="form-page" id="page-2">
        <div class="page-header">
          <h2>
            <i class="fa-solid fa-calendar"></i>
            {{ _('Aika ja paikka') }}
          </h2>
          <p>{{ _('Milloin ja miss√§ mielenosoitus j√§rjestet√§√§n? Tarkat tiedot auttavat osallistujia l√∂yt√§m√§√§n perille!')
            }}</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label id="date-label" for="date">
              {{ _('P√§iv√§m√§√§r√§') }}<span class="required-asterisk">*</span>
            </label>
            <input type="text" id="date" name="date" placeholder="{{ _('pp.kk.vvvv') }}" required
              aria-labelledby="date-label" />
          </div>

          <div class="form-group">
            <label for="start_time">
              {{ _('Alkamisaika') }}<span class="required-asterisk">*</span>
            </label>
            <input type="time" id="start_time" name="start_time" required />
          </div>
        </div>

        <div class="form-group">
          <label for="end_time">{{ _('P√§√§ttymisaika (valinnainen)') }}</label>
          <input type="time" id="end_time" name="end_time" />
          <div class="helper-text">
            <i class="fa-solid fa-clock"></i>
            {{ _('Anna arvio tapahtuman kestosta') }}
          </div>
        </div>

        <div class="form-group">
          <label for="type">
            {{ _('Mielenosoituksen tyyppi') }}<span class="required-asterisk">*</span>
          </label>
          <select id="type" name="type" required>
            <option value="" disabled selected>{{ _('Mielenosoituksen tyyppi') }}</option>
            <option value="paikallaan">{{ _('Paikallaan') }}</option>
            <option value="marssi">{{ _('Marssi / kulkue') }}</option>
            <option value="muut">{{ _('Muu') }}</option>
          </select>
        </div>
        <div id="march-route-container" class="optional-section">
          <div class="form-group">
            <label for="route">{{ _('Marssin reitti') }}</label>
            <textarea id="route" name="route"
              placeholder="{{ _('Kuvaile marssin reitti pilkuilla eroteltuna, esim. Rautatientori, Mannerheimintie, Eduskuntatalo') }}"></textarea>
            <div class="helper-text">
              <i class="fa-solid fa-route"></i>
              {{ _('Anna osallistujille k√§sitys marssin kulusta. Erota kadunnimet pilkulla (,) ‚Äî n√§in voimme render√∂id√§
              ne demo-sivulla.') }}
            </div>
          </div>

          <div class="form-group">
            <label>{{ _('Reitin esikatselu') }}</label>
            <div id="route-preview" class="editor-container" style="min-height:60px; padding:0.75rem;">
              <em id="route-preview-empty" style="color:var(--color-text-secondary)">{{ _('Ei reitti√§ annettu') }}</em>
              <ul id="route-preview-list" style="margin:0; padding-left:1.25rem; display:none;"></ul>
            </div>
            <div class="helper-text">
              <i class="fa-solid fa-eye"></i>
              {{ _('Tarkista ett√§ listaus n√§kyy t√§ss√§ oikein, n√§in ne render√∂ityv√§t demo-sivulla.') }}
            </div>
          </div>

          <script>
            (function () {
              const textarea = document.getElementById('route');
              const list = document.getElementById('route-preview-list');
              const empty = document.getElementById('route-preview-empty');

              function escapeHtml(str) {
                return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;');
              }

              function renderPreview() {
                const raw = textarea.value || '';
                // somehow lets also include fullwidth commas and newlines as separators
                const items = raw.split(/[,]+/).map(s => s.trim()).filter(Boolean);
                if (items.length === 0) {
                  list.style.display = 'none';
                  empty.style.display = 'block';
                } else {
                  list.innerHTML = items.map(i => `<li>${escapeHtml(i)}</li>`).join('');
                  list.style.display = 'block';
                  empty.style.display = 'none';
                }
              }

              textarea.addEventListener('input', renderPreview);
              document.addEventListener('DOMContentLoaded', renderPreview);
            })();
          </script>
        </div>

        {% include "paikkakunta-dropdown.html" %}

        <div class="form-group">
          <label for="address">
            {{ _('Katuosoite / paikannimi') }}<span class="required-asterisk">*</span>
          </label>
          <input type="text" id="address" name="address"
            placeholder="{{ _('esim. Mannerheimintie 1, 00100 tai Eduskuntatalo') }}" required
            pattern="^.+(?:,\s*\d{3,5})?$"
            title="{{ _('Muoto: esim. Mannerheimintie 1, 00100 tai paikka kuten Eduskuntatalo. √Ñl√§ lis√§√§ paikkakuntaa.') }}" />
          <div class="helper-text">
            <i class="fa-solid fa-map-marker-alt"></i>
            {{ _('Anna katuosoite tai pelkk√§ paikannimi (esim. "Eduskuntatalo"). Voit lis√§t√§ postinumeron pilkun
            j√§lkeen, esim. "Mannerheimintie 1, 00100". √Ñl√§ lis√§√§ paikkakuntaa, se lis√§t√§√§n automaattisesti
            paikkakuntavalinnan perusteella.') }}
          </div>
        </div>

        <div class="form-navigation">
          <button type="button" class="btn btn-secondary" onclick="previousPage()">
            <i class="fa-solid fa-arrow-left"></i>
            {{ _('Edellinen') }}
          </button>
          <div class="btn-nav-spacer"></div>
          <button type="button" class="btn btn-primary" onclick="nextPage()">
            {{ _('Seuraava') }}
            <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Page 3: Organizers -->
      <div class="form-page" id="page-3">
        <div class="page-header">
          <h2>
            <i class="fa-solid fa-users-gear"></i>
            {{ _('J√§rjest√§j√§t') }}
          </h2>
          <p>{{ _('Kuka tai ketk√§ j√§rjest√§v√§t t√§m√§n mielenosoituksen? Voit lis√§t√§ yhden tai useamman j√§rjest√§j√§n.') }}
          </p>
        </div>

        <div id="organizers-container" class="organizer-list">
          <!-- Organizers will be added here -->
        </div>

        <button type="button" class="add-organizer-button" onclick="addOrganizer()">
          <i class="fa-solid fa-plus-circle"></i>
          {{ _('Lis√§√§ j√§rjest√§j√§') }}
        </button>

        <div class="helper-text" style="margin-top: 1.5rem;">
          <i class="fa-solid fa-heart"></i>
          {{ _('J√§rjest√§j√§tiedot auttavat osallistujia saamaan lis√§tietoja ja olemaan yhteydess√§') }}
        </div>

        <div class="form-navigation">
          <button type="button" class="btn btn-secondary" onclick="previousPage()">
            <i class="fa-solid fa-arrow-left"></i>
            {{ _('Edellinen') }}
          </button>
          <div class="btn-nav-spacer"></div>
          <button type="button" class="btn btn-primary" onclick="nextPage()">
            {{ _('Seuraava') }}
            <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- by default at least one organizer -->
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          addOrganizer();
        });
      </script>

      <!-- Page 4: Submitter Info & Terms -->
      <div class="form-page" id="page-4">
        <div class="page-header">
          <h2>
            <i class="fa-solid fa-user-check"></i>
            {{ _('Yhteystietosi') }}
          </h2>
          <p>{{ _('Viimeinen askel! Kerro meille viel√§ omat yhteystietosi. Tietojasi k√§sitell√§√§n luottamuksellisesti.')
            }}</p>
        </div>

        <div class="form-group">
          <label for="submitter_role">
            {{ _('Roolisi') }}<span class="required-asterisk">*</span>
          </label>
          <input type="text" id="submitter_role" name="submitter_role"
            placeholder="{{ _('esim. j√§rjest√§j√§, osallistuja, vapaaehtoinen') }}" required />
          <div class="helper-text">
            <i class="fa-solid fa-id-badge"></i>
            {{ _('Mik√§ on suhteesi tapahtumaan?') }}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="submitter_name">
              {{ _('Nimesi tai nimimerkkisi') }}<span class="required-asterisk">*</span>
            </label>
            <input type="text" id="submitter_name" name="submitter_name" placeholder="{{ _('Nimi') }}" required />
          </div>

          <div class="form-group">
            <label for="submitter_email">
              {{ _('S√§hk√∂postiosoitteesi') }}<span class="required-asterisk">*</span>
            </label>
            <input type="email" id="submitter_email" name="submitter_email" placeholder="email@example.com" required />
          </div>
        </div>

        <div class="helper-text" style="margin-bottom: 2rem;">
          <i class="fa-solid fa-shield-halved"></i>
          {{ _('Yhteystietojasi k√§ytet√§√§n vain tarvittaessa yhteydenottoon liittyen ilmoitukseesi') }}
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="accept_terms" name="accept_terms" required />
          <label for="accept_terms">
            {{ _('Hyv√§ksyn') }}
            <a href="{{ url_for('terms') }}" target="_blank">{{ _('k√§ytt√∂ehdot') }}</a>
            {{ _('ja olen lukenut') }}
            <a href="{{ url_for('privacy') }}" target="_blank">{{ _('tietosuojaselosteen') }}</a>.
            <span class="required-asterisk">*</span>
          </label>
        </div>

        <div class="form-navigation">
          <button type="button" class="btn btn-secondary" onclick="previousPage()">
            <i class="fa-solid fa-arrow-left"></i>
            {{ _('Edellinen') }}
          </button>
          <div class="btn-nav-spacer"></div>


          <!-- submit btn -->
          <button type="submit" id="submit-form" class="btn btn-success">
            <i class="fa-solid fa-paper-plane"></i>
            {{ _('L√§het√§ ilmoitus') }}
          </button>
        </div>
      </div>

      <!-- Page 5: Success -->
      <div class="form-page" id="page-5">
        <div class="success-page">
          <div class="success-icon">
            <i class="fa-solid fa-check"></i>
          </div>
          <h2>üéâ {{ _('Kiitos ilmoituksestasi!') }}</h2>
          <p>
            {{ _('Mielenosoitusilmoituksesi on vastaanotettu ja se k√§sitell√§√§n pian. Saat vahvistusviestin
            s√§hk√∂postiisi.') }}
          </p>
          <p>
            {{ _('Yhdess√§ teemme muutosta! Kiitos, ett√§ jaat t√§rke√§√§ tietoa yhteis√∂n kanssa.') }}
          </p>
          <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
            <a href="{{ url_for('index') }}" class="btn btn-primary">
              <i class="fa-solid fa-home"></i>
              {{ _('Palaa etusivulle') }}
            </a>
            <a href="{{ url_for('submit') }}" class="btn btn-secondary">
              <i class="fa-solid fa-plus"></i>
              {{ _('Ilmoita uusi tapahtuma') }}
            </a>
          </div>
        </div>
      </div>

    </div>
  </form>

  <!-- Help Section -->
  <div class="form-container" style="margin-top: 2rem;">
    <div class="page-header">
      <h2>
        <i class="fa-solid fa-life-ring"></i>
        {{ _('Tarvitsetko apua?') }}
      </h2>
      <p>{{ _('Olemme t√§√§ll√§ auttamassa sinua! Jos sinulla on kysytt√§v√§√§ tai tarvitset tukea lomakkeen t√§ytt√§misess√§.')
        }}</p>
    </div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <a href="{{ url_for('contact') }}" class="btn btn-secondary">
        <i class="fa-solid fa-envelope"></i>
        {{ _('Ota yhteytt√§') }}
      </a>
      <a href="{{ url_for('info') }}" class="btn btn-secondary">
        <i class="fa-solid fa-circle-info"></i>
        {{ _('Lis√§tietoja') }}
      </a>
    </div>
  </div>
</div>


<script>
  document.querySelectorAll("input, select, textarea").forEach(el => {
    el.addEventListener("input", () => {
      if (el.type === "file") return;   // DO NOT STORE FILE INPUTS
      localStorage.setItem(`form_${el.name}`, el.value);
    });
  });

  document.querySelectorAll("input, select, textarea").forEach(el => {
    const saved = localStorage.getItem(`form_${el.name}`);
    if (el.type === "file") {
      // never restore files from cache
      return;
    }
    if (saved !== null) {
      el.value = saved;
    } else {
      if (el.type === "checkbox" || el.type === "radio") {
        el.checked = false; // ensure unchecked if nothing saved
      } else {
        el.value = ""; // ensure empty if nothing saved, so that it does not pull from browser autofill
        // this helps with checkboxes/radio buttons too
      }
    }
  });

  // Check if there is ANY form data stored
  function formCacheExists() {
    return Object.keys(localStorage).some(key => key.startsWith("form_") && key !== "form_step"); // form step is not form data
  }

  // Show notice if cached
  window.addEventListener("DOMContentLoaded", () => {
    const notice = document.getElementById("cacheNotice");

    if (formCacheExists()) {
      notice.classList.remove("hidden");
    } else {
      notice.classList.add("hidden");

      // Clear any step info if no form data
      localStorage.removeItem("form_step");
      // clear all form data // set value to "" in form
      formData = document.querySelectorAll("input, select, textarea");
      formData.forEach(el => {
        localStorage.removeItem(`form_${el.name}`);
        el.value = "";
      });
    }

    const savedStep = localStorage.getItem("form_step");
    if (savedStep) {
      showPage(parseInt(savedStep));
    }

  });

  // Reset function
  document.getElementById("resetCacheBtn")?.addEventListener("click", () => {
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith("form_")) localStorage.removeItem(key);
    });

    localStorage.removeItem("form_step");

    // reload page clean
    location.reload();
  });



  // no-op duplicate submit listener removed


</script>
{% endblock %}
