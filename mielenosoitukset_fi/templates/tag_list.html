{% extends 'base.html' %}

{% block title %} #{{ tag_name }} {{ _('Mielenosoitukset') }} {% endblock %}

{% block meta %}
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="{{ _('Lista tulevista mielenosoituksista') }}" />
<meta name="keywords" content="mielenosoitus, tapahtuma, Helsinki" />
<meta name="author" content="Mielenosoitukset.fi" />
<meta name="robots" content="index, follow" />
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/toolbox.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/demo.css') }}">

<!-- New v2 styling like list.html -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/list.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/demo_list.css') }}">

<style>
  .tag-cover-picture img {
    width: 100%;
    max-height: 320px;
    object-fit: cover;
    border-radius: 1.2em;
  }

  .tag-banner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(90deg, var(--color-primary) 0%, #4ea1ff 100%);
    color: #fff;
    border-radius: 1.2em;
    padding: 1.5em 1em 1.2em 1em;
    margin: 2em 0;
    box-shadow: 0 4px 24px rgba(0, 86, 179, 0.10), 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .tag-banner .tag-label {
    font-size: 1.1em;
    font-weight: 700;
    padding: 0.3em 1.2em;
    border-radius: 2em;
    background: rgba(255, 255, 255, 0.15);
    margin-bottom: 0.5em;
  }

  .tag-banner .tag-name {
    font-size: 2em;
    font-weight: 900;
    margin-bottom: 0.2em;
  }

  .tag-banner .tag-desc {
    font-size: 1.1em;
    max-width: 600px;
    text-align: center;
    opacity: 0.9;
  }
</style>

{% endblock %}

{% block content %}

<script>
  /* Pass tag filter to JS globally */
  window.TAG_FILTER = "{{ tag_name }}";
</script>

<!-- Shared rendering partial -->
{% include "_modals/_demo-card-template.html" %}

<section class="main-content">

  {% if tag and tag.cover_picture %}
  <div class="tag-cover-picture">
    <img src="{{ tag.cover_picture }}" alt="Tag Cover Photo">
  </div>
  {% endif %}

  <div class="tag-banner">
    <div class="tag-label">
      <i class="fa-solid fa-hashtag"></i> {{ _('Tagi') }}
    </div>
    <div class="tag-name">#{{ tag_name }}</div>
    <div class="tag-desc">
      {{ _('N√§et t√§ss√§ vain mielenosoitukset, jotka on merkitty tagilla') }}
      <strong>#{{ tag_name }}</strong>.<br>
      {{ _('Voit hakea, suodattaa ja selata vain t√§m√§n aiheen tapahtumia. Jos haluat n√§hd√§ kaikki mielenosoitukset,
      palaa yleisn√§kym√§√§n.') }}
    </div>
  </div>

  <!-- Search Form (same as list.html) -->
  <form method="GET" action="#" class="search-form" id="search-form">
    <input type="text" name="search" placeholder="{{ _('Hae mielenosoituksia...') }}">
    <input type="text" placeholder="{{ _('Kaupunki') }}" id="city_input">
    <input type="hidden" name="city" id="city">
    <div class="suggestions" id="city_suggestions"></div>

    <input type="text" name="location" placeholder="{{ _('Sijainti') }}">

    <div class="date-range">
      <input type="text" name="display_date_start" id="date_start" placeholder="{{ _('Alkup√§iv√§ (pp.mm.vvvv)') }}">
      <span>-</span>
      <input type="text" name="display_date_end" id="date_end" placeholder="{{ _('Loppup√§iv√§ (pp.mm.vvvv)') }}">
    </div>

    <div class="date-error" id="date-error">
      {{ _('Valitse kelvollinen p√§iv√§m√§√§r√§v√§li tulevaisuudesta') }}
    </div>

    <input type="hidden" name="date_start" id="iso_date_start">
    <input type="hidden" name="date_end" id="iso_date_end">

    <div class="filters" id="filters"></div>

    <button type="submit" class="button">{{ _('Hae') }}</button>
  </form>

  <section class="section-card">
    <h2 class="section-title">
      <i class="fa-solid fa-calendar-days"></i>
      {{ _('T√§m√§n tagin mielenosoitukset') }}
    </h2>

    <div id="demos-grid" class="demos-grid"></div>

    <button id="load-more-btn" class="button button-secondary" style="display:none;">
      {{ _('N√§yt√§ lis√§√§') }}
    </button>

    <!-- Empty State -->
    <div id="no-results" class="no-results-card" style="display:none;">
      <div class="no-results-icon"><i class="fa-regular fa-calendar-xmark"></i></div>
      <h3 class="no-results-title">{{ _('Ei l√∂ytynyt mielenosoituksia') }}</h3>
      <p class="no-results-text">
        {{ _('T√§ll√§ tagilla ei ole mielenosoituksia. Tarkista my√∂hemmin tai palaa takaisin.') }}
      </p>
      <div class="no-results-action">
        <a href="{{ url_for('submit') }}" class="button button-primary">
          <i class="fa-solid fa-plus"></i>{{ _('Ilmoita uusi mielenosoitus') }}
        </a>
      </div>
    </div>

  </section>
</section>

{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{{ url_for('static', filename='js/date.js') }}"></script>
<script src="{{ url_for('static', filename='js/jQuery/jq.min.js') }}"></script>

<!-- Shared v2 JS -->
<script src="{{ url_for('static', filename='js/demo.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/demo-card-render.js') }}" defer></script>

<script>
  const cityList = {{ city_list | tojson }};
  window.TAG_FILTER = "{{ tag_name }}";
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    /* -------------------------------------------------------------
     * Basic Setup
     * -----------------------------------------------------------*/
    const grid = document.getElementById("demos-grid");
    const loadMoreBtn = document.getElementById("load-more-btn");
    const searchForm = document.getElementById("search-form");
    const noResults = document.getElementById("no-results");
    const filters = $("#filters");

    let extraParams = {};
    let currentPage = 1;

    // Always apply tag filter
    if (window.TAG_FILTER) extraParams.tag = window.TAG_FILTER;

    // Load existing city filter from server-side hidden input
    const initialCities = searchForm.querySelector('input[name="city"]').value.trim();
    if (initialCities) extraParams.city = initialCities;

    /* -------------------------------------------------------------
     * Helper: Show No Results Modal
     * -----------------------------------------------------------*/
    function showNoResults() {
      grid.innerHTML = "";
      noResults.style.display = "block";

      const hasFilters =
        extraParams.search ||
        extraParams.city ||
        extraParams.location ||
        extraParams.date_start ||
        extraParams.date_end;

      noResults.querySelector(".no-results-text").innerText =
        hasFilters
          ? "Ei l√∂ytynyt mielenosoituksia n√§ill√§ hakukriteereill√§. Kokeile poistaa suodattimia tai hae uudelleen."
          : "T√§ll√§ tagilla ei ole n√§kyvill√§ olevia mielenosoituksia.";

      // Create dynamic clear filters button
      const container = noResults.querySelector(".no-results-action");
      container.innerHTML = `
      <button id="clear-filters-btn" class="button button-secondary">
  Poista suodattimet
</button>

      <a href="{{ url_for('submit') }}" class="button button-primary">
        <i class="fa-solid fa-plus"></i> Ilmoita uusi mielenosoitus
      </a>
    `;

      document.getElementById("clear-filters-btn")?.addEventListener("click", () => {
        // üîπ Reset hidden inputs
        searchForm.search.value = "";
        searchForm.city.value = "";
        searchForm.location.value = "";
        searchForm.date_start.value = "";
        searchForm.date_end.value = "";

        // üîπ Remove pills
        $("#filters").empty();

        // üîπ Reset search params keeping only tag
        extraParams = {};
        if (window.TAG_FILTER) extraParams.tag = window.TAG_FILTER;

        // üîπ Reload demos
        loadDemosWrapper(1, false);
      });

    }

    /* -------------------------------------------------------------
     * Helper: Load Demos
     * -----------------------------------------------------------*/
    async function loadDemosWrapper(page = 1, append = false) {
      if (!append) {
        noResults.style.display = "none";
        grid.innerHTML = `
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Ladataan mielenosoituksia...</p>
        </div>`;
      } else {
        loadMoreBtn.classList.add("loading");
        loadMoreBtn.disabled = true;
      }

      const result = await loadDemos(page, append, extraParams);

      console.log(result);

      loadMoreBtn.classList.remove("loading");
      loadMoreBtn.disabled = false;


      // No more pages?
      if (page >= result.total_pages) {
        loadMoreBtn.style.display = "none";
      } else {
        loadMoreBtn.style.display = "block";
      }
    }

    /* -------------------------------------------------------------
     * Initial Load
     * -----------------------------------------------------------*/
    loadDemosWrapper();

    /* -------------------------------------------------------------
     * Search Form
     * -----------------------------------------------------------*/
    searchForm.addEventListener("submit", e => {
      e.preventDefault();

      const searchValue = searchForm.search.value.trim();
      const cityValue = searchForm.city.value.trim();
      const locationValue = searchForm.location.value.trim();
      const dateStart = searchForm.date_start.value;
      const dateEnd = searchForm.date_end.value;

      extraParams = {};
      if (window.TAG_FILTER) extraParams.tag = window.TAG_FILTER;

      if (searchValue) extraParams.search = searchValue;
      if (cityValue) extraParams.city = cityValue;
      if (locationValue) extraParams.location = locationValue;
      if (dateStart) extraParams.date_start = dateStart;
      if (dateEnd) extraParams.date_end = dateEnd;

      loadDemosWrapper(1, false);
    });

    /* ==================================================================
     *  CITY AUTOCOMPLETE + PILL SYSTEM
     * ==================================================================*/

    const cityInput = $("#city_input");
    const citySuggestions = $("#city_suggestions");
    const selectedCitiesInput = $("#city");

    /* -------------------------------------------------------------
     * Helper: Add pill
     * -----------------------------------------------------------*/
    function addCityPill(city) {
      const pill = $(`
      <div class="filter-pill" data-city="${city}">
        <span class="pill-label">
          <i class="fa-solid fa-city"></i> ${city}
        </span>
        <button class="pill-remove" data-city="${city}">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    `);

      filters.append(pill);

      pill.find(".pill-remove").on("click", e => {
        e.preventDefault();
        const cityToRemove = $(e.currentTarget).data("city");

        const current = selectedCitiesInput.val()
          ? selectedCitiesInput.val().split(",")
          : [];

        const updated = current.filter(c => c !== cityToRemove);
        selectedCitiesInput.val(updated.join(","));
        pill.remove();

        extraParams.city = updated.join(",");
        loadDemosWrapper(1, false);
      });
    }

    /* -------------------------------------------------------------
     * Render pills from server-side value
     * -----------------------------------------------------------*/
    if (initialCities) {
      initialCities.split(",").forEach(c => c.trim() && addCityPill(c.trim()));
    }

    /* -------------------------------------------------------------
     * Autocomplete (debounced)
     * -----------------------------------------------------------*/
    let debounceTimer = null;

    cityInput.on("input", function () {
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        const query = cityInput.val().trim().toLowerCase();
        if (query.length < 2) {
          citySuggestions.empty().removeClass("show");
          return;
        }

        const results = cityList
          .filter(c => c.toLowerCase().includes(query))
          .sort((a, b) => a.localeCompare(b));

        citySuggestions.empty();

        results.forEach(city => {
          const markup = $("<div>")
            .addClass("suggestion-item")
            .html(city.replace(new RegExp(query, "i"), match => `<strong>${match}</strong>`));

          markup.on("click", () => {
            const cleanCity = city.trim();
            const current = selectedCitiesInput.val()
              ? selectedCitiesInput.val().split(",")
              : [];

            if (!current.includes(cleanCity)) {
              current.push(cleanCity);
              selectedCitiesInput.val(current.join(","));
              addCityPill(cleanCity);
            }

            extraParams.city = current.join(",");
            citySuggestions.empty().removeClass("show");
            cityInput.val("");

            loadDemosWrapper(1, false);
          });

          citySuggestions.append(markup);
        });

        citySuggestions.addClass("show");
      }, 120); // debounce
    });

    /* Close suggestions on outside click */
    $(document).on("click", e => {
      if (!citySuggestions.is(e.target) && citySuggestions.has(e.target).length === 0) {
        citySuggestions.empty().removeClass("show");
      }
    });

  });


</script>

{% endblock %}