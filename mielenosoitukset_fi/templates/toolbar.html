<link rel="stylesheet" href="{{ url_for('static', filename='css/toolbox.css') }}">
{% if organization %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/modal.css') }}">
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>

{% endif %}
{% import 'admin_V2/organizations/macros.html' as org_macros %}

<div id="demo-toolbox" class="card shadow-sm bg-light mb-3" style="width: 100%; max-width: 380px;">
    <!-- Header -->
    <div class="card-header bg-primary text-light d-flex align-items-center justify-content-between">
        <h5 class="mb-0">{{ _('Työkalupakki') }}</h5>
        <button class="btn btn-light btn-sm" id="toolbar-toggle" onclick="toggleToolbox()">
            <i class="fa-solid fa-toolbox"></i>
        </button>
    </div>

    <!-- Body / Buttons -->
    <div class="card-body p-3">
        {% if demo %}
        <div class="d-grid gap-2 mb-3">
            {% if not demo.approved and current_user.has_permission("ACCEPT_DEMO") %}
            <button class="btn btn-success btn-sm d-flex align-items-center justify-content-center"
                    onclick="acceptDemo('{{ demo['_id'] }}')">
                <i class="fa-solid fa-check me-2"></i>{{ _('Hyväksy') }}
            </button>

            <button class="btn btn-danger btn-sm d-flex align-items-center justify-content-center"
                    onclick="rejectDemo('{{ demo['_id'] }}')">
                <i class="fa-solid fa-times me-2"></i>{{ _('Hylkää') }}
            </button>
            {% endif %}

            {% if current_user.has_permission("EDIT_DEMO") %}
            <a href="{{ url_for('admin_demo.edit_demo', demo_id=demo['_id']) }}" 
               class="btn btn-warning btn-sm d-flex align-items-center justify-content-center">
                <i class="fas fa-edit me-2"></i>{{ _('Muokkaa') }}
            </a>
            {% endif %}

            {% if current_user.has_permission("VIEW_DEMO") %}
            <a href="{{ url_for('demonstration_detail', demo_id=demo['_id']) }}"
               class="btn btn-info btn-sm d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-eye me-2"></i>{{ _('Katsele') }}
            </a>
            <button class="btn btn-secondary btn-sm d-flex align-items-center justify-content-center"
                    onclick="fetchDemoInfo('{{ demo['_id'] }}')">
                <i class="fa-solid fa-info me-2"></i>{{ _('Lisätietoja') }}
            </button>
            {% endif %}

            {% if current_user.has_permission("DELETE_DEMO") %}
            <button class="btn btn-outline-danger btn-sm d-flex align-items-center justify-content-center"
                    onclick="openModal(event, '{{ demo.title }}', '{{ demo['_id'] }}')">
                <i class="fas fa-trash-alt me-2"></i>{{ _('Poista') }}
            </button>
            {% endif %}

            {% if current_user.has_permission("VIEW_ANALYTICS") %}
            <a href="{{ url_for('admin.stats') }}" class="btn btn-primary btn-sm d-flex align-items-center justify-content-center">
                <i class="fas fa-chart-line me-2"></i>{{ _('Tilastot') }}
            </a>
            <div id="stats-content" class="mt-2 small"></div>
            {% endif %}
        </div>
        {% endif %}

        {% if org %}
        <div class="d-grid gap-2 mb-3">
            {% if current_user.has_permission("EDIT_ORGANIZATION") %}
            <a href="{{ url_for('admin_org.edit_organization', org_id=org['_id']) }}" 
               class="btn btn-warning btn-sm d-flex align-items-center justify-content-center">
                <i class="fas fa-edit me-2"></i>{{ _('Muokkaa') }}
            </a>
            {% endif %}

            {% if current_user.has_permission("VIEW_ORGANIZATION") %}
            <a href="{{ url_for('org', org_id=org['_id']) }}" 
               class="btn btn-info btn-sm d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-eye me-2"></i>{{ _('Katsele') }}
            </a>
            {% endif %}

            {% if current_user.has_permission("DELETE_ORGANIZATION") %}
            <button class="btn btn-outline-danger btn-sm d-flex align-items-center justify-content-center"
                    onclick="openModal(event, '{{ org.name }}', '{{ org['_id'] }}')">
                <i class="fas fa-trash-alt me-2"></i>{{ _('Poista') }}
            </button>
            {% endif %}

            {% if current_user.has_permission("INVITE_TO_ORGANIZATION") %}
            <button class="btn btn-success btn-sm d-flex align-items-center justify-content-center" data-modal-target="#inviteModal">
                <i class="fas fa-user-plus me-2"></i>{{ _('Kutsu käyttäjiä') }}
            </button>
            {{ org_macros.invite_modal(org) }}
            {% endif %}

            {% if current_user.has_permission("VIEW_ORGANIZATION") %}
            <button class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center"
                    onclick="leaveOrganization('{{ org['_id'] }}')">
                <i class="fas fa-sign-out-alt me-2"></i>{{ _('Poistu organisaatiosta') }}
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Footer / Toggle -->
    <div class="card-footer text-center">
        <button id="toolbar-toggle-footer" class="btn btn-light btn-sm" onclick="toggleToolbox()">
            <i class="fa-solid fa-toolbox"></i>
        </button>
    </div>
</div>

<!-- JS for demo stats -->
{% if demo %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    fetch(`/api/demo/{{ demo['_id'] }}/stats`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("stats-content").innerHTML = `
                <p><strong><i class="fa-solid fa-eye"></i> {{ _('Näyttökerrat:') }}</strong> ${data.views}</p>
                <p><strong>{{ _('Osallistujat:') }}</strong> ${data.participants}</p>
            `;
        })
        .catch(console.error);
});
</script>
{% endif %}
