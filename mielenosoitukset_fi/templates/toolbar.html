<link rel="stylesheet" href="{{ url_for('static', filename='css/toolbox.css') }}">
{% if organization %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/modal.css') }}">
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
{% endif %}
{% import 'admin_V2/organizations/macros.html' as org_macros %}


<style>
#toolbox-sidebar {
    transition: width 0.3s;
    width: 280px; /* full size */
    z-index: 10;
}

#toolbox-sidebar.collapsed {
    width: 50px; /* only enough for the button */
}

#toolbox-sidebar .card-body,
#toolbox-sidebar .card-header h6 {
    transition: opacity 0.3s;
}

#toolbox-sidebar.collapsed .card-body,
#toolbox-sidebar.collapsed .card-header h6 {
    opacity: 0;
    height: 0;
    overflow: hidden;
    pointer-events: none; /* prevent clicking hidden buttons */
}

#toolbox-sidebar .collapse-toggle {
    width: 40px;
    height: 40px;
    padding: 0;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>


<div id="toolbox-sidebar" class="position-fixed top-0 end-0 m-3">
    <div class="card text-light bg-dark shadow">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary">
            <h6 class="mb-0"><i class="fa-solid fa-toolbox me-2"></i>{{ _('Työkalupakki') }}</h6>
            <button class="btn btn-sm btn-light collapse-toggle" onclick="toggleToolbox()">
                <i class="fa-solid fa-angle-left"></i>
            </button>
        </div>

        <div class="card-body p-2">
            {% if demo %}
            <div class="d-grid gap-2 mb-2">
                {% if not demo.approved and current_user.has_permission("ACCEPT_DEMO") %}
                <button class="btn btn-success btn-sm"
                    onclick="confirmAction(() => acceptDemo('{{ demo['_id'] }}'), '{{ _('Hyväksytkö tämän mielenosoituksen?') }}')">
                    <i class="fa-solid fa-check me-1"></i>{{ _('Hyväksy') }}
                </button>
                <button class="btn btn-danger btn-sm"
                    onclick="confirmAction(() => rejectDemo('{{ demo['_id'] }}'), '{{ _('Hylkää tämä mielenosoitus?') }}')">
                    <i class="fa-solid fa-times me-1"></i>{{ _('Hylkää') }}
                </button>
                {% endif %}

                {% if current_user.has_permission("EDIT_DEMO") %}
                <a href="{{ url_for('admin_demo.edit_demo', demo_id=demo['_id']) }}" class="btn btn-warning btn-sm">
                    <i class="fas fa-edit me-1"></i>{{ _('Muokkaa') }}
                </a>
                {% endif %}

                {% if current_user.has_permission("VIEW_DEMO") %}
                <a href="{{ url_for('demonstration_detail', demo_id=demo['_id']) }}" class="btn btn-info btn-sm">
                    <i class="fa-solid fa-eye me-1"></i>{{ _('Katsele') }}
                </a>
                <button class="btn btn-secondary btn-sm" onclick="fetchDemoInfo('{{ demo['_id'] }}')">
                    <i class="fa-solid fa-info me-1"></i>{{ _('Lisätietoja') }}
                </button>
                {% endif %}

                {% if current_user.has_permission("DELETE_DEMO") %}
                <button class="btn btn-danger btn-sm"
                    onclick="confirmAction(() => openModal(event, '{{ demo.title }}', '{{ demo['_id'] }}'), '{{ _('Haluatko varmasti poistaa tämän mielenosoituksen? Tämä ei ole palautettavissa!') }}')">
                    <i class="fas fa-trash-alt me-1"></i>{{ _('Poista') }}
                </button>
                {% endif %}

                {% if current_user.has_permission("VIEW_ANALYTICS") %}
                <a href="{{ url_for('admin.demo_analytics', demo_id=demo['_id']) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-chart-line me-1"></i>{{ _('Tilastot') }}
                </a>
                <div id="stats-content" class="mt-1 small"></div>
                {% endif %}
            </div>
            {% endif %}

            {% if org %}
            <div class="d-grid gap-2 mb-2">
                {% if current_user.has_permission("EDIT_ORGANIZATION") %}
                <a href="{{ url_for('admin_org.edit_organization', org_id=org['_id']) }}"
                    class="btn btn-warning btn-sm">
                    <i class="fas fa-edit me-1"></i>{{ _('Muokkaa') }}
                </a>
                {% endif %}

                {% if current_user.has_permission("VIEW_ORGANIZATION") %}
                <a href="{{ url_for('org', org_id=org['_id']) }}" class="btn btn-info btn-sm">
                    <i class="fa-solid fa-eye me-1"></i>{{ _('Katsele') }}
                </a>
                {% endif %}

                {% if current_user.has_permission("DELETE_ORGANIZATION") %}
                <button class="btn btn-danger btn-sm"
                    onclick="confirmAction(() => openModal(event, '{{ org.name }}', '{{ org['_id'] }}'), '{{ _('Haluatko varmasti poistaa tämän organisaation? Tämä ei ole palautettavissa!') }}')">
                    <i class="fas fa-trash-alt me-1"></i>{{ _('Poista') }}
                </button>
                {% endif %}

                {% if current_user.has_permission("INVITE_TO_ORGANIZATION") %}
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#inviteModal">
                    <i class="fas fa-user-plus me-1"></i>{{ _('Kutsu käyttäjiä') }}
                </button>
                <!-- script to add the invite modal right before backdrop -->
                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        html_content = `
                            {{ org_macros.invite_modal(org) }}
                        `;
                        document.body.insertAdjacentHTML("beforeend", html_content);
                        // we want it before the backdrop
                    });
                </script>

                {% endif %}

                {% if current_user.has_permission("VIEW_ORGANIZATION") %}
                <button class="btn btn-secondary btn-sm"
                    onclick="confirmAction(() => leaveOrganization('{{ org['_id'] }}'), '{{ _('Haluatko varmasti poistua organisaatiosta?') }}')">
                    <i class="fas fa-sign-out-alt me-1"></i>{{ _('Poistu organisaatiosta') }}
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>

    </div>

</div>



<script>
    function toggleToolbox() {
    const sidebar = document.getElementById('toolbox-sidebar');
    sidebar.classList.toggle('collapsed');

    const icon = sidebar.querySelector('.collapse-toggle i');
    if(sidebar.classList.contains('collapsed')){
        icon.classList.remove('fa-angle-left');
        icon.classList.add('fa-angle-right');
    } else {
        icon.classList.remove('fa-angle-right');
        icon.classList.add('fa-angle-left');
    }
}

    // Confirm action for destructive stuff
    function confirmAction(callback, message) {
        if (confirm(message)) {
            callback();
        }
    }

    {% if demo %}
    document.addEventListener("DOMContentLoaded", () => {
        fetch(`/api/demo/{{ demo['_id'] }}/stats`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("stats-content").innerHTML = `
                <p><strong><i class="fa-solid fa-eye"></i> {{ _('Näyttökerrat:') }}</strong> ${data.views}</p>
                <p><strong>{{ _('Osallistujat:') }}</strong> ${data.participants}</p>
            `;
            })
            .catch(console.error);
    });
    {% endif %}
</script>

