{% extends "base.html" %}

{% block title %}{{ _('Vaihda salasana') }}{% endblock %}

{% block styles %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/auth.css') }}">
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-container">
        <div class="auth-header">
            <div class="auth-icon">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h1>{{ _('Pakotettu salasanan vaihto') }}</h1>
            <p class="auth-subtitle">{{ _('Ylläpito on pakottanut salasanan vaihdon. Anna uusi salasana ja vahvista se.') }}</p>
        </div>

        <div id="error-message" class="hidden"></div>

        <form method="POST" id="password-reset-form">
            <!-- New Password -->
            <div class="form-group">
                <label class="form-label" for="new_password">
                    <i class="fa-solid fa-lock"></i>
                    {{ _('Uusi salasana') }}
                </label>
                <div class="form-input-wrapper">
                    <i class="fa-solid fa-lock form-input-icon"></i>
                    <input type="password" 
                           id="new_password" 
                           name="new_password" 
                           required 
                           minlength="12" 
                           class="form-input"
                           placeholder="{{ _('Syötä uusi salasana') }}"
                           autocomplete="new-password">
                    <button type="button" 
                            class="password-toggle" 
                            onclick="togglePasswordField('new_password')"
                            aria-label="{{ _('Näytä/piilota salasana') }}">
                        <i class="fa-solid fa-eye" id="new_password-toggle-icon"></i>
                    </button>
                </div>
                <div class="strength-meter">
                    <div id="strength-fill" class="strength-meter-fill"></div>
                </div>
                <div id="pwd-now-missing" class="password-match"></div>
            </div>

            <!-- Confirm Password -->
            <div class="form-group">
                <label class="form-label" for="confirm_password">
                    <i class="fa-solid fa-lock"></i>
                    {{ _('Vahvista salasana') }}
                </label>
                <div class="form-input-wrapper">
                    <i class="fa-solid fa-lock form-input-icon"></i>
                    <input type="password" 
                           id="confirm_password" 
                           name="confirm_password" 
                           required 
                           class="form-input"
                           placeholder="{{ _('Vahvista uusi salasana') }}"
                           autocomplete="new-password">
                    <button type="button" 
                            class="password-toggle" 
                            onclick="togglePasswordField('confirm_password')"
                            aria-label="{{ _('Näytä/piilota salasana') }}">
                        <i class="fa-solid fa-eye" id="confirm_password-toggle-icon"></i>
                    </button>
                </div>
                <div id="password-match-message" class="password-match">
                    {{ _('Salasanat eivät täsmää') }}
                </div>
            </div>

            <!-- Password Requirements -->
            <div class="password-requirements-container">
                <p class="password-requirements">{{ _('Salasanan on täytettävä seuraavat vaatimukset:') }}</p>
                <ul class="password-requirements">
                    <li id="req-length">{{ _('Vähintään 12 merkkiä pitkä') }}</li>
                    <li id="req-lower">{{ _('Sisältää vähintään yhden pienen kirjaimen (a-z)') }}</li>
                    <li id="req-upper">{{ _('Sisältää vähintään yhden suuren kirjaimen (A-Z)') }}</li>
                    <li id="req-special">{{ _('Sisältää vähintään yhden erikoismerkin:') }} !@#$%^&*()-_=+[]{};:,.<>?</li>
                </ul>
            </div>

            <button type="button" id="generate-password" class="btn btn-secondary mb-2">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                {{ _('Luo vahva salasana') }}
            </button>
            
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <i class="fa-solid fa-check-circle"></i>
                {{ _('Vaihda salasana') }}
            </button>
        </form>

        <div class="auth-footer">
            <p class="help-text">
                <i class="fa-solid fa-circle-info"></i>
                {{ _('Varmista, että tallennat uuden salasanasi turvalliseen paikkaan.') }}
            </p>
        </div>
    </div>
</div>

<script>
// Toggle password field visibility
function togglePasswordField(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-toggle-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Show error message
function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.className = 'alert alert-error';
    errorDiv.innerHTML = `
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>${message}</span>
    `;
    errorDiv.classList.remove('hidden');
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Show success message
function showSuccess(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.className = 'alert alert-success';
    errorDiv.innerHTML = `
        <i class="fa-solid fa-circle-check"></i>
        <span>${message}</span>
    `;
    errorDiv.classList.remove('hidden');
}

// Hide message
function hideMessage() {
    document.getElementById('error-message').classList.add('hidden');
}

document.addEventListener("DOMContentLoaded", () => {
    const passwordInput = document.getElementById("new_password");
    const confirmInput = document.getElementById("confirm_password");
    const strengthFill = document.getElementById("strength-fill");
    const pwdNowMissing = document.getElementById("pwd-now-missing");
    const matchMessage = document.getElementById("password-match-message");

    const reqLength = document.getElementById("req-length");
    const reqLower = document.getElementById("req-lower");
    const reqUpper = document.getElementById("req-upper");
    const reqSpecial = document.getElementById("req-special");
    const generateBtn = document.getElementById("generate-password");
    const specialRegex = /[!@#$%^&*()\-\_=+\[\]{};:,.<>?]/;

    function updateStrength() {
        const pwd = passwordInput.value;
        let score = 0;
        
        if (pwd.length >= 12) score++;
        if (/[a-z]/.test(pwd)) score++;
        if (/[A-Z]/.test(pwd)) score++;
        if (specialRegex.test(pwd)) score++;
        
        if (score <= 2) {
            strengthFill.className = "strength-meter-fill strength-weak";
            strengthFill.style.width = "33%";
        } else if (score <= 3) {
            strengthFill.className = "strength-meter-fill strength-medium";
            strengthFill.style.width = "66%";
        } else {
            strengthFill.className = "strength-meter-fill strength-strong";
            strengthFill.style.width = "100%";
        }
    }

    function updateRequirements() {
        const pwd = passwordInput.value;
        let missing = [];

        // Check length
        if (pwd.length >= 12) {
            reqLength.classList.add("valid");
            reqLength.classList.remove("invalid");
        } else {
            reqLength.classList.add("invalid");
            reqLength.classList.remove("valid");
            missing.push("{{ _('Vähintään 12 merkkiä pitkä') }}");
        }

        // Check lowercase
        if (/[a-z]/.test(pwd)) {
            reqLower.classList.add("valid");
            reqLower.classList.remove("invalid");
        } else {
            reqLower.classList.add("invalid");
            reqLower.classList.remove("valid");
            missing.push("{{ _('Vähintään yksi pieni kirjain') }}");
        }

        // Check uppercase
        if (/[A-Z]/.test(pwd)) {
            reqUpper.classList.add("valid");
            reqUpper.classList.remove("invalid");
        } else {
            reqUpper.classList.add("invalid");
            reqUpper.classList.remove("valid");
            missing.push("{{ _('Vähintään yksi iso kirjain') }}");
        }

        // Check special characters
        if (specialRegex.test(pwd)) {
            reqSpecial.classList.add("valid");
            reqSpecial.classList.remove("invalid");
        } else {
            reqSpecial.classList.add("invalid");
            reqSpecial.classList.remove("valid");
            missing.push("{{ _('Vähintään yksi erikoismerkki') }}");
        }

        // Update status message
        if (missing.length === 0) {
            pwdNowMissing.innerHTML = '<i class="fa-solid fa-circle-check"></i> {{ _("Kaikki vaatimukset täytetty!") }}';
            pwdNowMissing.classList.add("valid");
            pwdNowMissing.classList.remove("invalid");
            return true;
        } else {
            pwdNowMissing.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> ' + missing.join(", ");
            pwdNowMissing.classList.add("invalid");
            pwdNowMissing.classList.remove("valid");
            return false;
        }
    }

    function checkMatch() {
        if (confirmInput.value === "") {
            matchMessage.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> {{ _("Salasanat eivät täsmää") }}';
            matchMessage.classList.remove("valid");
            return false;
        }
        
        if (passwordInput.value === confirmInput.value) {
            matchMessage.innerHTML = '<i class="fa-solid fa-circle-check"></i> {{ _("Salasanat täsmäävät") }}';
            matchMessage.classList.add("valid");
            return true;
        } else {
            matchMessage.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> {{ _("Salasanat eivät täsmää") }}';
            matchMessage.classList.remove("valid");
            return false;
        }
    }

    function generatePassword(length = 16) {
        const lowercase = "abcdefghijklmnopqrstuvwxyz";
        const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const numbers = "0123456789";
        const specials = "!@#$%^&*()-_=+[]{};:,.<>?";
        
        // Ensure at least one of each required type
        let pwd = "";
        pwd += lowercase.charAt(Math.floor(Math.random() * lowercase.length));
        pwd += uppercase.charAt(Math.floor(Math.random() * uppercase.length));
        pwd += numbers.charAt(Math.floor(Math.random() * numbers.length));
        pwd += specials.charAt(Math.floor(Math.random() * specials.length));
        
        // Fill the rest randomly
        const allChars = lowercase + uppercase + numbers + specials;
        for (let i = pwd.length; i < length; i++) {
            pwd += allChars.charAt(Math.floor(Math.random() * allChars.length));
        }
        
        // Shuffle the password
        return pwd.split('').sort(() => Math.random() - 0.5).join('');
    }

    generateBtn.addEventListener("click", () => {
        const pwd = generatePassword();
        passwordInput.value = pwd;
        confirmInput.value = pwd;
        updateStrength();
        updateRequirements();
        checkMatch();
        
        // Show success message
        showSuccess('{{ _("Vahva salasana luotu! Muista tallentaa se turvalliseen paikkaan.") }}');
        
        // Add animation to inputs
        passwordInput.parentElement.style.animation = 'pulse 1s';
        confirmInput.parentElement.style.animation = 'pulse 1s';
        setTimeout(() => {
            passwordInput.parentElement.style.animation = '';
            confirmInput.parentElement.style.animation = '';
        }, 1000);
    });

    // Event listeners
    passwordInput.addEventListener("input", () => {
        hideMessage();
        updateStrength();
        updateRequirements();
        checkMatch();
    });

    confirmInput.addEventListener("input", () => {
        hideMessage();
        checkMatch();
    });

    // Form submission
    document.getElementById("password-reset-form").addEventListener("submit", (e) => {
        const requirementsMet = updateRequirements();
        const passwordsMatch = checkMatch();
        
        if (!requirementsMet || !passwordsMatch) {
            e.preventDefault();
            showError('{{ _("Salasanavaatimukset eivät täyty tai salasanat eivät täsmää!") }}');
            
            // Shake animation
            document.querySelector('.auth-container').style.animation = 'shake 0.5s';
            setTimeout(() => {
                document.querySelector('.auth-container').style.animation = '';
            }, 500);
        } else {
            // Add loading state
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
        }
    });

    // Focus on first input
    passwordInput.focus();
    
    // Initialize validation display
    updateRequirements();
    checkMatch();
});
</script>
{% endblock %}