{% extends 'base.html' %}
{% block styles %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/auth.css') }}">
{% endblock %}

{% block content %}
<div class="auth-wrapper">
  <!-- Login Form -->
  <div class="auth-container" id="login-cont">
    <div class="auth-header">
      <div class="auth-icon">
        <i class="fa-solid fa-right-to-bracket"></i>
      </div>
      <h1>{{ _('Tervetuloa takaisin') }}</h1>
      <p class="auth-subtitle">{{ _('Kirjaudu sisään jatkaaksesi') }}</p>
    </div>

    <div id="error-message" class="hidden"></div>

    <form method="POST" id="login-form">
      <div class="form-group">
        <label class="form-label" for="username">
          <i class="fa-solid fa-user"></i>
          {{ _('Käyttäjänimi') }}
        </label>
        <div class="form-input-wrapper">
          <i class="fa-solid fa-user form-input-icon"></i>
          <input type="text" 
                 id="username" 
                 name="username" 
                 class="form-input" 
                 placeholder="{{ _('Syötä käyttäjänimesi') }}"
                 required 
                 autocomplete="username">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="password">
          <i class="fa-solid fa-lock"></i>
          {{ _('Salasana') }}
        </label>
        <div class="form-input-wrapper">
          <i class="fa-solid fa-lock form-input-icon"></i>
          <input type="password" 
                 id="password" 
                 name="password" 
                 class="form-input" 
                 placeholder="{{ _('Syötä salasanasi') }}"
                 required 
                 autocomplete="current-password">
          <button type="button" 
                  class="password-toggle" 
                  onclick="togglePassword('password')"
                  aria-label="{{ _('Näytä/piilota salasana') }}">
            <i class="fa-solid fa-eye" id="password-toggle-icon"></i>
          </button>
        </div>
      </div>

      <div class="auth-links">
        <label class="remember-me">
          <input type="checkbox" name="remember">
          <span>{{ _('Muista minut') }}</span>
        </label>
        <a href="{{ url_for('users.auth.password_reset_request') }}" class="auth-link">
          {{ _('Unohtuiko salasana?') }}
        </a>
      </div>

      <button type="submit" class="btn btn-primary" id="login-btn">
        <i class="fa-solid fa-right-to-bracket"></i>
        {{ _('Kirjaudu sisään') }}
      </button>
    </form>

    <div class="auth-divider">
      <span>{{ _('tai') }}</span>
    </div>

    <div class="register-prompt">
      <p>{{ _('Eikö sinulla ole vielä tiliä?') }}</p>
      <a href="{{ url_for('users.auth.register') }}" class="btn btn-secondary">
        <i class="fa-solid fa-user-plus"></i>
        {{ _('Luo uusi tili') }}
      </a>
    </div>
  </div>

  <!-- 2FA Form -->
  <div class="auth-container hidden" id="2fa">
    <div class="auth-header">
      <div class="auth-icon">
        <i class="fa-solid fa-shield-halved"></i>
      </div>
      <h1>{{ _('Kaksivaiheinen tunnistautuminen') }}</h1>
      <p class="auth-subtitle">{{ _('Syötä 6-numeroinen koodi sovelluksestasi') }}</p>
    </div>

    <div id="2fa-error-message" class="hidden"></div>

    <form method="POST" id="2fa-form">
      <div class="form-group">
        <label class="form-label" for="2fa_code">
          <i class="fa-solid fa-key"></i>
          {{ _('Vahvistuskoodi') }}
        </label>
        <div class="form-input-wrapper">
          <i class="fa-solid fa-key form-input-icon"></i>
          <input type="text" 
                 id="2fa_code" 
                 name="2fa_code" 
                 class="form-input" 
                 placeholder="000000"
                 maxlength="6"
                 pattern="[0-9]{6}"
                 autocomplete="one-time-code"
                 required>
        </div>
        <p class="form-hint">
          <i class="fa-solid fa-circle-info"></i>
          {{ _('Avaa todennussovelluksesi ja syötä näkyvä koodi') }}
        </p>
      </div>

      <input id="mfauser" type="hidden" name="username">
      <input id="mfapass" type="hidden" name="password">

      <button type="submit" class="btn btn-primary" id="2fa-btn">
        <i class="fa-solid fa-check-circle"></i>
        {{ _('Vahvista ja kirjaudu') }}
      </button>

      <button type="button" class="btn btn-secondary" onclick="backToLogin()" style="margin-top: 1rem;">
        <i class="fa-solid fa-arrow-left"></i>
        {{ _('Takaisin kirjautumiseen') }}
      </button>
    </form>

    <div class="auth-footer">
      <p class="help-text">
        <i class="fa-solid fa-circle-question"></i>
        {{ _('Etkö saa koodia? Tarkista, että sovelluksesi kello on synkronoitu.') }}
      </p>
    </div>
  </div>
</div>

<script>
// Toggle password visibility
function togglePassword(fieldId) {
  const input = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + '-toggle-icon');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// Show error message
function showError(containerId, message) {
  const errorDiv = document.getElementById(containerId);
  errorDiv.className = 'alert alert-error';
  errorDiv.innerHTML = `
    <i class="fa-solid fa-triangle-exclamation"></i>
    <span>${message}</span>
  `;
  errorDiv.classList.remove('hidden');
  
  // Scroll to error
  errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Show success message
function showSuccess(containerId, message) {
  const errorDiv = document.getElementById(containerId);
  errorDiv.className = 'alert alert-success';
  errorDiv.innerHTML = `
    <i class="fa-solid fa-circle-check"></i>
    <span>${message}</span>
  `;
  errorDiv.classList.remove('hidden');
}

// Hide message
function hideMessage(containerId) {
  const errorDiv = document.getElementById(containerId);
  errorDiv.classList.add('hidden');
}

// Back to login with smooth transition
function backToLogin() {
  const twoFaForm = document.getElementById('2fa');
  const loginForm = document.getElementById('login-cont');
  
  twoFaForm.style.animation = 'fadeOut 0.3s ease-out';
  
  setTimeout(() => {
    twoFaForm.classList.add('hidden');
    twoFaForm.style.animation = '';
    loginForm.classList.remove('hidden');
    document.getElementById('login-form').reset();
    document.getElementById('username').focus();
    hideMessage('error-message');
    hideMessage('2fa-error-message');
  }, 300);
}

// Login form submission
document.getElementById('login-form').addEventListener('submit', function(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  const submitBtn = document.getElementById('login-btn');
  
  // Add loading state
  submitBtn.classList.add('loading');
  submitBtn.disabled = true;
  hideMessage('error-message');
  
  fetch('{{ url_for("users.auth.mfa_check") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.enabled) {
      // Smooth transition to 2FA form
      const loginCont = document.getElementById('login-cont');
      loginCont.style.animation = 'fadeOut 0.3s ease-out';
      
      setTimeout(() => {
        loginCont.classList.add('hidden');
        loginCont.style.animation = '';
        document.getElementById('2fa').classList.remove('hidden');
        document.getElementById('mfauser').value = formData.get('username');
        document.getElementById('mfapass').value = formData.get('password');
        document.getElementById('2fa_code').focus();
        
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
      }, 300);
    } else if (data.valid) {
      // Submit the form normally
      showSuccess('error-message', '{{ _("Kirjautuminen onnistui! Ohjataan...") }}');
      setTimeout(() => {
        form.submit();
      }, 800);
    } else {
      // Show error
      showError('error-message', '{{ _("Virheellinen käyttäjänimi tai salasana") }}');
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
      
      // Shake animation
      form.style.animation = 'shake 0.5s';
      setTimeout(() => {
        form.style.animation = '';
      }, 500);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showError('error-message', '{{ _("Kirjautumisessa tapahtui virhe. Yritä uudelleen.") }}');
    submitBtn.classList.remove('loading');
    submitBtn.disabled = false;
  });
});

// 2FA form submission
document.getElementById('2fa-form').addEventListener('submit', function(event) {
  const submitBtn = document.getElementById('2fa-btn');
  submitBtn.classList.add('loading');
  submitBtn.disabled = true;
  hideMessage('2fa-error-message');
});

// Auto-format 2FA code input
document.getElementById('2fa_code').addEventListener('input', function(e) {
  // Only allow numbers
  this.value = this.value.replace(/[^0-9]/g, '');
  
  // Auto-submit when 6 digits entered
  if (this.value.length === 6) {
    setTimeout(() => {
      document.getElementById('2fa-form').requestSubmit();
    }, 300);
  }
});

// Add pulse effect to 2FA input
document.getElementById('2fa_code').addEventListener('focus', function() {
  this.parentElement.style.animation = 'pulse 2s infinite';
});

document.getElementById('2fa_code').addEventListener('blur', function() {
  this.parentElement.style.animation = '';
});

// Focus on first input on page load
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('username').focus();
});

// Shake animation for errors
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
  }
  
  @keyframes fadeOut {
    to {
      opacity: 0;
      transform: translateY(-10px) scale(0.98);
    }
  }
  
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
    50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}