{% extends 'base.html' %}
{% block styles %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/v2/auth.css') }}">

<style>
/* Password strength meter */
.strength-meter {
  height: 6px;
  width: 100%;
  background: var(--input-bg);
  margin-top: 0.5rem;
  border-radius: 3px;
  overflow: hidden;
  border: 1px solid var(--border-color);
}

.strength-meter-fill {
  height: 100%;
  width: 0;
  transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
  border-radius: 3px;
}

.strength-weak { background: linear-gradient(90deg, #ef4444, #dc2626); }
.strength-medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
.strength-strong { background: linear-gradient(90deg, #10b981, #059669); }

/* Password requirements */
.password-requirements-container {
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 1rem;
  margin-top: 1rem;
}

.password-requirements {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.password-requirements li {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  transition: color 0.2s ease;
  padding: 0.25rem;
}

.password-requirements li::before {
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  font-size: 0.875rem;
}

.password-requirements li.valid {
  color: #10b981;
}

.password-requirements li.valid::before {
  content: "\f058"; /* fa-circle-check */
}

.password-requirements li.invalid {
  color: var(--text-secondary);
}

.password-requirements li.invalid::before {
  content: "\f111"; /* fa-circle */
  opacity: 0.3;
}

/* Password match message */
.password-match {
  font-size: 0.9rem;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--error-color);
  transition: color 0.2s ease;
}

.password-match.valid {
  color: #10b981;
}

.password-match i {
  font-size: 1rem;
}

/* Missing requirements message */
#pwd-now-missing {
  font-size: 0.9rem;
  margin-top: 0.75rem;
  padding: 0.75rem;
  border-radius: 8px;
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  line-height: 1.6;
}

#pwd-now-missing.valid {
  color: #10b981;
  background: rgba(16, 185, 129, 0.1);
  border-color: #10b981;
}

#pwd-now-missing.invalid {
  color: var(--text-secondary);
}

/* Generate password button */
.generate-password-btn {
  width: 100%;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="auth-wrapper">
  <div class="auth-container">
    <div class="auth-header">
      <div class="auth-icon">
        <i class="fa-solid fa-lock-open"></i>
      </div>
      <h1>{{ _('Vaihda salasana') }}</h1>
      <p class="auth-subtitle">{{ _('Luo vahva ja turvallinen uusi salasana tilillesi') }}</p>
    </div>

    <div id="error-message" class="hidden"></div>

    <form method="POST" id="password-reset-form">
      <!-- New Password -->
      <div class="form-group">
        <label class="form-label" for="password">
          <i class="fa-solid fa-lock"></i>
          {{ _('Uusi salasana') }}
        </label>
        <div class="form-input-wrapper">
          <i class="fa-solid fa-lock form-input-icon"></i>
          <input type="password" 
                 id="password" 
                 name="password" 
                 class="form-input" 
                 placeholder="{{ _('Syötä vahva salasana') }}"
                 required 
                 minlength="12"
                 autocomplete="new-password">
          <button type="button" 
                  class="password-toggle" 
                  onclick="togglePassword('password')"
                  aria-label="{{ _('Näytä/piilota salasana') }}">
            <i class="fa-solid fa-eye" id="password-toggle-icon"></i>
          </button>
        </div>
        <div class="strength-meter">
          <div id="strength-fill" class="strength-meter-fill"></div>
        </div>
        <p id="pwd-now-missing"></p>
      </div>

      <!-- Confirm Password -->
      <div class="form-group">
        <label class="form-label" for="password_confirm">
          <i class="fa-solid fa-lock"></i>
          {{ _('Vahvista salasana') }}
        </label>
        <div class="form-input-wrapper">
          <i class="fa-solid fa-lock form-input-icon"></i>
          <input type="password" 
                 id="password_confirm" 
                 name="password_confirm" 
                 class="form-input" 
                 placeholder="{{ _('Syötä salasana uudelleen') }}"
                 required 
                 autocomplete="new-password">
          <button type="button" 
                  class="password-toggle" 
                  onclick="togglePassword('password_confirm')"
                  aria-label="{{ _('Näytä/piilota salasana') }}">
            <i class="fa-solid fa-eye" id="password_confirm-toggle-icon"></i>
          </button>
        </div>
        <div id="password-match-message" class="password-match">
          <i class="fa-solid fa-xmark"></i>
          <span>{{ _('Salasanat eivät täsmää') }}</span>
        </div>
      </div>

      <!-- Password Requirements -->
      <div class="password-requirements-container">
        <ul class="password-requirements">
          <li id="req-length" class="invalid">{{ _('Vähintään 12 merkkiä pitkä') }}</li>
          <li id="req-lower" class="invalid">{{ _('Sisältää vähintään yhden pienen kirjaimen (a-z)') }}</li>
          <li id="req-upper" class="invalid">{{ _('Sisältää vähintään yhden suuren kirjaimen (A-Z)') }}</li>
          <li id="req-special" class="invalid">{{ _('Sisältää vähintään yhden erikoismerkin') }}</li>
        </ul>
      </div>

      <button type="button" class="btn btn-secondary generate-password-btn" id="generate-password">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
        {{ _('Luo vahva salasana') }}
      </button>

      <button type="submit" class="btn btn-primary" id="submit-btn">
        <i class="fa-solid fa-check-circle"></i>
        {{ _('Vaihda salasana') }}
      </button>
    </form>

    <div class="auth-footer">
      <p class="help-text">
        <i class="fa-solid fa-shield-halved"></i>
        {{ _('Käytä vähintään 12 merkin pituista salasanaa, joka sisältää isoja ja pieniä kirjaimia sekä erikoismerkkejä') }}
      </p>
    </div>
  </div>
</div>

<script>
// Toggle password visibility
function togglePassword(fieldId) {
  const input = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + '-toggle-icon');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const passwordInput = document.getElementById("password");
  const confirmInput = document.getElementById("password_confirm");
  const strengthFill = document.getElementById("strength-fill");
  const pwdNowMissing = document.getElementById("pwd-now-missing");
  const matchMessage = document.getElementById("password-match-message");

  const reqLength = document.getElementById("req-length");
  const reqLower = document.getElementById("req-lower");
  const reqUpper = document.getElementById("req-upper");
  const reqSpecial = document.getElementById("req-special");
  const generateBtn = document.getElementById("generate-password");
  const specialRegex = /[!@#$%^&*()\-\_=+\[\]{};:,.<>?]/;

  function updateStrength() {
    const pwd = passwordInput.value;
    let score = 0;
    if (pwd.length >= 12) score++;
    if (/[a-z]/.test(pwd)) score++;
    if (/[A-Z]/.test(pwd)) score++;
    if (specialRegex.test(pwd)) score++;
    
    if (score <= 2) {
      strengthFill.className = "strength-meter-fill strength-weak";
      strengthFill.style.width = "33%";
    } else if (score === 3) {
      strengthFill.className = "strength-meter-fill strength-medium";
      strengthFill.style.width = "66%";
    } else {
      strengthFill.className = "strength-meter-fill strength-strong";
      strengthFill.style.width = "100%";
    }
  }

  function updateRequirements() {
    const pwd = passwordInput.value;
    let missing = [];

    if (pwd.length >= 12) {
      reqLength.className = "valid";
    } else {
      reqLength.className = "invalid";
      missing.push("{{ _('Vähintään 12 merkkiä pitkä') }}");
    }

    if (/[a-z]/.test(pwd)) {
      reqLower.className = "valid";
    } else {
      reqLower.className = "invalid";
      missing.push("{{ _('Vähintään yksi pieni kirjain') }}");
    }

    if (/[A-Z]/.test(pwd)) {
      reqUpper.className = "valid";
    } else {
      reqUpper.className = "invalid";
      missing.push("{{ _('Vähintään yksi iso kirjain') }}");
    }

    if (specialRegex.test(pwd)) {
      reqSpecial.className = "valid";
    } else {
      reqSpecial.className = "invalid";
      missing.push("{{ _('Vähintään yksi erikoismerkki') }}");
    }

    if (missing.length === 0) {
      pwdNowMissing.innerHTML = '<i class="fa-solid fa-circle-check"></i> {{ _("Kaikki vaatimukset täytetty!") }}';
      pwdNowMissing.classList.add("valid");
      pwdNowMissing.classList.remove("invalid");
      return true;
    } else {
      pwdNowMissing.innerHTML = '<i class="fa-solid fa-circle-info"></i> ' + missing.join(", ");
      pwdNowMissing.classList.add("invalid");
      pwdNowMissing.classList.remove("valid");
      return false;
    }
  }

  function checkMatch() {
    const matchIcon = matchMessage.querySelector('i');
    const matchText = matchMessage.querySelector('span');
    
    if (confirmInput.value === "") {
      matchIcon.className = "fa-solid fa-xmark";
      matchText.textContent = "{{ _('Salasanat eivät täsmää') }}";
      matchMessage.classList.remove("valid");
      return false;
    }
    
    if (passwordInput.value === confirmInput.value) {
      matchIcon.className = "fa-solid fa-check";
      matchText.textContent = "{{ _('Salasanat täsmäävät') }}";
      matchMessage.classList.add("valid");
      return true;
    } else {
      matchIcon.className = "fa-solid fa-xmark";
      matchText.textContent = "{{ _('Salasanat eivät täsmää') }}";
      matchMessage.classList.remove("valid");
      return false;
    }
  }

  function generatePassword(length = 16) {
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{};:,.<>?";
    let pwd = "";
    for (let i = 0; i < length; i++) {
      pwd += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return pwd;
  }

  generateBtn.addEventListener("click", () => {
    const pwd = generatePassword();
    passwordInput.value = pwd;
    confirmInput.value = pwd;
    updateStrength();
    updateRequirements();
    checkMatch();
    
    // Show success message
    const btn = generateBtn;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> {{ _("Salasana luotu!") }}';
    btn.classList.add('loading');
    
    setTimeout(() => {
      btn.innerHTML = originalHTML;
      btn.classList.remove('loading');
    }, 2000);
  });

  passwordInput.addEventListener("input", () => {
    updateStrength();
    updateRequirements();
    checkMatch();
  });

  confirmInput.addEventListener("input", checkMatch);

  document.getElementById("password-reset-form").addEventListener("submit", (e) => {
    const requirementsMet = updateRequirements();
    const passwordsMatch = checkMatch();
    
    if (!requirementsMet || !passwordsMatch) {
      e.preventDefault();
      
      // Show error message
      const errorDiv = document.getElementById('error-message');
      errorDiv.className = 'alert alert-error';
      errorDiv.innerHTML = `
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>{{ _('Salasanavaatimukset eivät täyty tai salasanat eivät täsmää!') }}</span>
      `;
      errorDiv.classList.remove('hidden');
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // Shake animation
      const form = document.getElementById('password-reset-form');
      form.style.animation = 'shake 0.5s';
      setTimeout(() => {
        form.style.animation = '';
      }, 500);
    } else {
      // Add loading state
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
    }
  });

  // Focus on password input
  passwordInput.focus();
});

// Shake animation
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}