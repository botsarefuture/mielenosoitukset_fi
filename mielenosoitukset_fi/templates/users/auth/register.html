{% extends "base.html" %}

{% block title %}Rekisteröidy{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .password-requirements-container { border: 1px solid #ccc; padding: 12px; margin-top: 12px; border-radius: 8px; background: #f9f9f9; }
    .password-requirements { font-size: 0.9em; color: #666; margin: 0; }
    .password-requirements ul { margin: 0; padding-left: 20px; }
    .strength-meter { height: 6px; width: 100%; background: #eee; margin-top: 6px; border-radius: 3px; overflow: hidden; }
    .strength-meter-fill { height: 100%; width: 0; transition: width 0.3s ease-in-out; }
    .strength-weak { background: #e74c3c; }
    .strength-medium { background: #f39c12; }
    .strength-strong { background: #27ae60; }
    .password-match { font-size: 0.9em; margin-top: 3px; color: #e74c3c; }
    .password-match.valid { color: #27ae60; }
    .input-icon i { margin-left: -30px; cursor: pointer; }
    .password-requirements li.valid { color: #27ae60; }
    .password-requirements li.invalid { color: #e74c3c; }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <h1>{{ _('Rekisteröidy') }}</h1>
    <form id="register-form" action="{{ url_for('users.auth.register') }}" method="POST">

        <!-- Username -->
        <div class="form-group">
            <label for="username">{{ _('Käyttäjätunnus') }}</label>
            <input type="text" id="username" name="username" required minlength="3" class="form-control">
            <div id="username-status" class="form-feedback"></div>
        </div>

        <!-- Email -->
        <div class="form-group">
            <label for="email">{{ _('Sähköposti') }}</label>
            <input type="email" id="email" name="email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                title="{{ _('Anna kelvollinen sähköpostiosoite') }}" class="form-control">
        </div>

        <!-- Password -->
        <div class="form-group input-icon">
            <label for="password">{{ _('Salasana') }}</label>
            <input type="password" id="password" name="password" required minlength="12">
            <i class="bi bi-eye-slash" id="togglePassword"></i>
            <div class="strength-meter"><div id="strength-fill" class="strength-meter-fill"></div></div>
            <p id="pwd-now-missing"></p>
        </div>

        <!-- Confirm Password -->
        <div class="form-group input-icon">
            <label for="password_confirm">{{ _('Vahvista salasana') }}</label>
            <input type="password" id="password_confirm" name="password_confirm" required>
            <i class="bi bi-eye-slash" id="togglePasswordConfirm"></i>
            <div id="password-match-message" class="password-match">{{ _('Salasanat eivät täsmää') }}</div>
        </div>

        <!-- Password requirements -->
        <div class="password-requirements-container">
            <p class="password-requirements">{{ _('Salasanan on täytettävä seuraavat vaatimukset:') }}</p>
            <ul class="password-requirements">
                <li id="req-length">{{ _('Vähintään 12 merkkiä pitkä') }}</li>
                <li id="req-complex">{{ _('Sisältää vähintään 3 seuraavista: pieni kirjain, iso kirjain, numero, erikoismerkki') }}
                    <br><small>{{ _('Sallitut erikoismerkit:') }} !@#$%^&*()-_=+[]{};:,.<>?</small>
                </li>
                <li id="req-no-username">{{ _('Ei saa sisältää käyttäjätunnusta tai sähköpostia') }}</li>
            </ul>
        </div>

        <button type="button" id="generate-password" class="btn btn-secondary mb-2">{{ _('Luo salasana') }}</button>
        <button type="submit" class="btn btn-primary">{{ _('Rekisteröidy') }}</button>
    </form>

    <div class="form-group">
        <p class="register-link"><a href="{{ url_for('users.auth.login') }}">{{ _('Kirjaudu sisään tästä') }}</a></p>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const usernameInput = document.getElementById("username");
    const emailInput = document.getElementById("email");
    const usernameStatus = document.getElementById("username-status");
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("password_confirm");
    const strengthFill = document.getElementById("strength-fill");
    const matchMessage = document.getElementById("password-match-message");
    const generateBtn = document.getElementById("generate-password");
    const allowedSpecials = "!@#$%^&*()-_=+[]{};:,.<>?";
    const specialRegex = /[!@#$%^&*()\-\_=+\[\]{};:,.<>?]/;

    const reqLength = document.getElementById("req-length");
    const reqComplex = document.getElementById("req-complex");
    const reqNoUsername = document.getElementById("req-no-username");
    const pwdNowMissing = document.getElementById("pwd-now-missing");

    // Toggle password visibility
    function setupToggle(toggleId, input){
        const toggle = document.getElementById(toggleId);
        toggle.addEventListener("click", () => {
            input.type = input.type==="password"?"text":"password";
            toggle.classList.toggle("bi-eye");
            toggle.classList.toggle("bi-eye-slash");
        });
    }
    setupToggle("togglePassword", passwordInput);
    setupToggle("togglePasswordConfirm", confirmInput);

    // Password strength
    function updateStrength(){
        const val = passwordInput.value;
        let score = 0;
        if(val.length>=12) score++;
        if(/[a-z]/.test(val)) score++;
        if(/[A-Z]/.test(val)) score++;
        if(/[0-9]/.test(val)) score++;
        if(specialRegex.test(val)) score++;

        if(score<=2) strengthFill.className="strength-meter-fill strength-weak",strengthFill.style.width="33%";
        else if(score<=4) strengthFill.className="strength-meter-fill strength-medium",strengthFill.style.width="66%";
        else strengthFill.className="strength-meter-fill strength-strong",strengthFill.style.width="100%";
    }

    // Password match
    function checkMatch(){
        if(passwordInput.value && passwordInput.value===confirmInput.value){
            matchMessage.textContent="{{ _('Salasanat täsmäävät') }}";
            matchMessage.classList.add("valid");
        } else {
            matchMessage.textContent="{{ _('Salasanat eivät täsmää') }}";
            matchMessage.classList.remove("valid");
        }
    }

    // Password requirements
    function updateRequirements(){
        const pwd = passwordInput.value;
        const username = usernameInput.value.trim().toLowerCase();
        const email = emailInput.value.trim().toLowerCase();
        let missing=[];

        reqLength.className = pwd.length>=12?"valid":"invalid";
        if(pwd.length<12) missing.push("{{ _('Vähintään 12 merkkiä pitkä') }}");

        let types=0;
        if(/[a-z]/.test(pwd)) types++;
        if(/[A-Z]/.test(pwd)) types++;
        if(/[0-9]/.test(pwd)) types++;
        if(specialRegex.test(pwd)) types++;
        reqComplex.className = types>=3?"valid":"invalid";
        if(types<3) missing.push("{{ _('Vähintään 3 eri merkkityyppiä') }}");

        const lowerPwd=pwd.toLowerCase();
        if (username && email) {
          reqNoUsername.className = (!username || (!lowerPwd.includes(username) && !lowerPwd.includes(email)))?"valid":"invalid";
        if(lowerPwd.includes(username) || lowerPwd.includes(email)) missing.push("{{ _('Ei saa sisältää käyttäjätunnusta tai sähköpostia') }}");
        }

        
        if(missing.length===0){
            pwdNowMissing.textContent="{{ _('Kaikki vaatimukset täytetty!') }} ✅";
            pwdNowMissing.classList.add("valid"); pwdNowMissing.classList.remove("invalid");
        } else {
            pwdNowMissing.innerHTML=missing.map(m=>"• "+m).join("<br>");
            pwdNowMissing.classList.add("invalid"); pwdNowMissing.classList.remove("valid");
        }
    }

    // Random password generator
    function generatePassword(len=16){
        const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{};:,.<>?";
        let pwd=""; for(let i=0;i<len;i++) pwd+=chars.charAt(Math.floor(Math.random()*chars.length));
        return pwd;
    }
    generateBtn.addEventListener("click", ()=>{
        const pwd=generatePassword();
        passwordInput.value=confirmInput.value=pwd;
        updateStrength(); checkMatch(); updateRequirements();
    });

    // Username availability (debounced)
    let usernameTimeout;
    usernameInput.addEventListener("input",()=>{
        clearTimeout(usernameTimeout);
        const uname=usernameInput.value.trim();
        if(!uname){usernameStatus.textContent=""; return;}
        if(uname.length<3){usernameStatus.textContent="{{ _('Käyttäjätunnuksen on oltava vähintään 3 merkkiä pitkä') }} ❌"; usernameStatus.style.color="#e74c3c"; return;}
        usernameStatus.textContent="{{ _('Käyttäjätunnus on tarpeeksi pitkä') }} ✅"; usernameStatus.style.color="#27ae60";
        usernameTimeout=setTimeout(async()=>{
            try{
                const resp=await fetch(`/users/auth/api/username_free?username=${encodeURIComponent(uname)}`);
                const data=await resp.json();
                if(data.available){usernameStatus.textContent="{{ _('Käyttäjätunnus on vapaa') }} ✅"; usernameStatus.style.color="#27ae60";}
                else{usernameStatus.textContent="{{ _('Käyttäjätunnus on jo varattu') }} ❌"; usernameStatus.style.color="#e74c3c";}
            }catch{usernameStatus.textContent="{{ _('Tarkistuksessa tapahtui virhe') }} ⚠️"; usernameStatus.style.color="#f39c12";}
        },500);
        updateRequirements();
    });

    // Event listeners
    passwordInput.addEventListener("input", ()=>{updateStrength(); checkMatch(); updateRequirements();});
    confirmInput.addEventListener("input", checkMatch);
    emailInput.addEventListener("input", updateRequirements);

    // Form submission
    document.getElementById("register-form").addEventListener("submit",e=>{
        if(usernameStatus.textContent.includes("❌")){e.preventDefault(); alert("{{ _('Käyttäjätunnus on jo varattu!') }}");}
        if(passwordInput.value!==confirmInput.value){e.preventDefault(); alert("{{ _('Salasanat eivät täsmää!') }}");}
    });
});
</script>
{% endblock %}
