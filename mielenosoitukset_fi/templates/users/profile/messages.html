<!-- Mini open button -->
<button id="chat-open-btn" style="
  position: fixed; 
  bottom: 20px; 
  right: 20px; 
  z-index:10001; 
  background:#2563eb; 
  color:white; 
  border:none; 
  border-radius:50%; 
  width:50px; 
  height:50px; 
  cursor:pointer;
">ðŸ’¬</button>

<!-- Chat widget -->
<div id="chat-widget" style="position: fixed; bottom: 20px; right: 20px; width: 350px; max-height: 500px; background: white; border-radius: 1em; box-shadow: 0 8px 24px rgba(0,0,0,0.2); overflow: hidden; z-index: 10000; display:none;">
  <div id="chat-header" style="background: #2563eb; color: #fff; padding: 0.5em 1em; cursor: move;">
    <span>Viestit</span>
    <button id="chat-close" style="float:right; background:none; border:none; color:white;">âœ•</button>
  </div>
  <div style="display:flex; height:400px;">
    <div id="friends-list" style="width:120px; border-right:1px solid #ccc; overflow-y:auto;"></div>
    <div style="flex:1; display:flex; flex-direction:column;">
      <div id="chat-messages" style="flex:1; overflow-y:auto; padding:0.5em;"></div>
      <div style="padding:0.5em;">
        <textarea id="chat-input" rows="2" style="width:100%;" placeholder="Kirjoita viesti..."></textarea>
        <button id="chat-send" class="btn btn-primary btn-sm" style="width:100%; margin-top:0.25em;">LÃ¤hetÃ¤</button>
      </div>
    </div>
  </div>
</div>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- Chat widget JS improvements -->
<script>
const chatWidget = document.getElementById("chat-widget");
const chatOpenBtn = document.getElementById("chat-open-btn");
const chatCloseBtn = document.getElementById("chat-close");
const friendsListEl = document.getElementById("friends-list");
const chatMessages = document.getElementById("chat-messages");
const chatInput = document.getElementById("chat-input");
const chatSend = document.getElementById("chat-send");

let cachedFriends = [];
let cachedMessages = {};
let currentFriend = null;
let friend_id_to_name = {};
let friend_pfp_cache = {};

// --- Socket.IO setup ---
const socket = io({ withCredentials: true });

socket.on("connect", () => {
    console.log("Socket.IO connected");
    socket.emit("get_friends");
});

socket.on("friends_list", (data) => updateFriendsList(data.friends));
socket.on("new_message", (data) => handleIncomingMessage(data.message));
socket.on("message_read", (data) => handleMessageRead(data.message_id));
socket.on("chat_history", (data) => {
    if(currentFriend){
        cachedMessages[currentFriend] = data.messages;
        renderMessages();
    }
});

// --- FRIENDS LIST ---
function updateFriendsList(friends){
    friendsListEl.innerHTML = "";
    cachedFriends = friends;
    friends.forEach(f => {
        friend_id_to_name[f._id] = f.displayname;
        if(!friend_pfp_cache[f.username]) friend_pfp_cache[f.username] = f.profile_picture || '/static/default-avatar.png';

        let btn = document.createElement("button");
        btn.dataset.username = f.username;
        btn.className = "btn btn-light btn-sm mb-1 w-100 text-start";
        btn.style.backgroundColor = "light-dark(#000, #333)"; //
        btn.style.color = "light-dark(#fff, #000)"; //
        btn.onclick = () => selectFriend(f.username);

        const unread = cachedMessages[f.username]?.filter(m => !m.read).length || 0;
        btn.innerHTML = `<img src="${friend_pfp_cache[f.username]}" style="width:24px;height:24px;border-radius:50%;margin-right:0.25em;vertical-align:middle;"> ${f.displayname} ${unread>0? `<span class="unread-count" style="color:red">(${unread})</span>` : ""}`;
        friendsListEl.appendChild(btn);
    });
}

// --- SELECT FRIEND ---
function selectFriend(username){
    currentFriend = username;
    renderMessages();

    // mark unread as read
    (cachedMessages[username] || []).filter(m => !m.read).forEach(m => markMessageAsRead(m._id));

    // clear unread badge
    const btnSpan = document.querySelector(`#friends-list button[data-username="${username}"] .unread-count`);
    if(btnSpan) btnSpan.textContent = "";

    socket.emit("load_messages", {friend_username: username});
}

// --- RENDER MESSAGES ---
function renderMessages(){
    chatMessages.innerHTML = "";
    (cachedMessages[currentFriend] || []).forEach(msg => appendMessage(msg));
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- APPEND SINGLE MESSAGE ---
function appendMessage(msg){
    const div = document.createElement("div");
    div.style.marginBottom = "0.5em";
    div.style.wordBreak = "break-word";
    div.style.color = "light-dark(#eee, #111)";

    const sender = msg.sender_id === "{{ current_user._id }}" ? "MinÃ¤" : friend_id_to_name[msg.sender_id] || currentFriend;
    div.innerHTML = `<strong>${sender}</strong>: ${msg.content}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- INCOMING MESSAGE ---
function handleIncomingMessage(msg){
    if(!cachedMessages[msg.sender_username]) cachedMessages[msg.sender_username] = [];
    cachedMessages[msg.sender_username].push(msg);

    if(msg.sender_username !== currentFriend){
        const friendBtn = document.querySelector(`#friends-list button[data-username="${msg.sender_username}"]`);
        if(friendBtn){
            let unreadSpan = friendBtn.querySelector(".unread-count");
            if(!unreadSpan){
                unreadSpan = document.createElement("span");
                unreadSpan.className = "unread-count";
                unreadSpan.style.color = "red";
                friendBtn.appendChild(unreadSpan);
            }
            unreadSpan.textContent = `(${cachedMessages[msg.sender_username].filter(m => !m.read).length})`;
        }
    } else {
        appendMessage(msg);
        markMessageAsRead(msg._id);
    }
}

// --- MARK READ ---
function markMessageAsRead(message_id){
    socket.emit("mark_read", {message_id});
}
function handleMessageRead(msg_id){
    Object.values(cachedMessages).forEach(arr => {
        const m = arr.find(x => x._id === msg_id);
        if(m) m.read = true;
    });
}

// --- SEND MESSAGE ---
chatSend.onclick = () => {
    if(!currentFriend) return alert("Valitse ystÃ¤vÃ¤ ensin.");
    const content = chatInput.value.trim();
    if(!content) return;
    socket.emit("send_message", {recipient: currentFriend, content});
    chatInput.value = "";
};

// --- OPEN/CLOSE ---
chatOpenBtn.onclick = () => { chatWidget.style.display="block"; chatOpenBtn.style.display="none"; };
chatCloseBtn.onclick = () => { chatWidget.style.display="none"; chatOpenBtn.style.display="block"; };
</script>

