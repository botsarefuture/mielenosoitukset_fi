{% extends 'base.html' %}
{% block title %} {{ demo['title'] }} {% endblock %}
{% block meta %}
<!-- General Meta Tags -->
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="{{ demo['description'] if demo['description'] else 'Mielenosoituksen tiedot.' }}" />
<meta name="keywords" content="{{ demo['keywords'] if demo['keywords'] else 'mielenosoitus, tapahtuma, Helsinki' }}" />
<meta name="author" content="Mielenosoitukset.fi" />
<meta name="robots" content="index, follow" />

<!-- Open Graph Meta Tags -->
<meta property="og:title" content="{{ demo['title'] if demo['title'] else 'Mielenosoitus' }}" />
<meta property="og:description"
  content="{{ demo['description'] if demo['description'] else 'Mielenosoituksen tiedot.' }}" />
<meta property="og:image"
  content="{{ demo['img'] if demo['img'] else url_for('static', filename='img/e.png', _external=True) }}" />
<meta property="og:url" content="{{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}" />
<meta property="og:type" content="event" />
<meta property="og:site_name" content="Mielenosoitukset.fi" />
<meta property="og:locale" content="fi_FI" />
<meta property="og:determiner" content="the" />
<meta property="og:updated_time"
  content="{{ demo['updated_time'] if demo['updated_time'] else '2024-01-01T00:00:00' }}" />
<meta property="og:see_also" content="{{ demo['related_links'] if demo['related_links'] else '' }}" />

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="{{ demo['title'] if demo['title'] else 'Mielenosoitus' }}" />
<meta name="twitter:description"
  content="{{ demo['description'] if demo['description'] else 'Mielenosoituksen tiedot.' }}" />
<meta name="twitter:image"
  content="{{ demo['img'] if demo['img'] else url_for('static', filename='img/e.png', _external=True) }}" />
<meta name="twitter:url" content="{{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}" />
<meta name="twitter:site" content="@Mielenosoitukset" />
<meta name="twitter:creator" content="@Mielenosoitukset" />
<meta name="twitter:image:alt"
  content="{{ demo['description'] if demo['description'] else 'Mielenosoituksen kuva' }}" />

<!-- Facebook Open Graph App ID -->
<meta property="fb:app_id" content="{{ demo['fb_app_id'] if demo['fb_app_id'] else '' }}" />

<!-- Additional Social Media Meta Tags -->
<meta property="article:author" content="{{ demo['organizers'][0][" name"] if demo['organizers']
  else 'Tuntematon kirjoittaja' }}" />
<meta property="article:section" content="{{ demo['section'] if demo['section'] else 'Tapahtumat' }}" />
<meta property="article:tag" content="{{ demo['tags'] if demo['tags'] else 'mielenosoitus, tapahtuma' }}" />

<!-- JSON-LD Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Event",
  "name": "{{ demo['title'] if demo['title'] else 'Tuntematon tapahtuma' }}",
  "startDate": "{{ demo['date'] }}T{{ demo['start_time'] if demo['start_time'] else '00:00:00' }}",
  "endDate": "{{ demo['date'] }}T{{ demo['end_time'] if demo['end_time'] else '00:00:00' }}",
  "location": {
    "@type": "Place",
    "name": "{{ demo['topic'] if demo['topic'] else 'Tuntematon paikka' }}",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "{{ demo['address'] if demo['address'] else 'Ei saatavilla' }}",
      "addressLocality": "{{ demo['city'] if demo['city'] else 'Ei saatavilla' }}",
      "addressRegion": "FI",
      "postalCode": "{{ demo['postal_code'] if demo['postal_code'] else 'Ei saatavilla' }}",
      "addressCountry": "FI"
    }
  },
  "description": "{{ demo['description'] if demo['description'] else 'Mielenosoituksen tiedot.' }}",
  "image": "{{ demo['img'] if demo['img'] else url_for('static', filename='img/e.png', _external=True) }}",
  "url": "{{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}",
  "organizer": {
    "@type": "Organization",
    "name": "{{ demo['organizers'][0].name if demo['organizers'] and demo['organizers'][0].name else 'Tuntematon' }}",
    "url": "{{ url_for('org', org_id=demo['organizers'][0].organization_id) if demo['organizers'] and demo['organizers'][0].organization_id else '#' }}"
  },
  "offers": {
    "@type": "Offer",
    "url": "{{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}",
    "price": "{{ demo['price'] if demo['price'] else '0.00' }}",
    "priceCurrency": "{{ demo['currency'] if demo['currency'] else 'EUR' }}"
  }
}
</script>
{% for lang_code, url in alternate_urls.items() %}
<link rel="alternate" hreflang="{{ lang_code }}" href="{{ url }}">
{% endfor %}
{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='/css/toolbox.css' )}}" />
<link rel="stylesheet" href="{{ url_for('static', filename='/css/modal.css' )}}" />
<link rel="stylesheet" href="{{ url_for('static', filename='/css/details.css' )}}" />
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}" />
{% endblock %}

{% block content %}

<div id="main">

  <!-- IMAGE -->
  {% if demo['img'] %}
  {% if demo['img'] !=
  "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBwgHBgkIBwgKCgkLDRYPDQwMDRsUFRAWIB0iIiAdHx8kKDQsJCYxJx8fLT0tMTU3Ojo6Iys/RD84QzQ5OjcBCgoKDQwNGg8PGjclHyU3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3N//AABEIAJQAlAMBIgACEQEDEQH/xAAcAAEBAQADAQEBAAAAAAAAAAAAAQIDBAYHBQj/xAA8EAACAQIDAggMBAcAAAAAAAAAAQIDEQQFBkHRBxIhUVVhkbITFBYXIjE1VHF0kpRCgaHwIyQyM2LC4f/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDxgAAAAAAAAAAAoAgKAIAAAAAAAAAAAAAAAAUFQAFsVICWFjdhYDFiHJYlgMWIbaM2AyCsgAAAAAAAAApCgVFSCRtARI0kVI2kBmwsbSLYDjaFjksSwHE0ZaOVowwOMyzkaMMDIKyAAAAAAFKiFQGkjaRmJvYwP2sBpfPMww0MTg8sr1aE+WE/RSl1q7R2lorUnRFb6obz1euM4zLKMq03HLMZUwqq4SXHVNL0rRp29a632nlFrDUfTGI7I7gL5F6j6JrfVDeXyM1H0TW+qG8eV+oul8R2R3F8rtRdL4jsjuAnkXqPomt9UN5HovUfRNb6obz9bJcZrbPVUlluPxE4U3aVSThGKfNdr1nQzXUOrcrxFXC43MsVRr01yxah+TTtyrrA8/mGBxWX4mWGx2HqUK8Um4TVnZ7TqNH0HhgSWc4BpevC/wCzPAMDiaMM5JGGBghSAAAAAAFRpGUaQG4m/wALMRNbGB9B4TPZelvlJ92kfj6M0zV1Fj+LLjQwVFp16q7q63+i/I9ZqnI8Vn8dKYPCK0fFJurVa9GlHi0uV9fMtvae6yjLMLlGX0sFgqfEpU1t9cntbe1sDw2tdC4elgPHsioOEqEf4tCLcuPFbVe/KubafN0f0cfKuETSniFWeb5dT/lKjvXpxX9qT/Ev8X+j6nyB2+DvVOV5blc8vzGssNOFWU41JJ2mn1rb/wAPNcIed4XPc3dbApuhRo+DVRqzm7t3+HKdrRekKuf1PGcZx6OXwf8AVHklVfNHq53+1rXGiauTUamNy3wlbAcX01LlnR+PPHr7ecDtcMHtjAfKvvM8BI9/wwe2MB8q+8z5+wMMwzbMMDDMmmZAAAAAABpEKgNpm78j+BxpmtgH9IZJ7GwHy1Puo7x4LIeEXI6eUYSljZ1qFelSjTnBUnJXStdNbDv+cfTXvVb7ee4D1xirShWpTpVYxnTnFxlGSumn60zyvnG0371W+3nuL5xdN+9Vvt57gPUUKNPD0oUaMIwpQSjCEVZRS2I1OKnFxkk01Zpq6Z5Tzi6b96rfbz3EfCNpv3qt9vPcB5Thh5M5wHyz7zPn7PTa/wBQ4bUGb06uCjPwFCl4OM5qzm73btsR5ZsCSMMrZlgZIVkAAAAAABSADSNpmCoDkTNJnEmaTA5bjjHGpFuBu5LmbkbArZlsjZGwFzLFyMAQAAAAAAAAAAW5ABq5UZFwN3LcwANNi5kXAtyEuABAAAAAAAAAAAAAAAAAAKCACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/Z"
  %}
  <img src="{{ demo['img'] }}" alt="Event Image" />
  {% endif %}
  {% endif %}

  <!-- NAME OR TITLE -->
  <h1>{{ demo['title'] }}</h1>

  <!-- Social Media Share Buttons -->
  <div class="button-container">
    <a href="https://www.facebook.com/sharer/sharer.php?u={{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}"
      target="_blank" class="facebook-button button">
      {{ _('Jaa Facebookissa') }}
    </a>

    <a href="https://twitter.com/intent/tweet?url={{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}&text={{ demo['title'] }}"
      target="_blank" class="twitter-button button">
      {{ _('Jaa Xssä') }}
    </a>

    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ url_for('demonstration_detail', demo_id=demo['_id'], _external=True) }}&title={{ demo['title'] }}"
      target="_blank" class="linkedin-button button">
      {{ _('Jaa LinkedInissä') }}
    </a>
  </div>

  <!-- LET PEOPLE LIKE THE DEMONSTRATION / OSALLISTUN -->
  <div class="button-container">
    <button class="button like-button" onclick="toggleLike('{{ demo['_id'] }}')">
      <i class="fas fa-thumbs-up"></i> {{ _('Osallistun') }}
    </button>
    <div class="like-count">
      <p>{{ _('Osallistuu:') }}</p>
      <i class="fas fa-thumbs-up"></i>
      <p id="like-count" style="margin: 0; padding: 0;">{{ demo['likes'] }}</p>
    </div>
  </div>
  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    let liked = getCookie(`liked_{{ demo._id }}`) === 'true';

    function toggleLike(demoId) {
      const url = liked ? `/api/demo/${demoId}/unlike` : `/api/demo/${demoId}/like`;
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("like-count").innerText = data.likes;
        liked = !liked;
        document.cookie = `liked_${demoId}=${liked}; path=/`;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }

    function get_likes(demoId) {
      fetch(`/api/demo/${demoId}/likes`)
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("like-count").innerText = data.likes;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      get_likes("{{ demo['_id'] }}");
    });
  </script>

  <!-- add a separator line here -->
  <hr style="margin: 20px 0;">

  <!-- TAGS -->
  <div class="topics">
    <ul>
      {% if demo["tags"] and demo["tags"]|length > 0 %}
      {% for tag in demo["tags"] %}
      <li>
        <a style="margin: 0; padding: 0;" href="{{ url_for('tag_detail', tag_name=tag) }}">
          <span class="tag">#{{ tag }}</span>
        </a>
      </li>
      {% endfor %}
      {% endif %}


    </ul>
  </div>

  

  {% if demo['description'] %}
  <div class="container" style="
      margin-top: 20px;
      padding: 20px;
      background: var(--background);
      border-radius: 8px;
      text-align: center;
      box-shadow: var(--box-shadow);
    ">

    <h2 class="subtitle">{{ _('Mielenosoituksen esittelyteksti') }}</h2>
    {{ demo['description']|safe }} <!-- IN FUTURE: use demo['description'][selected_language] -->
  </div>
  {% endif %}
  <div class="countdown">
    <h2 class="subtitle">{{ _('Aikaa mielenosoituksen alkuun') }}</h2>
    <div id="timer" style="font-size: 24px; color: var(--primary-strong-text-color)"></div>
  </div>
  <br />
  <div class="map">
    <div id="map" style="height: 300px"></div>
  </div>
  <br />

  <div id="subcontainer1">
    <div id="infocontainer">
      <h2 class="subtitle">{{ _('Lisätiedot') }}</h2>
      <div id="demo-details">
        <!-- Demo details will be injected here by JavaScript -->
      </div>
    </div>

    <div id="orginfo">
      <h2 class="subtitle">{{ _('Järjestäjät') }}</h2>
      <div class="organizers-list" id="organizers-list">
        <!-- Organizers will be injected here by JavaScript -->
      </div>
      <p id="no-organizers" style="display: none">
        {{ _('Ei järjestäjätietoja saatavilla.') }}
      </p>
    </div>

    <a class="back-link" href="{{ request.referrer }}">{{ _('Takaisin edelliselle sivulle') }}</a>
    <a class="back-link" href="{{ url_for('demonstrations') }}">{{ _('Takaisin kaikkiin mielenosoituksiin') }}</a>

  </div>
</div>
{% endblock %}

{% block scripts %}

<!-- Leaflet JS and Map Integration -->
<script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
<script>// Data initialization
  const data = {
    demo: {{ demo | tojson }}
  };

  // Map Initialization if location data is available
  if (data.demo.latitude && data.demo.longitude) {
    const map = L.map("map").setView([data.demo.latitude, data.demo.longitude], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    L.marker([data.demo.latitude, data.demo.longitude])
      .addTo(map)
      .bindPopup(data.demo.address)
      .openPopup();
  } else {
    const mapElement = document.getElementById("map");
    if (mapElement) {
      mapElement.remove();
    }
  }

  // Converts Finnish date format (dd.mm.yyyy) to ISO (yyyy-mm-dd)
  function formatFinnishDate(dateString) {
    const [day, month, year] = dateString.split(".").map(Number);
    return `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
  }

  // Updates the countdown to the event
  function updateCountdown() {
    const demoDate = data.demo.date;
    const demoTime = data.demo.start_time;
    const demoEnds = data.demo.end_time;
    const eventDateStr = `${formatFinnishDate(demoDate)}T${demoTime}`;
    const eventDate = new Date(eventDateStr);
    const now = new Date();
    const timeRemaining = eventDate - now;
    const TimeUntilEnd = new Date(`${formatFinnishDate(demoDate)}T${demoEnds}`) - now;


    const timerElement = document.getElementById("timer");

    if (timeRemaining <= 0 && TimeUntilEnd >= 0) { // Event is ongoing
      timerElement.innerText = "{{ _('Mielenosoitus on käynnissä!') }}";
      return;
    }

    if (TimeUntilEnd <= 0) {
      timerElement.innerText = "{{ _('Mielenosoitus on päättynyt.') }}";
      return;
    }

    const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

    timerElement.innerText = `${days} {{ _('päivää') }} ${hours} {{ _('tuntia') }} ${minutes} {{ _('minuuttia') }} ${seconds} {{ _('sekuntia') }}`;
  }

  setInterval(updateCountdown, 1000);

  // Populates the organizers' information in the HTML
  function populateOrganizers(organizers) {
    const organizersListDiv = document.getElementById("organizers-list");
    const noOrganizersText = document.getElementById("no-organizers");

    if (organizers && organizers.length > 0) {
      organizers.forEach((org) => {
        const organizerDiv = document.createElement("div");
        organizerDiv.classList.add("organizer-info");

        const nameParagraph = document.createElement("p");
        nameParagraph.innerHTML = `<strong>{{ _('Nimi:') }}</strong><br />${org.name}`;
        organizerDiv.appendChild(nameParagraph);

        if (org.organization_id) {
          const profileLink = document.createElement("a");
          profileLink.href = org.url;
          profileLink.classList.add("org-profile-link");
          profileLink.innerText = "{{ _('Mielenosoitukset.fi -profiili') }}";
          organizerDiv.appendChild(profileLink);
        }

        if (org.website) {
          const websiteLink = document.createElement("a");
          websiteLink.href = org.website;
          websiteLink.target = "_blank";
          websiteLink.classList.add("org-website");
          websiteLink.innerText = org.website;
          const websiteParagraph = document.createElement("p");
          websiteParagraph.innerHTML = `<strong>{{ _('Verkkosivut:') }}</strong><br />`;
          websiteParagraph.appendChild(websiteLink);
          organizerDiv.appendChild(websiteParagraph);
        }

        if (org.email) {
          const emailLink = document.createElement("a");
          emailLink.href = `mailto:${org.email}`;
          emailLink.classList.add("org-email");
          emailLink.innerText = org.email;
          const emailParagraph = document.createElement("p");
          emailParagraph.innerHTML = `<strong>{{ _('Sähköpostiosoite:') }}</strong><br />`;
          emailParagraph.appendChild(emailLink);
          organizerDiv.appendChild(emailParagraph);
        }

        organizersListDiv.appendChild(organizerDiv);
      });
    } else {
      noOrganizersText.style.display = "block";
    }
  }

  // Populates the demo details in the HTML
  function populateDemoDetails(demo) {
    const demoDetailsDiv = document.getElementById("demo-details");
    let detailsHTML = `
          <p><strong>{{ _('Päivämäärä:') }}</strong><br />${demo.date}</p>
          <p><strong>{{ _('Alkaa klo:') }}</strong><br />${demo.start_time}</p>
          <p><strong>{{ _('Päättyy klo:') }}</strong><br />${demo.end_time}</p>
          <p><strong>{{ _('Alkupaikka:') }}</strong><br />${demo.address}, ${demo.city}</p>
      `;

    if (demo.route && demo.route !== "None") {
      detailsHTML += `
              <div class="route">
                  <p><strong>{{ _('Marssin reitti:') }}</strong></p>
                  <p>${demo.route}</p>
              </div>`;
    }

    if (demo.facebook) {
      detailsHTML += `<a href="${demo.facebook}" target="_blank" class="facebook-button">{{ _('Facebook-tapahtuma') }}</a>`;
    }

    demoDetailsDiv.innerHTML = detailsHTML;
  }

  // Toggle display for toolbox buttons
  function toggleToolbox() {
    const toolboxButtons = document.getElementById("toolbox-buttons");
    toolboxButtons.style.display = toolboxButtons.style.display === 'none' ? 'flex' : 'none';
  }

  // Initial population calls
  populateOrganizers(data.demo.organizers);
  populateDemoDetails(data.demo);
</script>
<script>
  let demoId = "{{ demo['_id'] }}";
</script>
<script src="{{ url_for('static', filename='js/admin_demo_info.js') }}"></script>

{% endblock %}