{% extends 'base.html' %} {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/list.css') }}"
/>
<div class="container-main-content">
  <h1>Tulevat mielenosoitukset</h1>

  <!-- Extended search form for filtering demonstrations -->
  <form
    method="GET"
    action="{{ url_for('demonstrations') }}"
    class="search-form"
  >
    <input
      type="text"
      name="search"
      placeholder="Hae mielenosoituksia..."
      aria-label="Hae mielenosoituksia"
      value="{{ request.args.get('search', '') }}"
    />
    {% if current_user.is_authenticated and
    current_user.can_use("BETA_FEATURES") %} {% include
    'paikkakunta-dropdown.html' %} {% endif %}
    <input
      type="text"
      name="city"
      placeholder="Kaupunki"
      aria-label="Kaupunki"
      value="{{ request.args.get('city', '') }}"
    />

    <input
      type="text"
      name="location"
      placeholder="Sijainti"
      aria-label="Sijainti"
      value="{{ request.args.get('location', '') }}"
    />

    <input
      type="text"
      name="date"
      placeholder="Päivämäärä (pp.kk.vvvv)"
      aria-label="Päivämäärä (pp.kk.vvvv)"
      value="{{ request.args.get('date', '') }}"
    />

    <input
      type="text"
      name="topic"
      placeholder="Aihe"
      aria-label="Aihe"
      value="{{ request.args.get('topic', '') }}"
    />

    <button type="submit">Hae</button>
  </form>

  <div class="container-grid">
    {% if demonstrations and demonstrations|length > 0 %} {% for demo in
    demonstrations %}
    <div class="grid-item">
      <a
        href="{{ url_for('demonstration_detail', demo_id=demo['_id']) }}"
        class="grid-link"
      >
        <div class="title">{{ demo['title'] }}</div>
        <div class="details">
          <div class="date-time">
            <span class="date">{{ demo['date'] }}</span> |
            <span class="time"
              >{{ demo['start_time'] }} - {{ demo['end_time'] }}</span
            >
          </div>
          <div class="topics">
            <ul>
              {% if demo["tags"] and demo["tags"]|length > 0 %} {% for tag in
              demo["tags"] %}
              <li>
                <span class="tag">#{{ tag }}</span>
              </li>
              {% endfor %} {% else %}
              <li><span class="tag">#{{ demo['topic'] }}</span></li>
              {% endif %}
            </ul>
          </div>
          <span class="city">
            <i class="fa-solid fa-city"></i> {{ demo['city'] }} </span
          ><br />
          <span class="location">
            <i class="fa-solid fa-location-dot"></i> {{ demo['address'] }}
          </span>
        </div>
      </a>
    </div>
    {% endfor %} {% else %}
    <div class="grid-item no-results">Ei löytynyt mielenosoituksia.</div>
    {% endif %}
  </div>

  <!-- Pagination Controls -->
  <div class="pagination">
    {% if page > 1 %}
    <a
      href="{{ url_for('demonstrations', page=page-1, per_page=per_page, search=request.args.get('search', ''), city=request.args.get('city', ''), location=request.args.get('location', ''), date=request.args.get('date', ''), topic=request.args.get('topic', '')) }}"
      >Edellinen</a
    >
    {% endif %}

    <span>Sivu {{ page }} / {{ total_pages }}</span>

    {% if page < total_pages %}
    <a
      href="{{ url_for('demonstrations', page=page+1, per_page=per_page, search=request.args.get('search', ''), city=request.args.get('city', ''), location=request.args.get('location', ''), date=request.args.get('date', ''), topic=request.args.get('topic', '')) }}"
      >Seuraava</a
    >
    {% endif %}
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const topics = document.getElementsByClassName("topics");

    Array.from(topics).forEach((topic, index) => {
      console.log(`Topic ${index}:`, topic);
      if (topic.childElementCount <= 3) {
        // Your code for each topic when it has 3 or fewer children
      }

      const tagList = topic.querySelector("ul"); // Assuming the <ul> is within each topic
      if (tagList) {
        const tags = tagList.children;
        const maxVisibleTags = 1; // Set maximum visible tags

        if (tags.length > maxVisibleTags) {
          // Hide all tags beyond the maxVisibleTags
          for (let i = maxVisibleTags; i < tags.length; i++) {
            tags[i].style.display = "none";
          }

          // Create a "Show More" button
          const showMoreButton = document.createElement("button");
          showMoreButton.innerText = "Näytä kaikki tagit";
          showMoreButton.classList.add("show-more-button");
          showMoreButton.style.marginTop = "10px"; // Add some space above the button
          showMoreButton.style.backgroundColor = "var(--blue-light)"; // Match button color
          showMoreButton.style.color = "#fff"; // Button text color
          showMoreButton.style.border = "none"; // No border
          showMoreButton.style.padding = "8px 12px"; // Padding for button
          showMoreButton.style.borderRadius = "100px"; // Rounded corners
          showMoreButton.style.cursor = "pointer"; // Pointer cursor for interactivity
          showMoreButton.onclick = "return: false;";

          topic.appendChild(showMoreButton); // Append button after the tag list

          // Show hidden tags when the button is clicked
          showMoreButton.addEventListener("click", () => {
            event.preventDefault(); // Prevent any default action
            for (let i = maxVisibleTags; i < tags.length; i++) {
              tags[i].style.display = "block"; // Show the hidden tags
            }
            showMoreButton.style.display = "none"; // Hide the button after showing
          });
        }
      }
    });

    // Dynamically set items per page based on screen size
    let perPage = 10; // Default value
    if (window.innerWidth < 768) {
      perPage = 5; // Example for mobile screens
    } else if (window.innerWidth < 1200) {
      perPage = 10; // Example for tablet screens
    } else {
      perPage = 20; // Example for desktop screens
    }

    // Update the URL with the per_page parameter
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set("per_page", perPage);
    window.history.replaceState({}, "", currentUrl);
  });
</script>

{% endblock %}
